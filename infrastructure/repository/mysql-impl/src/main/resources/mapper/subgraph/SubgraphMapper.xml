<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.catface996.aiops.repository.mysql.mapper.subgraph.SubgraphMapper">

    <!-- 根据名称查询子图 -->
    <select id="selectByName" resultType="com.catface996.aiops.repository.mysql.po.subgraph.SubgraphPO">
        SELECT id, name, description, tags, metadata, created_by, created_at, updated_at, version
        FROM subgraph
        WHERE name = #{name}
        LIMIT 1
    </select>

    <!-- 查询用户有权限访问的子图列表 -->
    <select id="selectByUserId" resultType="com.catface996.aiops.repository.mysql.po.subgraph.SubgraphPO">
        SELECT DISTINCT s.id, s.name, s.description, s.tags, s.metadata, s.created_by, s.created_at, s.updated_at, s.version
        FROM subgraph s
        INNER JOIN subgraph_permission p ON s.id = p.subgraph_id
        WHERE p.user_id = #{userId}
        ORDER BY s.updated_at DESC
        LIMIT #{offset}, #{limit}
    </select>

    <!-- 统计用户有权限访问的子图数量 -->
    <select id="countByUserId" resultType="long">
        SELECT COUNT(DISTINCT s.id)
        FROM subgraph s
        INNER JOIN subgraph_permission p ON s.id = p.subgraph_id
        WHERE p.user_id = #{userId}
    </select>

    <!-- 按关键词搜索子图（全文搜索 + 权限过滤） -->
    <select id="searchByKeyword" resultType="com.catface996.aiops.repository.mysql.po.subgraph.SubgraphPO">
        SELECT DISTINCT s.id, s.name, s.description, s.tags, s.metadata, s.created_by, s.created_at, s.updated_at, s.version
        FROM subgraph s
        INNER JOIN subgraph_permission p ON s.id = p.subgraph_id
        WHERE p.user_id = #{userId}
        <if test="keyword != null and keyword != ''">
            AND (s.name LIKE CONCAT('%', #{keyword}, '%')
                 OR s.description LIKE CONCAT('%', #{keyword}, '%'))
        </if>
        ORDER BY s.updated_at DESC
        LIMIT #{offset}, #{limit}
    </select>

    <!-- 统计按关键词搜索的子图数量 -->
    <select id="countByKeyword" resultType="long">
        SELECT COUNT(DISTINCT s.id)
        FROM subgraph s
        INNER JOIN subgraph_permission p ON s.id = p.subgraph_id
        WHERE p.user_id = #{userId}
        <if test="keyword != null and keyword != ''">
            AND (s.name LIKE CONCAT('%', #{keyword}, '%')
                 OR s.description LIKE CONCAT('%', #{keyword}, '%'))
        </if>
    </select>

    <!-- 按标签过滤子图 -->
    <select id="filterByTags" resultType="com.catface996.aiops.repository.mysql.po.subgraph.SubgraphPO">
        SELECT DISTINCT s.id, s.name, s.description, s.tags, s.metadata, s.created_by, s.created_at, s.updated_at, s.version
        FROM subgraph s
        INNER JOIN subgraph_permission p ON s.id = p.subgraph_id
        WHERE p.user_id = #{userId}
        <if test="tags != null and tags.size() > 0">
            AND (
            <foreach collection="tags" item="tag" separator=" OR ">
                JSON_CONTAINS(s.tags, JSON_QUOTE(#{tag}))
            </foreach>
            )
        </if>
        ORDER BY s.updated_at DESC
        LIMIT #{offset}, #{limit}
    </select>

    <!-- 统计按标签过滤的子图数量 -->
    <select id="countByTags" resultType="long">
        SELECT COUNT(DISTINCT s.id)
        FROM subgraph s
        INNER JOIN subgraph_permission p ON s.id = p.subgraph_id
        WHERE p.user_id = #{userId}
        <if test="tags != null and tags.size() > 0">
            AND (
            <foreach collection="tags" item="tag" separator=" OR ">
                JSON_CONTAINS(s.tags, JSON_QUOTE(#{tag}))
            </foreach>
            )
        </if>
    </select>

    <!-- 按所有者过滤子图 -->
    <select id="filterByOwner" resultType="com.catface996.aiops.repository.mysql.po.subgraph.SubgraphPO">
        SELECT DISTINCT s.id, s.name, s.description, s.tags, s.metadata, s.created_by, s.created_at, s.updated_at, s.version
        FROM subgraph s
        INNER JOIN subgraph_permission p ON s.id = p.subgraph_id
        INNER JOIN subgraph_permission owner_p ON s.id = owner_p.subgraph_id
        WHERE p.user_id = #{currentUserId}
          AND owner_p.user_id = #{ownerId}
          AND owner_p.role = 'OWNER'
        ORDER BY s.updated_at DESC
        LIMIT #{offset}, #{limit}
    </select>

    <!-- 统计按所有者过滤的子图数量 -->
    <select id="countByOwner" resultType="long">
        SELECT COUNT(DISTINCT s.id)
        FROM subgraph s
        INNER JOIN subgraph_permission p ON s.id = p.subgraph_id
        INNER JOIN subgraph_permission owner_p ON s.id = owner_p.subgraph_id
        WHERE p.user_id = #{currentUserId}
          AND owner_p.user_id = #{ownerId}
          AND owner_p.role = 'OWNER'
    </select>

    <!-- 更新子图（带乐观锁） -->
    <update id="updateWithVersion">
        UPDATE subgraph
        SET name = #{name},
            description = #{description},
            tags = #{tags},
            metadata = #{metadata},
            version = version + 1,
            updated_at = NOW()
        WHERE id = #{id} AND version = #{version}
    </update>

    <!-- 检查名称是否存在（排除指定ID） -->
    <select id="existsByNameExcludeId" resultType="int">
        SELECT COUNT(1)
        FROM subgraph
        WHERE name = #{name}
        <if test="excludeId != null">
            AND id != #{excludeId}
        </if>
        LIMIT 1
    </select>

</mapper>
