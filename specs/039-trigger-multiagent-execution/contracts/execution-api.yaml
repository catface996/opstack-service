openapi: 3.0.3
info:
  title: Execution API
  description: API for triggering multi-agent execution workflows
  version: 1.0.0

servers:
  - url: http://localhost:8081/api/service/v1
    description: Local development server

paths:
  /executions/trigger:
    post:
      tags:
        - Execution
      summary: Trigger multi-agent execution
      description: |
        Triggers a multi-agent collaboration execution for the specified topology.
        Returns a Server-Sent Events (SSE) stream of execution events.

        **Flow:**
        1. Validates topology exists and has Global Supervisor
        2. Queries hierarchical team structure
        3. Creates hierarchy in executor service
        4. Starts execution run
        5. Streams events back to client via SSE
      operationId: triggerExecution
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/TriggerExecutionRequest'
            examples:
              basic:
                summary: Basic execution request
                value:
                  topologyId: 4
                  userMessage: "Analyze the system performance and provide recommendations"
      responses:
        '200':
          description: SSE stream of execution events
          content:
            text/event-stream:
              schema:
                $ref: '#/components/schemas/ExecutionEventDTO'
              examples:
                thinking:
                  summary: Agent thinking event
                  value:
                    type: "thinking"
                    agentName: "Global Monitor"
                    agentRole: "GLOBAL_SUPERVISOR"
                    content: "Analyzing the request..."
                    timestamp: "2025-12-29T10:00:00"
                message:
                  summary: Agent message event
                  value:
                    type: "message"
                    agentName: "System Analyzer"
                    agentRole: "WORKER"
                    content: "CPU usage is at 75%, memory usage at 60%"
                    timestamp: "2025-12-29T10:00:05"
                complete:
                  summary: Execution complete event
                  value:
                    type: "complete"
                    content: "Execution completed successfully"
                    timestamp: "2025-12-29T10:01:00"
        '400':
          description: Bad request - Invalid input or missing configuration
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                missingGlobalSupervisor:
                  summary: Topology has no Global Supervisor
                  value:
                    code: 400001
                    message: "Topology does not have a bound Global Supervisor Agent"
                    success: false
                missingTeams:
                  summary: Topology has no teams
                  value:
                    code: 400002
                    message: "Topology has no teams configured"
                    success: false
        '404':
          description: Topology not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                code: 404001
                message: "Topology not found"
                success: false
        '503':
          description: Executor service unavailable
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                code: 503001
                message: "Executor service is unavailable. Please try again later."
                success: false

components:
  schemas:
    TriggerExecutionRequest:
      type: object
      required:
        - topologyId
        - userMessage
      properties:
        topologyId:
          type: integer
          format: int64
          description: ID of the topology to execute
          example: 4
        userMessage:
          type: string
          description: User's task or message for execution
          maxLength: 10000
          example: "Analyze the system performance and provide recommendations"
        # Gateway-injected fields (hidden in Swagger)
        tenantId:
          type: integer
          format: int64
          description: Tenant ID (gateway-injected)
        traceId:
          type: string
          description: Trace ID (gateway-injected)
        userId:
          type: integer
          format: int64
          description: User ID (gateway-injected)

    ExecutionEventDTO:
      type: object
      required:
        - type
        - timestamp
      properties:
        type:
          type: string
          description: Event type
          enum:
            - thinking
            - message
            - tool_call
            - tool_result
            - error
            - complete
          example: "message"
        agentName:
          type: string
          description: Name of the agent producing the event
          example: "System Analyzer"
        agentRole:
          type: string
          description: Role of the agent
          enum:
            - GLOBAL_SUPERVISOR
            - TEAM_SUPERVISOR
            - WORKER
          example: "WORKER"
        content:
          type: string
          description: Event content or message
          example: "Analyzing CPU metrics..."
        timestamp:
          type: string
          format: date-time
          description: Event timestamp
          example: "2025-12-29T10:00:00"
        metadata:
          type: object
          additionalProperties: true
          description: Additional event metadata
          example:
            toolName: "cpu_monitor"
            duration: 1500

    ErrorResponse:
      type: object
      required:
        - code
        - message
        - success
      properties:
        code:
          type: integer
          description: Error code
          example: 400001
        message:
          type: string
          description: Error message
          example: "Topology does not have a bound Global Supervisor Agent"
        success:
          type: boolean
          description: Always false for errors
          example: false
        data:
          type: object
          nullable: true
          description: Optional error details
