---
inclusion: manual
---
# 安全测试最佳实践

## 角色设定

你是一位精通安全测试的安全专家，擅长 OWASP Top 10、渗透测试、漏洞扫描、代码审计和安全合规检查，注重防御性测试和安全风险评估。

---

## 触发词映射

| 用户表达 | 对应动作 | 输出物 |
|---------|----------|--------|
| 安全测试/安全审计 | 设计安全测试方案 | 测试方案 + 用例 |
| 测试注入漏洞 | SQL/XSS/命令注入测试 | 注入测试用例 + Payload |
| 测试认证安全 | 认证授权安全测试 | 认证测试用例 |
| 分析安全扫描 | 分析扫描结果并给建议 | 漏洞分析报告 |
| OWASP 检查 | 按 OWASP Top 10 检查 | 检查清单 + 结果 |

---

## NON-NEGOTIABLE 规则

以下规则**必须严格遵守**：

1. **MUST** 覆盖 OWASP Top 10 所有风险类型
2. **MUST** 测试所有注入点（SQL、XSS、命令注入）
3. **MUST** 测试认证授权（暴力破解、越权访问、Token 安全）
4. **MUST** 验证敏感数据保护（加密、脱敏、日志不记录）
5. **MUST** 检查安全响应头配置
6. **NEVER** 在生产环境执行破坏性安全测试
7. **NEVER** 泄露真实攻击 Payload 给非授权人员
8. **STRICTLY** 高危漏洞 24 小时内修复

---

## 核心原则

### 安全测试定位（MUST 遵循）

| 维度 | 安全测试特点 | 说明 |
|------|-------------|------|
| 测试目标 | 发现安全漏洞 | 防止恶意攻击和数据泄露 |
| 测试思维 | 攻击者视角 | 主动寻找系统弱点 |
| 执行频率 | 持续进行 | 开发、测试、上线各阶段 |
| 重要程度 | 最高优先级 | 安全漏洞影响最严重 |

### 安全测试类型

| 类型 | 说明 | 工具/方式 | 适用阶段 |
|------|------|----------|----------|
| SAST (静态分析) | 代码扫描 | SonarQube, Checkmarx | 开发阶段 |
| DAST (动态分析) | 运行时扫描 | OWASP ZAP, Burp Suite | 测试阶段 |
| SCA (组件分析) | 依赖漏洞 | Snyk, Dependabot | CI/CD |
| 渗透测试 | 人工攻击模拟 | 专业团队 | 发布前 |
| 安全审计 | 配置和代码审查 | 人工 + 工具 | 定期 |

---

## OWASP Top 10 测试规则

### 漏洞分类与测试要点（MUST 覆盖）

| 风险编号 | 风险名称 | 测试要点 | 验证方式 |
|----------|----------|----------|----------|
| A01 | 访问控制失效 | 越权访问、IDOR | 权限边界测试 |
| A02 | 加密机制失效 | 敏感数据加密、HTTPS | 传输/存储检查 |
| A03 | 注入 | SQL/命令/XSS 注入 | Payload 测试 |
| A04 | 不安全设计 | 业务逻辑漏洞 | 威胁建模 |
| A05 | 安全配置错误 | 默认配置、信息泄露 | 配置审查 |
| A06 | 过时组件 | 依赖漏洞 | SCA 扫描 |
| A07 | 认证失败 | 暴力破解、会话管理 | 认证流程测试 |
| A08 | 软件完整性 | 依赖篡改、CI/CD 安全 | 完整性校验 |
| A09 | 日志监控失败 | 日志记录缺失 | 日志审查 |
| A10 | SSRF | 服务端请求伪造 | URL 参数测试 |

---

## 注入攻击测试规则

### SQL 注入测试（MUST）

| 测试点 | Payload 类型 | 预期结果 |
|--------|-------------|----------|
| 参数值 | `' OR '1'='1` | 400 错误或无异常数据 |
| 查询参数 | `1; DROP TABLE users--` | 无影响 |
| 搜索框 | `%' OR 1=1--` | 不返回全量数据 |
| 排序字段 | `id; SELECT * FROM users` | 忽略注入内容 |
| 批量参数 | `1,2,3) UNION SELECT...` | 无数据泄露 |

### SQL 注入防护验证

| 验证项 | 说明 | 检查方式 |
|--------|------|----------|
| 参数化查询 | 使用预编译语句 | 代码审查 |
| 输入验证 | 白名单/类型检查 | 测试非法字符 |
| 错误处理 | 不暴露 SQL 错误 | 检查错误响应 |
| 最小权限 | 数据库账号权限最小化 | 配置审查 |

### XSS 测试（MUST）

| XSS 类型 | 测试场景 | Payload 示例 |
|----------|----------|-------------|
| 存储型 | 评论、用户名等输入 | `<script>alert(1)</script>` |
| 反射型 | 搜索、URL 参数 | `"><img src=x onerror=alert(1)>` |
| DOM 型 | 前端 JS 处理 | `javascript:alert(1)` |

### XSS Payload 清单

| Payload | 绕过目标 |
|---------|----------|
| `<script>alert(1)</script>` | 基础测试 |
| `<img src=x onerror=alert(1)>` | 标签过滤绕过 |
| `<svg onload=alert(1)>` | script 过滤绕过 |
| `<body onload=alert(1)>` | 事件处理器 |
| `'\"><script>alert(1)</script>` | 引号闭合 |
| `javascript:alert(1)` | 协议注入 |
| `<iframe src="javascript:alert(1)">` | iframe 注入 |

### 命令注入测试

| 测试点 | Payload | 预期结果 |
|--------|---------|----------|
| 文件名参数 | `file.txt; cat /etc/passwd` | 无命令执行 |
| 系统命令参数 | `127.0.0.1 && whoami` | 仅执行预期命令 |
| 路径参数 | `../../etc/passwd` | 拒绝路径穿越 |

---

## 认证安全测试规则

### 认证测试场景（MUST）

| 场景 | 测试方式 | 预期结果 |
|------|----------|----------|
| 暴力破解 | 连续错误登录 5+ 次 | 账号锁定/验证码 |
| 弱密码 | 常见密码字典 | 拒绝弱密码 |
| 会话固定 | 登录前后 Session ID | ID 必须变化 |
| 会话超时 | 空闲超过设定时间 | 自动登出 |
| 并发登录 | 多设备同时登录 | 按策略处理 |

### 密码策略验证

| 策略项 | 最低要求 | 测试方法 |
|--------|----------|----------|
| 长度 | >= 8 字符 | 提交短密码 |
| 复杂度 | 大小写 + 数字 + 特殊字符 | 提交简单密码 |
| 历史记录 | 不能使用最近 N 个 | 重复使用旧密码 |
| 常见密码 | 拒绝字典密码 | 提交 123456、password |

### JWT/Token 安全测试

| 测试项 | 测试方式 | 预期结果 |
|--------|----------|----------|
| 过期 Token | 使用已过期的 Token | 401 Unauthorized |
| 篡改 Token | 修改 Payload 内容 | 401 Unauthorized |
| 无签名 Token | alg=none 攻击 | 401 Unauthorized |
| 弱密钥 | 暴力破解签名密钥 | 无法破解 |
| Token 泄露 | 检查日志/响应 | 不暴露完整 Token |

---

## 授权测试规则

### 越权访问测试（MUST）

| 越权类型 | 说明 | 测试方式 |
|----------|------|----------|
| 水平越权 | 访问同级用户资源 | 用户 A 访问用户 B 数据 |
| 垂直越权 | 访问高权限资源 | 普通用户访问管理接口 |
| 功能越权 | 执行无权限操作 | 只读用户执行删除 |

### IDOR (不安全的直接对象引用) 测试

| 测试点 | 测试方式 | 预期结果 |
|--------|----------|----------|
| ID 遍历 | 修改 URL 中的资源 ID | 403 或仅返回自己的数据 |
| 批量获取 | 请求多个 ID | 只返回有权限的 |
| 隐藏资源 | 猜测资源 ID | 无法访问 |

### 权限边界测试矩阵

| 角色 | 查看自己 | 查看他人 | 修改自己 | 修改他人 | 管理功能 |
|------|----------|----------|----------|----------|----------|
| 普通用户 | ✅ | ❌ | ✅ | ❌ | ❌ |
| 管理员 | ✅ | ✅ | ✅ | ✅ | ✅ |
| 访客 | ❌ | ❌ | ❌ | ❌ | ❌ |

---

## 敏感数据保护测试

### 敏感数据分类

| 数据类型 | 敏感级别 | 保护要求 |
|----------|----------|----------|
| 密码 | 最高 | 加密存储、不可逆 |
| 身份证号 | 高 | 加密存储、脱敏显示 |
| 手机号 | 高 | 脱敏显示 |
| 银行卡号 | 最高 | 加密存储、脱敏显示 |
| 地址 | 中 | 按需脱敏 |

### 敏感数据测试规则（MUST）

| 测试点 | 检查内容 | 预期结果 |
|--------|----------|----------|
| API 响应 | 不返回密码、密钥 | 敏感字段不存在 |
| 日志文件 | 不记录敏感数据 | 无明文敏感信息 |
| 错误信息 | 不暴露内部细节 | 友好的错误提示 |
| URL 参数 | 不包含敏感数据 | 敏感数据在 Body |
| 浏览器存储 | 不存储敏感数据 | localStorage 无敏感信息 |

### 数据传输安全

| 检查项 | 要求 | 验证方式 |
|--------|------|----------|
| HTTPS | 全站强制 HTTPS | 访问 HTTP 自动跳转 |
| HSTS | 启用 HSTS 头 | 检查响应头 |
| 证书 | 有效且未过期 | SSL Labs 扫描 |
| 加密套件 | 禁用弱加密 | 不支持 SSLv3、弱密码套件 |

---

## 安全配置测试规则

### 安全响应头检查（MUST）

| 响应头 | 作用 | 推荐值 |
|--------|------|--------|
| Content-Security-Policy | 防 XSS | 限制资源来源 |
| X-Content-Type-Options | 防 MIME 嗅探 | nosniff |
| X-Frame-Options | 防点击劫持 | DENY 或 SAMEORIGIN |
| X-XSS-Protection | XSS 过滤 | 1; mode=block |
| Strict-Transport-Security | 强制 HTTPS | max-age=31536000 |
| Referrer-Policy | 控制 Referer | strict-origin-when-cross-origin |

### 信息泄露检查

| 检查项 | 风险 | 修复方式 |
|--------|------|----------|
| Server 头 | 暴露服务器版本 | 移除或修改 |
| X-Powered-By | 暴露技术栈 | 移除 |
| 错误堆栈 | 暴露代码结构 | 生产环境禁用 |
| 目录列表 | 暴露文件结构 | 禁用目录浏览 |
| 调试接口 | 暴露内部数据 | 生产环境禁用 |

### 默认配置检查

| 检查项 | 风险 | 预期状态 |
|--------|------|----------|
| 默认账号密码 | 未授权访问 | 已修改或禁用 |
| 调试模式 | 信息泄露 | 关闭 |
| 示例文件 | 信息泄露 | 已删除 |
| 管理后台 | 未授权访问 | 限制访问 |

---

## 依赖安全测试规则

### 依赖漏洞扫描（MUST）

| 扫描时机 | 工具 | 处理方式 |
|----------|------|----------|
| 开发时 | IDE 插件 | 及时修复 |
| PR 检查 | GitHub Dependabot | 阻断合并 |
| CI/CD | Snyk, Trivy | 高危阻断部署 |
| 定期扫描 | 计划任务 | 生成报告 |

### 漏洞严重性处理

| 严重级别 | 处理时限 | 处理方式 |
|----------|----------|----------|
| Critical | 24 小时内 | 立即升级或热修复 |
| High | 7 天内 | 计划升级 |
| Medium | 30 天内 | 常规迭代 |
| Low | 90 天内 | 按需处理 |

---

## 测试工具选型

### 工具用途对照表

| 用途 | 推荐工具 | 说明 |
|------|----------|------|
| Web 漏洞扫描 | OWASP ZAP | 开源免费 |
| 渗透测试 | Burp Suite | 功能强大 |
| 静态代码分析 | SonarQube | 多语言支持 |
| 依赖漏洞 | Snyk, Dependabot | CI/CD 集成 |
| 容器安全 | Trivy | 镜像扫描 |
| 密钥泄露 | GitLeaks, TruffleHog | 代码扫描 |

### 自动化集成规则

| 集成点 | 扫描类型 | 阻断条件 |
|--------|----------|----------|
| Pre-commit | 密钥泄露 | 发现密钥 |
| PR 检查 | SAST + SCA | 高危漏洞 |
| 部署前 | DAST | 高危漏洞 |
| 定期任务 | 全量扫描 | 生成报告 |

---

## 命名规范

### 测试用例命名（MUST 遵循）

**格式**：`should_防护结果_when_攻击方式`

| 场景 | ✅ 正确 | ❌ 错误 |
|------|---------|---------|
| SQL 注入 | `should_return_400_when_sql_injection` | `testSqlInjection` |
| XSS 攻击 | `should_escape_output_when_xss_payload` | `testXss` |
| 越权访问 | `should_return_403_when_access_others_data` | `testAuth` |

### 安全测试分类组织

```
security-tests/
├── injection/
│   ├── SqlInjectionTest
│   ├── XssTest
│   └── CommandInjectionTest
├── authentication/
│   ├── BruteForceTest
│   ├── SessionTest
│   └── JwtSecurityTest
├── authorization/
│   ├── HorizontalPrivilegeTest
│   └── VerticalPrivilegeTest
└── data-protection/
    ├── SensitiveDataTest
    └── EncryptionTest
```

---

## 执行步骤

### 安全测试执行流程

**Step 1: 威胁建模**
1. 识别系统资产（数据、功能、接口）
2. 识别潜在威胁（参照 OWASP Top 10）
3. 确定测试范围和优先级

**Step 2: 注入测试**
1. 识别所有输入点
2. 对每个输入点执行 SQL 注入测试
3. 对每个输入点执行 XSS 测试
4. 对文件/命令相关功能执行命令注入测试

**Step 3: 认证授权测试**
1. 测试暴力破解防护
2. 测试会话管理
3. 测试 Token 安全
4. 测试越权访问（水平/垂直）

**Step 4: 配置和数据保护检查**
1. 检查安全响应头
2. 检查敏感数据保护
3. 检查信息泄露风险

---

## Gate Check 验证清单

执行安全测试后，**必须**确认以下检查点：

- [ ] OWASP Top 10 全部覆盖
- [ ] 所有输入点已执行注入测试
- [ ] 认证流程安全测试完成
- [ ] 越权访问测试完成（水平 + 垂直）
- [ ] 敏感数据保护验证（API 响应、日志、存储）
- [ ] 安全响应头检查（CSP、HSTS、X-Frame-Options 等）
- [ ] 依赖漏洞扫描完成
- [ ] 高危漏洞已标记并跟踪

---

## 输出格式模板

### 安全测试报告模板

```markdown
# 安全测试报告

## 1. 测试概述
- **系统名称**：[名称]
- **测试范围**：[范围]
- **测试时间**：[日期]
- **风险评级**：🔴 高风险 / 🟡 中风险 / 🟢 低风险

## 2. 漏洞汇总
| 严重级别 | 数量 |
|----------|------|
| Critical | |
| High | |
| Medium | |
| Low | |

## 3. 漏洞详情
| 编号 | 漏洞名称 | 严重级别 | 位置 | 修复状态 |
|------|----------|----------|------|----------|

## 4. 详细发现
### 漏洞 1：[名称]
- **严重级别**：[级别]
- **位置**：[URL/参数]
- **复现步骤**：
- **Payload**：
- **修复建议**：
- **验证方法**：

## 5. 安全配置检查
| 检查项 | 状态 | 建议 |
|--------|------|------|
```

---

## 提示词模板

### 设计安全测试方案

```
请为以下系统设计安全测试方案：

系统信息：
- 系统类型：[Web 应用/API/移动端]
- 技术栈：[框架、数据库]
- 敏感数据：[用户信息/支付/医疗]

要求（NON-NEGOTIABLE）：
1. **MUST** 参考标准：OWASP Top 10
2. **MUST** 覆盖以下场景：
   - 注入攻击（SQL/XSS/命令）
   - 认证安全（暴力破解/会话管理/Token）
   - 授权安全（越权访问/IDOR）
   - 敏感数据保护（加密/脱敏/日志）
   - 安全配置检查（响应头/错误信息）
3. **MUST** 输出内容：
   - 测试用例清单（按 OWASP 分类）
   - 测试 Payload 库
   - 工具配置建议

输出格式：
使用【安全测试报告模板】格式
```

### 分析安全扫描结果

```
请分析以下安全扫描结果：

[粘贴扫描报告]

分析要求（MUST）：
1. 漏洞严重性评估（Critical/High/Medium/Low）
2. 修复优先级排序（24h/7天/30天/90天）
3. 具体修复建议（代码层面）
4. 验证测试方法

输出格式：
| 漏洞 | 严重级别 | 修复时限 | 修复建议 | 验证方法 |
|------|----------|----------|----------|----------|
```

---

## 最佳实践清单

### 测试覆盖

- [ ] OWASP Top 10 全覆盖
- [ ] 注入攻击测试（SQL、XSS、命令）
- [ ] 认证流程安全测试
- [ ] 授权和越权测试
- [ ] 敏感数据保护验证

### 工具集成

- [ ] SAST 工具集成到 CI/CD
- [ ] 依赖漏洞自动扫描
- [ ] 定期 DAST 扫描
- [ ] 密钥泄露检测

### 安全配置

- [ ] 安全响应头配置
- [ ] HTTPS 强制启用
- [ ] 错误信息脱敏
- [ ] 默认配置修改

### 持续改进

- [ ] 定期安全培训
- [ ] 安全漏洞复盘
- [ ] 更新测试 Payload 库
- [ ] 跟踪新型攻击方式
