<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.catface996.aiops.repository.mysql.mapper.subgraph.SubgraphResourceMapper">

    <!-- 批量插入资源关联 -->
    <insert id="batchInsert" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO subgraph_resource (subgraph_id, resource_id, added_at, added_by)
        VALUES
        <foreach collection="list" item="item" separator=",">
            (#{item.subgraphId}, #{item.resourceId}, #{item.addedAt}, #{item.addedBy})
        </foreach>
    </insert>

    <!-- 根据子图ID查询所有资源关联 -->
    <select id="selectBySubgraphId" resultType="com.catface996.aiops.repository.mysql.po.subgraph.SubgraphResourcePO">
        SELECT id, subgraph_id, resource_id, added_at, added_by
        FROM subgraph_resource
        WHERE subgraph_id = #{subgraphId}
        ORDER BY added_at ASC
    </select>

    <!-- 查询子图中的所有资源节点ID -->
    <select id="selectResourceIdsBySubgraphId" resultType="java.lang.Long">
        SELECT resource_id
        FROM subgraph_resource
        WHERE subgraph_id = #{subgraphId}
        ORDER BY added_at ASC
    </select>

    <!-- 统计子图中的资源节点数量 -->
    <select id="countBySubgraphId" resultType="int">
        SELECT COUNT(*)
        FROM subgraph_resource
        WHERE subgraph_id = #{subgraphId}
    </select>

    <!-- 查询包含指定资源节点的所有子图ID -->
    <select id="selectSubgraphIdsByResourceId" resultType="java.lang.Long">
        SELECT subgraph_id
        FROM subgraph_resource
        WHERE resource_id = #{resourceId}
    </select>

    <!-- 检查资源节点是否已在子图中 -->
    <select id="existsInSubgraph" resultType="int">
        SELECT COUNT(1)
        FROM subgraph_resource
        WHERE subgraph_id = #{subgraphId} AND resource_id = #{resourceId}
        LIMIT 1
    </select>

    <!-- 移除单个资源关联 -->
    <delete id="deleteBySubgraphIdAndResourceId">
        DELETE FROM subgraph_resource
        WHERE subgraph_id = #{subgraphId} AND resource_id = #{resourceId}
    </delete>

    <!-- 批量移除资源关联 -->
    <delete id="batchDeleteBySubgraphIdAndResourceIds">
        DELETE FROM subgraph_resource
        WHERE subgraph_id = #{subgraphId}
        AND resource_id IN
        <foreach collection="resourceIds" item="resourceId" open="(" separator="," close=")">
            #{resourceId}
        </foreach>
    </delete>

    <!-- 删除子图的所有资源关联 -->
    <delete id="deleteAllBySubgraphId">
        DELETE FROM subgraph_resource
        WHERE subgraph_id = #{subgraphId}
    </delete>

    <!-- 删除资源节点在所有子图中的关联 -->
    <delete id="deleteAllByResourceId">
        DELETE FROM subgraph_resource
        WHERE resource_id = #{resourceId}
    </delete>

</mapper>
