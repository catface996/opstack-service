# F30: 子图管理

## 基本信息

- **Feature ID**: F30
- **Feature 名称**: 子图管理
- **优先级**: P1（重要功能）
- **状态**: 待开发
- **负责人**: 待分配
- **预计工作量**: 待评估

## 用户故事

作为运维工程师，我希望能够创建和管理子图，将相关的资源节点组织在一起，以便更好地管理和查看特定业务域或系统模块的拓扑结构。

## 功能价值

- 支持按业务域或系统模块组织资源节点
- 提供子图级别的拓扑可视化
- 便于团队协作和权限管理
- 简化复杂系统的拓扑管理

## 核心功能

### 1. 创建子图
- 填写子图基本信息（名称、描述、标签）
- 设置子图所有者（Owner）
- 设置子图管理者（Manager）
- 配置子图元数据（业务域、环境、团队）

### 2. 查看子图列表
- 展示所有子图的列表视图
- 支持按名称搜索
- 支持按标签过滤
- 支持按所有者过滤
- 支持排序（按创建时间、更新时间、名称）

### 3. 编辑子图信息
- 更新基本信息（名称、描述、标签）
- 修改子图元数据
- 更新所有者和管理者列表
- 仅所有者可以编辑

### 4. 删除子图
- 验证用户权限（只有 Owner 可以删除）
- 提示用户确认删除
- 删除子图时移除所有资源节点关联
- 执行删除操作并记录审计日志

### 5. 子图资源节点管理
- 添加资源节点到子图（无需考虑节点所属 Owner）
- 从子图中移除资源节点
- 查看子图中的资源节点列表
- 仅管理者和所有者可以添加/移除节点

### 6. 查看子图详情
- 展示子图的完整信息
- 显示基础信息（名称、描述、标签、创建时间等）
- 显示资源节点列表（表格形式）
- 显示子图拓扑图（可视化形式）
- 显示权限信息（Owner 和 Manager 列表）

## 验收标准

### AC1: 创建子图
**WHEN** 用户点击"创建子图"按钮 **THEN** THE System **SHALL** 显示子图创建表单

**WHEN** 用户填写必填信息并提交 **THEN** THE System **SHALL** 创建子图并跳转到子图详情页

**WHEN** 用户创建子图 **THEN** THE System **SHALL** 自动将创建者设置为该子图的第一个 Owner

### AC2: 查看子图列表
**WHEN** 用户访问子图管理页面 **THEN** THE System **SHALL** 显示用户有权限查看的所有子图

**WHEN** 用户在搜索框输入关键词 **THEN** THE System **SHALL** 实时过滤并显示匹配的子图

**WHEN** 用户选择标签过滤器 **THEN** THE System **SHALL** 只显示包含该标签的子图

### AC3: 编辑子图
**WHEN** 用户是子图的 Owner **THEN** THE System **SHALL** 允许用户编辑子图信息

**WHEN** 用户不是子图的 Owner **THEN** THE System **SHALL** 禁止用户编辑子图信息

**WHEN** 用户保存编辑 **THEN** THE System **SHALL** 更新子图信息并记录审计日志

### AC4: 删除子图
**WHEN** 用户不是子图的 Owner **THEN** THE System **SHALL** 禁止用户删除子图

**WHEN** 用户是子图的 Owner 并确认删除 **THEN** THE System **SHALL** 删除子图、移除所有资源节点关联并记录审计日志

### AC5: 添加资源节点到子图
**WHEN** 用户是子图的 Owner 或 Manager **THEN** THE System **SHALL** 允许用户添加资源节点到子图

**WHEN** 用户不是子图的 Owner 或 Manager **THEN** THE System **SHALL** 禁止用户添加资源节点

**WHEN** 用户添加资源节点 **THEN** THE System **SHALL** 无需验证节点的 Owner 权限

**WHEN** 用户添加已存在的资源节点 **THEN** THE System **SHALL** 提示节点已在子图中

### AC6: 从子图移除资源节点
**WHEN** 用户是子图的 Owner 或 Manager **THEN** THE System **SHALL** 允许用户从子图移除资源节点

**WHEN** 用户不是子图的 Owner 或 Manager **THEN** THE System **SHALL** 禁止用户移除资源节点

**WHEN** 用户移除资源节点 **THEN** THE System **SHALL** 只移除子图关联，不删除资源节点本身

### AC7: 查看子图详情
**WHEN** 用户访问子图详情页 **THEN** THE System **SHALL** 显示以下内容：
- 基础信息区域（名称、描述、标签、创建时间、更新时间、Owner、Manager）
- 资源节点列表（表格形式，包含节点名称、类型、状态、操作按钮）
- 子图拓扑图（可视化形式，展示节点和节点间的关系）

**WHEN** 用户在资源节点列表中点击节点 **THEN** THE System **SHALL** 跳转到该资源节点的详情页

**WHEN** 用户在拓扑图中点击节点 **THEN** THE System **SHALL** 高亮显示该节点并显示节点信息

## 依赖关系

### 前置依赖
- F01: 用户登录和身份认证
- F02: 管理资源的访问权限
- F03: 创建和管理 IT 资源
- F04: 建立资源间的拓扑关系
- F05: 可视化查看拓扑图

### 后置依赖
- 无

## 技术考虑

### 数据模型
- 子图基础表（存储子图基本信息）
  - id, name, description, tags, created_at, updated_at, created_by
- 子图权限表（存储 Owner 和 Manager）
  - subgraph_id, user_id, role (OWNER/MANAGER)
- 子图资源关联表（存储子图和资源节点的关系）
  - subgraph_id, resource_id, added_at, added_by

### 权限模型
- **Owner（所有者）**：
  - 可以编辑子图信息
  - 可以删除子图
  - 可以添加/移除资源节点
  - 可以管理 Owner 和 Manager 列表
- **Manager（管理者）**：
  - 可以添加/移除资源节点
  - 不能编辑子图信息
  - 不能删除子图
- **Viewer（查看者）**：
  - 可以查看子图详情
  - 不能进行任何修改操作

### 性能要求
- 子图列表查询响应时间 < 1 秒
- 子图详情页加载时间 < 2 秒
- 支持至少 1000 个子图的管理
- 每个子图支持至少 500 个资源节点

### 安全要求
- 所有操作需要权限验证
- 删除操作需要记录审计日志
- 添加/移除节点操作需要记录审计日志

## 界面设计要点

### 子图列表页面
- 左侧：标签过滤器、所有者过滤器
- 中间：子图列表（卡片视图，显示名称、描述、节点数量、Owner）
- 右上角：搜索框、创建按钮

### 子图创建/编辑页面
- 基本信息：名称、描述、标签
- 权限设置：Owner 列表、Manager 列表
- 元数据：业务域、环境、团队
- 操作按钮：保存、取消

### 子图详情页面
- **顶部**：子图名称、操作按钮（编辑、删除、添加节点）
- **Tab 页**：
  - **概览**：基础信息、统计信息（节点数量、关系数量）
  - **资源节点**：资源节点列表（表格形式）
    - 列：节点名称、类型、状态、添加时间、操作（移除）
    - 支持搜索和过滤
    - 支持批量移除
  - **拓扑图**：子图拓扑可视化
    - 展示子图中的所有节点
    - 展示节点间的拓扑关系
    - 支持缩放、拖拽、筛选
    - 支持节点点击查看详情
  - **权限**：Owner 和 Manager 列表

## 测试要点

### 功能测试
- 测试创建子图
- 测试编辑子图信息
- 测试删除子图
- 测试添加资源节点到子图
- 测试从子图移除资源节点
- 测试搜索和过滤功能
- 测试权限控制（Owner、Manager、Viewer）

### 性能测试
- 测试大量子图的列表加载性能
- 测试包含大量节点的子图详情页加载性能
- 测试子图拓扑图的渲染性能

### 安全测试
- 测试未授权用户无法编辑/删除子图
- 测试未授权用户无法添加/移除资源节点
- 测试审计日志记录完整性

### 集成测试
- 测试子图与资源节点的关联
- 测试子图拓扑图与全局拓扑图的一致性
- 测试删除子图后资源节点不受影响

## 相关文档

- 需求文档: `doc/intent/blueprint.md` - 2.1 资源管理
- Feature List: `doc/intent/feature-list.md`

---

**创建日期**: 2024-12-04  
**最后更新**: 2024-12-04  
**文档版本**: v1.0
