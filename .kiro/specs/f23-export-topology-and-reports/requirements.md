# 功能规格: 导出拓扑图和报告

**Feature Branch**: `f23-export-topology-and-reports`  
**创建日期**: 2024-12-12  
**状态**: Draft  
**优先级**: P1（第二阶段）

---

## 概述

运维工程师需要将拓扑图和 Agent 执行报告导出为多种格式，以便分享给团队成员、存档备查或进行离线分析。系统应支持多种导出格式（图片、PDF、数据文件），并提供安全的分享机制。

**核心价值**:
- 便于跨团队协作和汇报
- 支持离线查看和分析
- 满足合规和审计要求
- 降低信息传递成本

---

## 用户场景与测试

### 用户故事 1 - 导出拓扑图为图片 (优先级: P0)

作为运维工程师，我需要将当前的拓扑图导出为高清图片，以便在周报或技术文档中使用。

**为什么是 P0**: 这是最基础和最常用的导出需求，图片格式通用性强，易于分享和嵌入文档。

**独立测试**: 创建一个包含 10 个节点的拓扑图，导出为 PNG 和 SVG 格式，验证图片清晰度和完整性。

**验收场景**:
1. **Given** 用户正在查看拓扑图，**When** 用户点击"导出"按钮并选择 PNG 格式，**Then** 系统生成高清 PNG 图片并提供下载
2. **Given** 用户正在查看拓扑图，**When** 用户选择 SVG 格式并指定导出范围为"当前视图"，**Then** 系统仅导出可见区域的矢量图
3. **Given** 用户选择导出全图，**When** 拓扑图包含 100+ 节点，**Then** 系统在 10 秒内完成导出并保持图片质量
4. **Given** 用户自定义分辨率为 4K (3840x2160)，**When** 导出完成，**Then** 图片分辨率符合设定且文字清晰可读

---

### 用户故事 2 - 导出拓扑图为 PDF (优先级: P0)

作为运维经理，我需要将拓扑图和资源清单一起导出为 PDF 文档，以便向管理层汇报系统架构。

**为什么是 P0**: PDF 是正式文档的标准格式，适合汇报和存档，且能包含拓扑图和详细信息。

**独立测试**: 导出包含拓扑图、资源列表和关系说明的 PDF，验证格式正确且支持中文。

**验收场景**:
1. **Given** 用户选择导出 PDF，**When** 用户配置包含"资源列表"和"关系说明"，**Then** PDF 包含拓扑图、资源表格和关系描述
2. **Given** 用户设置页面大小为 A4，**When** 导出完成，**Then** PDF 自动分页且拓扑图适配页面大小
3. **Given** 用户添加水印"内部资料"，**When** 打开 PDF，**Then** 每页都显示半透明水印
4. **Given** PDF 包含中文资源名称，**When** 在不同 PDF 阅读器中打开，**Then** 中文显示正常无乱码

---

### 用户故事 3 - 导出拓扑数据 (优先级: P1)

作为数据分析师，我需要导出拓扑的原始数据（节点和边），以便使用专业工具进行深度分析。

**为什么是 P1**: 满足高级用户的数据分析需求，支持与第三方工具集成。

**独立测试**: 导出 JSON 和 GraphML 格式，使用 Gephi 或 Cytoscape 工具验证数据可读性。

**验收场景**:
1. **Given** 用户选择导出 JSON 格式，**When** 导出完成，**Then** JSON 包含所有节点属性、边关系和元数据
2. **Given** 用户选择导出 GraphML 格式，**When** 使用 Gephi 打开文件，**Then** 拓扑结构完整且可编辑
3. **Given** 用户选择导出 CSV 格式，**When** 导出完成，**Then** 生成两个文件：nodes.csv（节点列表）和 edges.csv（边列表）
4. **Given** 用户选择部分节点，**When** 导出数据，**Then** 仅导出选中节点及其直接关系

---

### 用户故事 4 - 导出 Agent 报告 (优先级: P0)

作为运维工程师，我需要将 Agent 执行报告导出为 PDF 或 Word 文档，以便存档或分享给相关人员。

**为什么是 P0**: Agent 报告是运维工作的重要产出，需要正式的文档格式进行传递和存档。

**独立测试**: 执行一个巡检 Agent，导出其报告为 PDF 和 Word 格式，验证内容完整性。

**验收场景**:
1. **Given** Agent 执行完成生成报告，**When** 用户导出为 PDF，**Then** PDF 包含报告标题、执行时间、结果摘要和详细内容
2. **Given** 用户导出为 Word 格式，**When** 使用 Microsoft Word 打开，**Then** 文档格式正确且可编辑
3. **Given** 报告包含图表和表格，**When** 导出完成，**Then** 图表和表格在文档中正确显示
4. **Given** 用户自定义报告样式（字体、颜色），**When** 导出 PDF，**Then** PDF 应用自定义样式

---

### 用户故事 5 - 生成分享链接 (优先级: P1)

作为团队负责人，我需要生成临时分享链接，让外部协作方可以查看拓扑图或报告，但不能修改或永久保存。

**为什么是 P1**: 提供安全的临时分享机制，平衡协作需求和安全控制。

**独立测试**: 生成一个 24 小时有效的分享链接，验证权限控制和过期机制。

**验收场景**:
1. **Given** 用户选择生成分享链接，**When** 设置有效期为 24 小时，**Then** 系统生成唯一链接且在 24 小时后自动失效
2. **Given** 用户配置访问权限为"仅查看"，**When** 访问者打开链接，**Then** 可以查看内容但无法下载或导出
3. **Given** 用户设置密码保护，**When** 访问者打开链接，**Then** 需要输入正确密码才能查看内容
4. **Given** 分享链接已过期，**When** 访问者打开链接，**Then** 显示"链接已失效"提示

---

### 用户故事 6 - 管理导出历史 (优先级: P2)

作为运维工程师，我需要查看和管理我的导出历史记录，以便重新下载之前的导出文件或清理过期文件。

**为什么是 P2**: 提升用户体验，避免重复导出，但不影响核心功能。

**独立测试**: 执行 5 次导出操作，验证历史记录的准确性和文件可下载性。

**验收场景**:
1. **Given** 用户进入导出历史页面，**When** 页面加载完成，**Then** 显示所有导出记录（时间、类型、文件大小）
2. **Given** 用户点击历史记录的下载按钮，**When** 文件仍在保留期内，**Then** 直接下载文件无需重新生成
3. **Given** 用户选择多条历史记录，**When** 点击批量删除，**Then** 系统删除选中记录和对应文件
4. **Given** 导出文件超过 30 天，**When** 系统执行定期清理，**Then** 自动删除过期文件并更新历史记录状态

---

### 边界情况

- **大规模拓扑图**: 当拓扑图包含 1000+ 节点时，导出性能如何保证？是否需要分批处理或异步导出？
- **并发导出**: 多个用户同时导出时，系统如何处理资源竞争？是否有队列机制？
- **文件大小限制**: 导出文件是否有大小限制？超过限制时如何处理？
- **格式兼容性**: 导出的 PDF/Word 文件在不同版本的软件中是否都能正常打开？
- **网络中断**: 导出过程中网络中断，系统如何恢复或重试？
- **权限变更**: 分享链接生成后，如果用户权限被撤销，链接是否立即失效？

---

## 功能需求

### 导出格式支持

- **FR-001**: 系统必须支持将拓扑图导出为 PNG 格式（支持自定义分辨率：1080p、2K、4K）
- **FR-002**: 系统必须支持将拓扑图导出为 SVG 格式（矢量图，支持无损缩放）
- **FR-003**: 系统必须支持将拓扑图和资源信息导出为 PDF 格式（支持 A4、A3、Letter 页面大小）
- **FR-004**: 系统必须支持将拓扑数据导出为 JSON 格式（包含完整的节点和边信息）
- **FR-005**: 系统必须支持将拓扑数据导出为 GraphML 格式（符合 GraphML 1.0 标准）
- **FR-006**: 系统必须支持将拓扑数据导出为 CSV 格式（分别生成节点和边的 CSV 文件）
- **FR-007**: 系统必须支持将 Agent 报告导出为 PDF 格式（包含格式化的文本、图表和表格）
- **FR-008**: 系统必须支持将 Agent 报告导出为 Word 格式（.docx，可编辑）

### 导出范围控制

- **FR-009**: 用户必须能够选择导出范围：当前视图、全图、或选中的部分节点
- **FR-010**: 当用户选择"选中部分"时，系统必须仅导出选中节点及其直接关系
- **FR-011**: 当用户选择"当前视图"时，系统必须导出屏幕可见区域的内容

### 导出配置选项

- **FR-012**: 用户必须能够为 PDF 导出配置水印（文字内容、透明度、位置）
- **FR-013**: 用户必须能够为图片导出自定义分辨率（最低 720p，最高 4K）
- **FR-014**: 用户必须能够为 PDF 导出选择页面大小（A4、A3、Letter）
- **FR-015**: 用户必须能够为报告导出自定义样式（字体、颜色、Logo）

### 分享链接功能

- **FR-016**: 系统必须支持生成临时分享链接（唯一 URL）
- **FR-017**: 用户必须能够配置分享链接的有效期（1 小时、24 小时、7 天、30 天）
- **FR-018**: 用户必须能够配置分享链接的访问权限（仅查看、允许下载）
- **FR-019**: 用户必须能够为分享链接设置密码保护（可选）
- **FR-020**: 系统必须在分享链接过期后自动使其失效
- **FR-021**: 系统必须为分享链接生成二维码（便于移动端访问）

### 导出历史管理

- **FR-022**: 系统必须记录所有导出操作（时间、类型、文件大小、状态）
- **FR-023**: 用户必须能够查看自己的导出历史记录
- **FR-024**: 用户必须能够从导出历史中重新下载文件（在保留期内）
- **FR-025**: 用户必须能够删除导出历史记录和对应文件
- **FR-026**: 系统必须自动清理超过 30 天的导出文件

### 性能和可靠性

- **FR-027**: 系统必须在 10 秒内完成小型拓扑图（< 100 节点）的导出
- **FR-028**: 系统必须支持大型拓扑图（1000+ 节点）的导出，可采用异步处理
- **FR-029**: 系统必须支持至少 10 个并发导出请求
- **FR-030**: 导出失败时，系统必须提供明确的错误信息和重试选项

---

## 关键实体

### 导出任务 (ExportTask)
- **描述**: 代表一次导出操作
- **关键属性**: 
  - 任务 ID（唯一标识）
  - 用户 ID（创建者）
  - 导出类型（拓扑图/报告）
  - 导出格式（PNG/SVG/PDF/JSON/GraphML/CSV/Word）
  - 导出范围（全图/当前视图/选中部分）
  - 配置选项（分辨率、页面大小、水印等）
  - 状态（待处理/处理中/已完成/失败）
  - 文件路径（导出文件的存储位置）
  - 文件大小
  - 创建时间
  - 完成时间
  - 过期时间（30 天后）
- **关系**: 
  - 属于一个用户
  - 关联一个拓扑图或报告

### 分享链接 (ShareLink)
- **描述**: 临时分享链接
- **关键属性**:
  - 链接 ID（唯一标识）
  - 短链接码（6-8 位随机字符）
  - 用户 ID（创建者）
  - 资源类型（拓扑图/报告）
  - 资源 ID
  - 访问权限（仅查看/允许下载）
  - 密码（可选，加密存储）
  - 有效期（过期时间戳）
  - 访问次数（统计）
  - 创建时间
  - 状态（有效/已过期/已撤销）
- **关系**:
  - 属于一个用户
  - 关联一个导出任务或资源

### 导出历史 (ExportHistory)
- **描述**: 用户的导出历史记录
- **关键属性**:
  - 历史 ID
  - 用户 ID
  - 导出任务 ID
  - 导出时间
  - 文件名
  - 文件大小
  - 文件状态（可下载/已过期/已删除）
- **关系**:
  - 属于一个用户
  - 关联一个导出任务

---

## 成功标准

### 可衡量的结果

- **SC-001**: 95% 的小型拓扑图（< 100 节点）导出在 5 秒内完成
- **SC-002**: 导出的 PNG 图片在 4K 分辨率下文字清晰可读（无模糊或锯齿）
- **SC-003**: 导出的 PDF 文件在 Adobe Reader、Chrome、Edge 等主流阅读器中显示一致
- **SC-004**: 导出的 GraphML 文件可被 Gephi、Cytoscape 等工具正确解析
- **SC-005**: 分享链接在设定的有效期后 1 分钟内自动失效
- **SC-006**: 系统支持至少 10 个用户同时导出而不出现性能下降
- **SC-007**: 导出文件的存储空间占用不超过原始数据的 10 倍
- **SC-008**: 用户可在 3 次点击内完成导出操作（从拓扑图页面到下载文件）
- **SC-009**: 导出历史记录的查询响应时间在 1 秒内（包含 1000 条记录）
- **SC-010**: 导出失败率低于 1%（排除用户取消操作）

---

## 假设

1. **文件存储**: 假设系统使用云存储服务（如 AWS S3 或阿里云 OSS）存储导出文件，支持大容量和高并发访问
2. **PDF 生成**: 假设使用成熟的 PDF 生成库（如 iText 或 Apache PDFBox），支持中文字体和复杂布局
3. **图片渲染**: 假设前端使用 Canvas API 或 SVG 进行拓扑图渲染，支持高分辨率导出
4. **文件大小**: 假设单个导出文件大小不超过 100MB，超过则需要压缩或分批处理
5. **保留期限**: 假设导出文件默认保留 30 天，用户可手动删除或延长保留期
6. **并发限制**: 假设单个用户同时只能有 3 个导出任务在处理中，超过则需要排队
7. **分享安全**: 假设分享链接使用 HTTPS 传输，密码使用 BCrypt 加密存储
8. **格式兼容**: 假设导出的文件符合标准格式规范，可在主流软件中打开

---

## 依赖关系

### 前置依赖
- **F03: 创建和管理 IT 资源** - 需要有资源数据才能导出
- **F04: 建立资源间的拓扑关系** - 需要有拓扑关系才能生成拓扑图
- **F05: 可视化查看拓扑图** - 导出功能基于拓扑图可视化
- **F08: 查看 Agent 执行结果和报告** - 需要有报告数据才能导出报告

### 后置依赖
- 无直接后置依赖，但导出功能可增强其他功能的价值

---

## 非功能需求

### 性能要求
- 小型拓扑图（< 100 节点）导出响应时间 < 5 秒
- 中型拓扑图（100-500 节点）导出响应时间 < 10 秒
- 大型拓扑图（> 500 节点）采用异步处理，用户可在后台查看进度
- 支持至少 10 个并发导出请求

### 安全要求
- 导出文件仅对创建者和有权限的用户可见
- 分享链接支持密码保护和有效期控制
- 导出文件存储在安全的云存储服务中，支持访问控制
- 敏感信息（如密码）在分享链接中加密存储

### 可用性要求
- 导出功能的可用性 > 99.5%
- 导出失败时提供明确的错误信息和重试选项
- 支持断点续传（对于大文件导出）

### 兼容性要求
- 导出的 PNG/SVG 图片在主流浏览器和图片查看器中正常显示
- 导出的 PDF 文件在 Adobe Reader、Chrome、Edge 等阅读器中显示一致
- 导出的 Word 文件在 Microsoft Word 2016+ 和 WPS Office 中可编辑
- 导出的 GraphML 文件符合 GraphML 1.0 标准，可被 Gephi、Cytoscape 等工具解析

### 可维护性要求
- 导出模块与其他模块低耦合，便于独立升级
- 支持新增导出格式而不影响现有功能
- 导出配置可通过配置文件或管理界面调整

---

## 待澄清问题

[NEEDS CLARIFICATION: 大型拓扑图异步导出]
**问题**: 对于包含 1000+ 节点的大型拓扑图，是否需要实现异步导出机制？如果需要，用户如何获知导出完成？
**影响**: 
- 如果采用异步导出，需要实现任务队列、进度通知和结果推送机制
- 如果采用同步导出，可能导致请求超时或用户体验不佳
**建议**: 建议采用异步导出，当导出任务创建后，用户可在"导出历史"页面查看进度，完成后通过站内通知或邮件提醒

[NEEDS CLARIFICATION: 导出文件存储位置]
**问题**: 导出文件应该存储在本地服务器还是云存储服务（如 AWS S3、阿里云 OSS）？
**影响**:
- 本地存储：成本低，但扩展性差，需要考虑磁盘空间和备份
- 云存储：成本较高，但扩展性好，支持 CDN 加速和高可用
**建议**: 建议使用云存储服务，便于扩展和管理，且支持分享链接的快速访问

[NEEDS CLARIFICATION: 分享链接的访问统计]
**问题**: 是否需要记录分享链接的访问统计（访问次数、访问者 IP、访问时间）？
**影响**:
- 如果需要统计，可以帮助用户了解分享效果，但增加存储和隐私合规成本
- 如果不需要统计，实现更简单，但缺少数据洞察
**建议**: 建议记录基本的访问次数和最后访问时间，不记录访问者 IP（避免隐私问题）

---

**文档版本**: v1.0  
**最后更新**: 2024-12-12
