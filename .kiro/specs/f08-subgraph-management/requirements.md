# 需求文档 - 子图管理

## 简介

本文档规定了子图管理功能（F08）的需求，该功能使运维工程师能够创建和管理子图，将相关的资源节点组织在一起。此功能提供子图级别的拓扑可视化，并促进特定业务域或系统模块的团队协作和权限管理。

## 术语表

- **子图（Subgraph）**: 资源节点的逻辑分组，代表特定的业务域、系统模块或运维范围。子图名称在系统中必须全局唯一
- **资源节点（Resource Node）**: IT 资源（服务器、应用、数据库等），可以同时包含在多个子图中（多对多关系）
- **所有者（Owner）**: 对子图拥有完全控制权限的用户，包括编辑、删除、权限管理和资源节点管理
- **查看者（Viewer）**: 具有只读访问权限的用户，可以查看子图详情和拓扑
- **系统（System）**: AIOps Service 平台
- **用户（User）**: 系统的已认证用户
- **拓扑图（Topology Graph）**: 显示子图内资源节点及其相互关系的可视化表示

## 需求

### 需求 1: 子图创建

**用户故事：** 作为运维工程师，我希望创建一个包含基本信息和权限的新子图，以便将相关资源组织成一个逻辑组。

#### 验收标准

1. WHEN 用户点击"创建子图"按钮 THEN THE System SHALL 显示包含名称、描述、标签和元数据字段的子图创建表单
2. WHEN 用户提交填写了所有必填字段的创建表单 THEN THE System SHALL 创建子图并自动将创建者指定为第一个 Owner
3. WHEN 用户提交缺少必填字段的创建表单 THEN THE System SHALL 显示验证错误并阻止提交
4. WHEN 用户提交的子图名称与系统中已存在的子图名称重复 THEN THE System SHALL 显示错误消息并阻止创建
5. WHEN 子图成功创建 THEN THE System SHALL 将用户重定向到子图详情页面
6. WHEN 子图被创建 THEN THE System SHALL 在审计日志中记录创建事件，包括时间戳、创建者 ID 和子图详情

### 需求 2: 子图列表视图

**用户故事：** 作为运维工程师，我希望查看我有权访问的所有子图列表，并具有搜索和过滤功能，以便快速找到我需要使用的子图。

#### 验收标准

1. WHEN 用户访问子图管理页面 THEN THE System SHALL 显示用户作为 Owner 或 Viewer 的所有子图
2. WHEN 用户在搜索框中输入关键词 THEN THE System SHALL 实时过滤并显示名称或描述包含关键词的子图
3. WHEN 用户选择标签过滤器 THEN THE System SHALL 仅显示包含所选标签的子图
4. WHEN 用户选择所有者过滤器 THEN THE System SHALL 仅显示由所选用户拥有的子图
5. WHEN 用户选择排序选项 THEN THE System SHALL 按所选标准（创建时间、更新时间或名称）重新排序子图列表
6. WHEN 子图列表包含超过 20 项 THEN THE System SHALL 实现分页，每页 20 项

### 需求 3: 子图信息编辑

**用户故事：** 作为子图所有者，我希望编辑子图的基本信息和权限，以便保持子图元数据的最新状态并管理访问控制。

#### 验收标准

1. WHEN 作为子图 Owner 的用户点击"编辑"按钮 THEN THE System SHALL 显示预填充当前值的子图编辑表单
2. WHEN 非 Owner 的用户尝试访问编辑功能 THEN THE System SHALL 拒绝访问并显示错误消息
3. WHEN Owner 更新子图名称为已存在的名称 THEN THE System SHALL 显示错误消息并阻止更新
4. WHEN Owner 更新子图信息并保存 THEN THE System SHALL 验证更改、更新子图并在审计日志中记录修改
5. WHEN Owner 添加或移除其他 Owner THEN THE System SHALL 更新权限列表并通知受影响的用户
6. WHEN Owner 尝试移除自己作为最后一个 Owner THEN THE System SHALL 阻止操作并显示警告消息

### 需求 4: 子图删除

**用户故事：** 作为子图所有者，我希望删除不再需要的子图，以便维护一个干净有序的子图列表。

#### 验收标准

1. WHEN 非 Owner 的用户尝试删除子图 THEN THE System SHALL 拒绝操作并显示错误消息
2. WHEN Owner 尝试删除包含资源节点的子图 THEN THE System SHALL 拒绝操作并显示错误消息，提示必须先移除所有资源节点
3. WHEN Owner 点击"删除"按钮且子图为空 THEN THE System SHALL 显示包含后果警告的确认对话框
4. WHEN Owner 确认删除空子图 THEN THE System SHALL 物理删除子图、删除所有权限记录并在审计日志中记录删除
5. WHEN 子图被删除 THEN THE System SHALL 保留资源节点本身不做修改
6. WHEN 子图删除失败 THEN THE System SHALL 回滚所有更改并向用户显示错误消息

### 需求 5: 向子图添加资源节点

**用户故事：** 作为子图所有者，我希望向子图添加资源节点而不考虑节点所有权，以便构建跨不同所有者的相关资源的完整视图。

#### 验收标准

1. WHEN 作为 Owner 的用户点击"添加节点" THEN THE System SHALL 显示资源节点选择界面
2. WHEN 非 Owner 的用户尝试添加节点 THEN THE System SHALL 拒绝访问并显示错误消息
3. WHEN Owner 选择资源节点并确认 THEN THE System SHALL 将节点添加到子图而不验证节点所有权
4. WHEN Owner 尝试添加子图中已存在的节点 THEN THE System SHALL 显示消息指示节点已包含
5. WHEN 资源节点成功添加 THEN THE System SHALL 在审计日志中记录添加操作，包括时间戳、用户 ID 和节点 ID
6. WHEN 资源节点被添加到子图 THEN THE System SHALL 允许该节点同时存在于多个子图中

### 需求 6: 从子图移除资源节点

**用户故事：** 作为子图所有者，我希望从子图中移除资源节点，以便维护当前系统范围的准确表示。

#### 验收标准

1. WHEN 作为 Owner 的用户点击资源节点上的"移除" THEN THE System SHALL 显示确认对话框
2. WHEN 非 Owner 的用户尝试移除节点 THEN THE System SHALL 拒绝访问并显示错误消息
3. WHEN Owner 确认节点移除 THEN THE System SHALL 移除子图与节点之间的关联
4. WHEN 节点从子图中移除 THEN THE System SHALL 保留资源节点本身不删除或修改
5. WHEN 节点从一个子图中移除 THEN THE System SHALL 保留该节点在其他子图中的关联
6. WHEN 节点成功移除 THEN THE System SHALL 在审计日志中记录移除操作，包括时间戳、用户 ID 和节点 ID

### 需求 7: 子图详情视图

**用户故事：** 作为运维工程师，我希望查看子图的全面详情，包括基本信息、资源节点、拓扑图和权限，以便了解子图的完整情况。

#### 验收标准

1. WHEN 用户访问子图详情页面 THEN THE System SHALL 显示子图名称、描述、标签、创建时间、更新时间和 Owner 列表
2. WHEN 用户查看资源节点列表标签页 THEN THE System SHALL 显示包含节点名称、类型、状态、添加时间和操作按钮列的表格
3. WHEN 用户查看拓扑图标签页 THEN THE System SHALL 渲染子图中所有节点及其相互关系的可视化表示
4. WHEN 用户查看拓扑图 THEN THE System SHALL 仅显示子图内节点之间的关系，不显示与子图外节点的关系
5. WHEN 用户点击资源列表中的节点 THEN THE System SHALL 导航到资源节点详情页面
6. WHEN 用户点击拓扑图中的节点 THEN THE System SHALL 高亮显示节点并显示包含节点信息的工具提示
7. WHEN 用户查看权限标签页 THEN THE System SHALL 显示包含用户信息的 Owner 完整列表

### 需求 8: 子图性能

**用户故事：** 作为系统管理员，我希望子图管理系统能够高效处理大规模数据，以便用户可以在不降低性能的情况下使用子图。

#### 验收标准

1. WHEN 用户查询子图列表 THEN THE System SHALL 在 1 秒内返回最多 1000 个子图的结果
2. WHEN 用户加载子图详情页面 THEN THE System SHALL 在 2 秒内渲染包含最多 500 个节点的子图页面
3. WHEN 用户渲染子图拓扑图 THEN THE System SHALL 在 3 秒内显示最多 500 个节点和 1000 个关系的图形
4. WHEN 系统执行子图操作（创建、更新、删除） THEN THE System SHALL 在 500 毫秒内完成操作
5. WHEN 多个用户并发访问子图功能 THEN THE System SHALL 为最多 100 个并发用户维持可接受限度内的响应时间

### 需求 9: 子图安全和审计

**用户故事：** 作为安全管理员，我希望所有子图操作都经过适当授权和审计，以便维护安全合规性并跟踪变更。

#### 验收标准

1. WHEN 任何用户尝试任何子图操作 THEN THE System SHALL 在允许操作之前验证用户的权限
2. WHEN 用户创建、更新或删除子图 THEN THE System SHALL 在审计日志中记录操作，包括用户 ID、时间戳、操作类型和受影响的数据
3. WHEN 用户添加或移除资源节点 THEN THE System SHALL 在审计日志中记录操作，包括用户 ID、时间戳、节点 ID 和操作类型
4. WHEN 用户修改子图权限 THEN THE System SHALL 在审计日志中记录权限变更，包括变更前后的状态
5. WHEN 尝试未授权操作 THEN THE System SHALL 记录尝试，包括用户 ID、时间戳和尝试的操作详情

### 需求 10: 子图数据完整性

**用户故事：** 作为系统管理员，我希望系统维护子图及其关联的数据完整性，以便数据保持一致和可靠。

#### 验收标准

1. WHEN 子图被删除 THEN THE System SHALL 在同一事务中物理删除子图记录和所有权限记录
2. WHEN 资源节点从系统中删除 THEN THE System SHALL 自动移除该节点在所有子图中的关联
3. WHEN 用户从系统中删除 THEN THE System SHALL 将其拥有的子图的所有权转移给指定管理员
4. WHEN 并发操作修改同一子图 THEN THE System SHALL 使用乐观锁防止数据冲突
5. WHEN 任何数据库操作失败 THEN THE System SHALL 在事务内回滚所有更改以维护一致性


## 需求澄清

本节记录了在需求分析过程中澄清的关键决策，这些决策对系统设计和实现有重要影响。

### 澄清 1: 子图名称唯一性

**决策**: 子图名称必须在系统中全局唯一

**理由**: 
- 避免用户混淆，确保每个子图可以通过名称唯一标识
- 简化搜索和引用机制
- 符合资源管理的最佳实践

**影响**: 
- 需要在数据库层面添加唯一约束
- 创建和更新操作需要验证名称唯一性
- 错误处理需要包含名称重复的情况

### 澄清 2: 资源节点与子图的关系

**决策**: 一个资源节点可以同时属于多个子图（多对多关系）

**理由**:
- 符合实际运维场景（如一个数据库可能同时属于"支付系统"和"核心服务"子图）
- 提供更大的灵活性，支持不同维度的资源组织
- 不限制用户的使用方式

**影响**:
- 使用关联表（subgraph_resource）实现多对多关系
- 删除节点时需要清理所有子图关联
- 从一个子图移除节点不影响其在其他子图中的存在

### 澄清 3: 权限角色简化

**决策**: 只保留 Owner 和 Viewer 两种角色，移除 Manager 角色

**理由**:
- 简化权限模型，降低系统复杂度
- Owner 拥有完全控制权，包括资源节点管理
- Viewer 只有查看权限
- 避免权限层级混乱

**影响**:
- 数据模型中只需要 OWNER 和 VIEWER 两种角色
- 所有资源节点的添加/移除操作都需要 Owner 权限
- 权限管理逻辑更简单清晰

### 澄清 4: 子图删除策略

**决策**: 子图采用物理删除，但删除前必须先移除所有资源节点

**理由**:
- 防止误删除包含重要资源的子图
- 强制用户明确处理资源节点，避免数据丢失
- 物理删除可以释放存储空间
- 审计日志已经记录了删除操作，无需保留记录

**影响**:
- 删除操作需要先检查子图是否为空
- 非空子图的删除请求会被拒绝
- 需要提供清晰的错误提示，指导用户先移除节点
- 数据库外键约束使用 ON DELETE CASCADE 清理权限记录

### 澄清 5: 拓扑图显示范围

**决策**: 子图拓扑图只显示子图内节点之间的关系

**理由**:
- 子图是一个逻辑边界，应该聚焦于内部结构
- 避免拓扑图过于复杂，影响可读性
- 如果需要查看跨子图关系，可以使用全局拓扑图
- 提高渲染性能

**影响**:
- 拓扑图查询只需要查询子图内节点的关系
- 不需要查询子图外节点的信息
- 简化前端渲染逻辑

## 约束条件

### 功能约束

1. **子图名称**: 必须全局唯一，长度限制 1-255 字符
2. **资源节点数量**: 每个子图最多支持 500 个资源节点
3. **Owner 数量**: 每个子图至少需要 1 个 Owner，最多支持 10 个 Owner
4. **删除限制**: 只能删除空子图（不包含任何资源节点）

### 技术约束

1. **数据库**: 使用 MySQL 8.0+，InnoDB 存储引擎
2. **事务隔离级别**: READ_COMMITTED
3. **并发控制**: 使用乐观锁（version 字段）
4. **字符集**: UTF-8MB4

### 性能约束

1. **列表查询**: < 1 秒（最多 1000 个子图）
2. **详情加载**: < 2 秒（最多 500 个节点）
3. **拓扑渲染**: < 3 秒（最多 500 个节点和 1000 个关系）
4. **操作响应**: < 500 毫秒（创建、更新、删除）
5. **并发支持**: 最多 100 个并发用户

## 依赖关系

### 前置依赖

- **F01: 用户登录和身份认证** - 提供用户身份验证和 JWT token
- **F02: 管理资源的访问权限** - 提供资源权限验证机制
- **F03: 创建和管理 IT 资源** - 提供资源节点数据
- **F04: 建立资源间的拓扑关系** - 提供节点关系数据
- **F05: 可视化查看拓扑图** - 提供拓扑图渲染能力

### 后置依赖

无

## 非功能需求

### 可用性

- 系统可用性目标: 99.9%
- 计划内维护窗口: 每月不超过 4 小时

### 可维护性

- 代码遵循 DDD 分层架构
- 完整的单元测试和集成测试
- 清晰的 API 文档

### 可扩展性

- 支持水平扩展（无状态设计）
- 数据库支持读写分离
- 支持缓存层（Redis）

### 安全性

- 所有 API 需要 JWT 认证
- 所有操作需要权限验证
- 敏感操作记录审计日志
- 防止 SQL 注入和 XSS 攻击

---

**文档版本**: v1.0  
**最后更新**: 2024-12-04  
**更新内容**: 根据需求澄清更新了验收标准，添加了需求澄清章节
