# F08: 子图管理

## 基本信息

- **Feature ID**: F08
- **Feature 名称**: 子图管理
- **优先级**: P1（重要功能）
- **状态**: 待开发
- **负责人**: 待分配
- **预计工作量**: 待评估

## 设计原则

**子图作为资源类型的一种进行管理**。子图不是独立的实体，而是 `resource_type` 中的一种类型（code=SUBGRAPH），存储在统一的 `resource` 表中，复用资源的权限模型和管理机制。

## 用户故事

作为运维工程师，我希望能够创建和管理子图，将相关的资源节点组织在一起，以便更好地管理和查看特定业务域或系统模块的拓扑结构。

## 功能价值

- 支持按业务域或系统模块组织资源节点
- 提供子图级别的拓扑可视化
- 便于团队协作和权限管理
- 简化复杂系统的拓扑管理
- **统一管理**：子图与其他资源使用相同的管理机制
- **支持嵌套**：子图可以包含其他子图，形成层级结构

## 核心功能

### 1. 创建子图（复用资源创建 API）
- 选择资源类型为"子图"（SUBGRAPH）
- 填写子图基本信息（名称、描述、标签）
- 配置子图元数据（业务域、环境、团队）
- 创建者自动成为 Owner

### 2. 查看子图列表（复用资源列表 API）
- 通过资源类型过滤（type=SUBGRAPH）展示子图列表
- 支持按名称搜索
- 支持按标签过滤
- 支持按所有者过滤
- 支持排序（按创建时间、更新时间、名称）

### 3. 编辑子图信息（复用资源编辑 API）
- 更新基本信息（名称、描述、标签）
- 修改子图元数据
- 仅所有者可以编辑

### 4. 删除子图（复用资源删除 API + 额外校验）
- 验证用户权限（只有 Owner 可以删除）
- **额外校验**：子图必须为空（无成员资源）才能删除
- 提示用户确认删除
- 执行删除操作并记录审计日志

### 5. 子图成员管理（子图特有功能）
- 添加资源到子图（无需考虑资源所属 Owner）
- **支持添加其他子图**：实现子图嵌套
- 从子图中移除资源
- 查看子图中的资源列表（支持分页）
- 查看子图中的所有资源及其关系（不分页，用于拓扑图展示）
- 仅所有者可以添加/移除成员

### 6. 查看子图详情（复用资源详情 API + 扩展）
- 展示子图的完整信息
- 显示基础信息（名称、描述、标签、创建时间等）
- 显示成员资源列表（表格形式）
- 显示子图拓扑图（可视化形式）
- 显示权限信息（Owner 和 Viewer 列表）

### 7. 子图拓扑视图（子图特有功能）
- 在全局拓扑图中，子图显示为可展开/折叠的节点
- 展开时显示内部所有成员资源及其关系
- 折叠时显示为单个子图节点
- 支持多层嵌套的展开/折叠

## 验收标准

### AC1: 创建子图（复用资源创建流程）
**WHEN** 用户选择资源类型为"子图"并填写必填信息 **THEN** THE System **SHALL** 创建子图资源并跳转到详情页

**WHEN** 用户创建子图 **THEN** THE System **SHALL** 自动将创建者设置为该子图的第一个 Owner

### AC2: 查看子图列表（复用资源列表流程）
**WHEN** 用户访问资源列表并过滤类型为"子图" **THEN** THE System **SHALL** 显示用户有权限查看的所有子图

**WHEN** 用户在搜索框输入关键词 **THEN** THE System **SHALL** 实时过滤并显示匹配的子图

**WHEN** 用户选择标签过滤器 **THEN** THE System **SHALL** 只显示包含该标签的子图

### AC3: 编辑子图（复用资源编辑流程）
**WHEN** 用户是子图的 Owner **THEN** THE System **SHALL** 允许用户编辑子图信息

**WHEN** 用户不是子图的 Owner **THEN** THE System **SHALL** 禁止用户编辑子图信息

**WHEN** 用户保存编辑 **THEN** THE System **SHALL** 更新子图信息并记录审计日志

### AC4: 删除子图（复用资源删除流程 + 额外校验）
**WHEN** 用户不是子图的 Owner **THEN** THE System **SHALL** 禁止用户删除子图

**WHEN** 子图中仍有成员资源 **THEN** THE System **SHALL** 禁止删除并提示"请先移除所有成员资源"

**WHEN** 用户是子图的 Owner 且子图为空并确认删除 **THEN** THE System **SHALL** 删除子图并记录审计日志

### AC5: 添加成员资源到子图
**WHEN** 用户是子图的 Owner **THEN** THE System **SHALL** 允许用户添加资源到子图

**WHEN** 用户不是子图的 Owner **THEN** THE System **SHALL** 禁止用户添加资源

**WHEN** 用户添加资源 **THEN** THE System **SHALL** 无需验证资源的 Owner 权限

**WHEN** 用户添加已存在的资源 **THEN** THE System **SHALL** 提示资源已在子图中

**WHEN** 用户添加另一个子图 **THEN** THE System **SHALL** 允许添加，实现子图嵌套

**WHEN** 添加子图会导致循环引用 **THEN** THE System **SHALL** 禁止添加并提示错误

### AC6: 从子图移除成员资源
**WHEN** 用户是子图的 Owner **THEN** THE System **SHALL** 允许用户从子图移除资源

**WHEN** 用户不是子图的 Owner **THEN** THE System **SHALL** 禁止用户移除资源

**WHEN** 用户移除资源 **THEN** THE System **SHALL** 只移除子图关联，不删除资源本身

### AC7: 查询子图成员列表（分页）
**WHEN** 用户请求查询子图成员列表 **THEN** THE System **SHALL** 返回分页的资源列表，包含资源名称、类型、状态、添加时间等信息

**WHEN** 成员中包含子图类型 **THEN** THE System **SHALL** 显示子图图标并支持展开查看

### AC8: 查询子图所有成员及关系（不分页，用于拓扑图）
**WHEN** 用户请求获取子图所有成员及关系 **THEN** THE System **SHALL** 返回子图内所有资源的完整信息以及资源之间的关系数据

**WHEN** 子图内存在嵌套子图 **THEN** THE System **SHALL** 递归返回嵌套子图的成员信息

### AC9: 查看子图详情（复用资源详情 + 扩展）
**WHEN** 用户访问子图详情页 **THEN** THE System **SHALL** 显示以下内容：
- 基础信息区域（名称、描述、标签、创建时间、更新时间、Owner、Viewer）
- 成员资源列表（表格形式，包含资源名称、类型、状态、操作按钮）
- 子图拓扑图（可视化形式，展示资源和资源间的关系）

**WHEN** 用户在成员列表中点击资源 **THEN** THE System **SHALL** 跳转到该资源的详情页

**WHEN** 用户在拓扑图中点击嵌套子图 **THEN** THE System **SHALL** 支持展开/折叠该子图

### AC10: 子图在全局拓扑图中的展示
**WHEN** 全局拓扑图中存在子图类型资源 **THEN** THE System **SHALL** 显示为可展开/折叠的节点

**WHEN** 用户点击展开子图 **THEN** THE System **SHALL** 显示子图内部的所有成员资源及其关系

**WHEN** 用户点击折叠子图 **THEN** THE System **SHALL** 将子图显示为单个节点

## 依赖关系

### 前置依赖
- F01: 用户登录和身份认证
- F02: 管理资源的访问权限
- F03: 创建和管理 IT 资源
- F04: 建立资源间的拓扑关系
- F05: 可视化查看拓扑图

### 后置依赖
- 无

## 技术考虑

### 数据模型

**设计原则**：子图作为资源类型的一种，复用资源表和权限表，仅新增成员关联表。

#### 1. 资源类型表（复用，新增子图类型）
```sql
-- 在 resource_type 表中预置子图类型
INSERT INTO resource_type (code, name, description, icon, is_system)
VALUES ('SUBGRAPH', '子图', '资源分组容器，支持嵌套', 'folder-tree', true);
```

#### 2. 资源表（复用）
- 子图存储在 `resource` 表中，`resource_type_id` 指向 SUBGRAPH 类型
- 复用资源的通用字段：id, name, description, tags, metadata, created_at, updated_at, created_by

#### 3. 资源权限表（复用）
- 子图的权限存储在 `resource_permission` 表中
- 复用 Owner/Viewer 权限模型

#### 4. 子图成员关联表（新增）
```sql
CREATE TABLE subgraph_member (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    subgraph_id BIGINT NOT NULL,        -- 子图资源 ID（指向 resource 表）
    member_id BIGINT NOT NULL,          -- 成员资源 ID（可以是任意资源，包括子图）
    added_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    added_by BIGINT NOT NULL,
    UNIQUE KEY uk_subgraph_member (subgraph_id, member_id),
    INDEX idx_subgraph_id (subgraph_id),
    INDEX idx_member_id (member_id),
    FOREIGN KEY (subgraph_id) REFERENCES resource(id) ON DELETE CASCADE,
    FOREIGN KEY (member_id) REFERENCES resource(id) ON DELETE CASCADE
);
```

### 权限模型（复用资源权限）
- **Owner（所有者）**：
  - 可以编辑子图信息
  - 可以删除子图（需子图为空）
  - 可以添加/移除成员资源
  - 可以管理 Owner 和 Viewer 列表
- **Viewer（查看者）**：
  - 可以查看子图详情
  - 可以查看子图拓扑
  - 不能进行任何修改操作

### 子图嵌套与循环检测
- 子图可以包含其他子图，形成层级结构
- 添加成员时需检测循环引用（A 包含 B，B 不能再包含 A）
- 检测算法：深度优先遍历，检查目标子图的所有祖先是否包含当前子图

### 性能要求
- 子图列表查询响应时间 < 1 秒
- 子图详情页加载时间 < 2 秒
- 支持至少 1000 个子图的管理
- 每个子图支持至少 500 个资源节点

### 安全要求
- 所有操作需要权限验证
- 删除操作需要记录审计日志
- 添加/移除节点操作需要记录审计日志

## 界面设计要点

### 子图列表页面（复用资源列表 + 类型过滤）
- 左侧：类型过滤器（预选"子图"）、标签过滤器、所有者过滤器
- 中间：子图列表（卡片视图，显示名称、描述、成员数量、Owner）
- 右上角：搜索框、创建按钮
- 子图卡片显示特殊图标，区别于其他资源类型

### 子图创建/编辑页面（复用资源表单）
- 资源类型：预选"子图"
- 基本信息：名称、描述、标签
- 元数据：业务域、环境、团队
- 操作按钮：保存、取消

### 子图详情页面（复用资源详情 + 扩展 Tab）
- **顶部**：子图名称、类型图标、操作按钮（编辑、删除、添加成员）
- **Tab 页**：
  - **概览**：基础信息、统计信息（成员数量、关系数量、嵌套深度）
  - **成员资源**：成员资源列表（表格形式）
    - 列：资源名称、类型（子图显示特殊图标）、状态、添加时间、操作（移除、展开）
    - 支持搜索和过滤
    - 支持批量移除
    - 嵌套子图可展开查看
  - **拓扑图**：子图拓扑可视化
    - 展示子图中的所有成员资源
    - 展示资源间的拓扑关系
    - 嵌套子图显示为可展开/折叠节点
    - 支持缩放、拖拽、筛选
    - 支持节点点击查看详情
  - **权限**：Owner 和 Viewer 列表（复用资源权限管理）

## 测试要点

### 功能测试
- 测试创建子图（复用资源创建流程）
- 测试编辑子图信息（复用资源编辑流程）
- 测试删除子图（空子图可删除，非空子图禁止删除）
- 测试添加成员资源到子图
- 测试从子图移除成员资源
- 测试搜索和过滤功能
- 测试权限控制（Owner、Viewer）
- **测试子图嵌套**：子图 A 包含子图 B
- **测试循环引用检测**：子图 A 包含 B，B 尝试包含 A 应被禁止
- **测试多层嵌套**：A 包含 B，B 包含 C，验证递归查询

### 性能测试
- 测试大量子图的列表加载性能
- 测试包含大量成员的子图详情页加载性能
- 测试子图拓扑图的渲染性能
- 测试深层嵌套子图的展开性能

### 安全测试
- 测试未授权用户无法编辑/删除子图
- 测试未授权用户无法添加/移除成员资源
- 测试审计日志记录完整性

### 集成测试
- 测试子图与资源管理的集成（复用资源 CRUD API）
- 测试子图拓扑图与全局拓扑图的一致性
- 测试删除子图后成员资源不受影响
- 测试删除成员资源后自动从子图中移除（CASCADE）

## 相关文档

- 需求文档: `doc/intent/blueprint.md` - 2.1 资源管理
- Feature List: `doc/intent/feature-list.md`

---

**创建日期**: 2024-12-04
**最后更新**: 2025-12-22
**文档版本**: v2.0

## 变更记录

| 版本 | 日期 | 变更说明 |
|-----|------|---------|
| v1.0 | 2024-12-04 | 初始版本 |
| v2.0 | 2025-12-22 | 重构：子图作为资源类型的一种进行管理，支持子图嵌套 |
