---
inclusion: manual
---

# 通用最佳实践

本文档定义了所有 Spec 开发阶段 **MUST** 遵守的通用原则和最佳实践。

---

## Phase -1: 前置检查 (NON-NEGOTIABLE)

*GATE: 每次开始任何阶段工作前，必须通过以下检查。*

### 上下文检查
- [ ] 已阅读相关需求/设计文档？
- [ ] 已确认当前所处阶段？
- [ ] 已识别不确定的问题？

### 语言规范检查
- [ ] 所有输出使用中文？
- [ ] 技术术语保留英文（API、JSON、Maven 等）？

**If 检查未通过**: STOP，先补充缺失的上下文信息。

---

## 语言使用规范

### 强制要求 (MUST)

| 场景 | 语言 | 示例 |
|------|------|------|
| 对话交流 | 中文 | ✅ "我建议使用分层架构" |
| 文档编写 | 中文 | ✅ "需求：用户登录功能" |
| 代码注释 | 中文 | ✅ `// 验证用户密码` |
| 代码本身 | 英文 | ✅ `validatePassword()` |
| 技术术语 | 英文 | ✅ API、JSON、Maven |
| EARS 关键字 | 英文大写 | ✅ THE、SHALL、WHEN |

### 正确示例 vs 错误示例

✅ **正确**：
```
用户可以通过 REST API 提交订单，System SHALL 在 2 秒内响应。
```

❌ **错误**：
```
User can submit order via REST API, 系统 shall respond within 2s.
```

---

## 核心理念

**为什么需要这些实践**：LLM 是概率模型，单次生成可能存在偏差。通过渐进式开发、多次验证和持续反馈，可以显著提高输出质量，降低返工成本（修复成本是早期发现的 10-20 倍）。

---

## 三大核心原则 (NON-NEGOTIABLE)

### 1. 渐进式开发

**关键理念**：分阶段推进，每个阶段 **MUST** 验证通过后再进入下一阶段。

**工作流程**：
```
需求 → 验证 ✓ → 设计 → 验证 ✓ → 任务拆分 → 验证 ✓ → 执行
       ↑                ↑                    ↑
    GATE 1           GATE 2              GATE 3
```

**门控检查 (GATE)**：
| Gate | 检查点 | 通过条件 |
|------|--------|----------|
| GATE 1 | 需求完成 | 用户确认理解正确 |
| GATE 2 | 设计完成 | 用户认可方案 |
| GATE 3 | 任务拆分 | 任务可执行、可验证 |

**ABSOLUTELY PROHIBITED**：
- ❌ 跳过任何 GATE
- ❌ 在未获得确认时进入下一阶段
- ❌ 一次性完成所有阶段

### 2. 持续验证

**关键理念**：每个阶段完成后 **MUST** 进行多维度验证。

**验证矩阵**：

| 维度 | 检查问题 | 验证方法 |
|------|----------|----------|
| 一致性 | 与上一阶段输出是否一致？ | 逐项对照 |
| 完整性 | 是否完整覆盖要求？ | 需求追溯 |
| 准确性 | 理解和表述是否准确？ | 用户确认 |
| 合理性 | 是否存在过度设计？ | 简洁性检查 |

**验证闭环**：
```
完成输出 → 自检 → 交叉验证 → 用户确认 → 通过/重做
                                          ↓
                              max 3 次重试后升级
```

### 3. 主动沟通

**关键理念**：遇到不确定的情况，**MUST** 主动与用户沟通，**NEVER** 自行假设。

**必须确认的情况**：
| 场景 | 示例 | 处理方式 |
|------|------|----------|
| 需求歧义 | "快速响应"未量化 | 询问具体指标 |
| 多种方案 | JWT vs Session | 提供对比分析 |
| 过度设计 | 需求外的扩展 | 确认是否需要 |
| 粒度不确定 | 任务太大或太小 | 提供建议并确认 |

**沟通原则**：
- ✅ **透明**：及时报告进展和问题
- ✅ **具体**：清晰表达疑问和建议
- ✅ **尊重**：认真对待用户反馈
- ❌ **NEVER**：隐藏问题或风险

---

## 质量保证检查清单 (REQUIRED)

**每个阶段完成后 MUST 使用以下检查清单进行自检。If 未通过 → STOP 并修复。**

### 完整性检查 (权重: 30%)
- [ ] 是否覆盖了所有要求？（覆盖率 = 100%）
- [ ] 是否有遗漏的内容？
- [ ] 是否考虑了边界情况？（正常/异常/边界 ≥ 90%）

### 一致性检查 (权重: 25%)
- [ ] 与前序阶段的输出是否一致？
- [ ] 内部各部分之间是否一致？
- [ ] 术语使用是否统一？（不一致率 < 5%）

### 准确性检查 (权重: 25%)
- [ ] 对需求的理解是否准确？
- [ ] 技术方案的表述是否准确？
- [ ] 是否消除了所有模糊表述？

### 可行性检查 (权重: 15%)
- [ ] 设计是否可实施？
- [ ] 任务是否可执行（1-4小时粒度）？
- [ ] 验证标准是否可操作？

### 合理性检查 (权重: 5%)
- [ ] 是否存在过度设计？（需求外功能 = 0）
- [ ] 是否有不必要的复杂性？
- [ ] 是否符合项目约束？

**质量评分标准**：
| 等级 | 分数 | 状态 |
|------|------|------|
| 优秀 | ≥ 90 | ✅ 可进入下一阶段 |
| 良好 | ≥ 80 | ⚠️ 建议改进 |
| 合格 | ≥ 70 | ⚠️ 必须改进 |
| 不合格 | < 70 | ❌ 必须大幅改进 |

---

## 文档编写标准 (MUST)

**高质量的文档是成功的基础。所有 Spec 文档 MUST 遵循以下标准。**

### 清晰性要求

| 要求 | ✅ 正确 | ❌ 错误 |
|------|---------|---------|
| 简洁语言 | "响应时间 < 2秒" | "响应要快" |
| 消除歧义 | "最多支持 1000 并发" | "支持大量并发" |
| 上下文完整 | "基于 JWT 的用户认证" | "认证功能" |
| 具体示例 | 提供输入输出示例 | 只有抽象描述 |

### 结构化要求

**层级结构规范**：
```markdown
# 一级标题（文档名）
## 二级标题（主要章节）
### 三级标题（子章节）
#### 四级标题（细节，max 4 级）
```

**表格格式规范**：
- 使用一致的管道符间距：`| Content |` 不是 `|Content|`
- 表头分隔符至少 3 个破折号：`|--------|`
- 优先使用表格展示对比信息

### 可追溯性要求

**MUST 包含的追溯信息**：
- `_需求: REQ-001, REQ-002_` - 关联需求
- `_设计: ADR-001_` - 关联决策
- `_依赖: Task-003_` - 关联任务

---

## 常见陷阱与应对 (CRITICAL)

**了解常见陷阱，可以帮助你避免重复犯错。返工成本是早期发现的 10-20 倍。**

### 陷阱矩阵

| 陷阱 | 表现 | 后果 | 应对策略 |
|------|------|------|----------|
| **过早优化** | 需求不明确就开始设计 | 基于错误假设，大量返工 | 严格遵循 GATE 检查 |
| **过度设计** | 实现当前不需要的功能 | 增加复杂性，延长开发时间 | YAGNI 原则 |
| **忽视验证** | 跳过验证环节 | 问题累积，修复成本指数增长 | 强制使用检查清单 |
| **沟通不足** | 自行假设用户意图 | 理解偏差，交付物不符预期 | 主动确认制度 |

### 陷阱 1：过早优化

**触发信号**：
- ❌ 在需求不明确时就开始设计
- ❌ 在设计不完整时就开始编码
- ❌ 跳过 GATE 检查

**MUST 遵守**：
```
If 需求未确认 → STOP，不要开始设计
If 设计未确认 → STOP，不要开始编码
```

### 陷阱 2：过度设计

**触发信号**：
- ❌ 为"未来可能的需求"设计复杂架构
- ❌ 实现需求文档未提及的功能
- ❌ 使用 ≥ 3 层抽象

**MUST 遵守**：
- 只实现当前需要的功能
- 需求外功能数 = 0
- 简单实现优先，用证据驱动复杂度

### 陷阱 3：忽视验证

**触发信号**：
- ❌ 跳过验证环节
- ❌ 假设一切正确
- ❌ 未使用检查清单

**MUST 遵守**：
- 每个阶段 MUST 验证（max 3 次重试）
- 使用检查清单逐项确认
- If 验证失败 → STOP 并修复

### 陷阱 4：沟通不足

**触发信号**：
- ❌ 自行假设用户意图
- ❌ 隐藏问题和风险
- ❌ 超过 2 个不确定点未确认

**MUST 遵守**：
- 不确定 → 立即询问（max 5 个问题/轮）
- 风险 → 立即报告
- 关键决策 → MUST 用户确认

---

## 效率提升策略

### 投资回报分析

| 阶段 | 投入 | 回报 |
|------|------|------|
| 需求验证 | 1 小时 | 节省 10-20 小时返工 |
| 设计验证 | 2 小时 | 节省 20-40 小时重构 |
| 任务验证 | 30 分钟 | 避免方向错误 |

### 高效策略清单

| 策略 | 做法 | 收益 |
|------|------|------|
| 前期投入 | 充分验证再进入下一阶段 | 降低返工成本 70-80% |
| 复用模式 | 使用成熟的设计模式和架构 | 减少设计时间 50% |
| 自动化 | 使用自动化测试和 CI | 及早发现问题 |

---

## 风险管理

### 风险分类

| 类型 | 示例 | 识别时机 | 应对 |
|------|------|----------|------|
| 技术风险 | 性能瓶颈、技术选型 | 设计阶段 | POC 验证、备选方案 |
| 需求风险 | 需求变更、范围蔓延 | 需求阶段 | 变更控制流程 |
| 进度风险 | 估算偏差、依赖阻塞 | 任务阶段 | 缓冲时间、关键路径 |

### 风险处理流程

```
识别风险 → 评估(概率×影响) → 制定应对 → 监控 → 触发时执行
                              ↓
                    高风险 → MUST 备选方案
                    中风险 → SHOULD 监控
                    低风险 → 接受
```

---

## 持续改进

### 改进循环

```
执行 → 回顾 → 总结 → 更新实践 → 应用 → 执行
              ↓
        记录: 成功经验 / 失败教训
```

### 习惯养成清单

- [ ] 每个阶段结束时进行验证？
- [ ] 遇到不确定时主动沟通？
- [ ] 重要决策时记录 ADR？
- [ ] 定期回顾和总结？

---

## 总结

### 核心收益

| 实践 | 收益 |
|------|------|
| 渐进式开发 | 降低返工成本 70-80% |
| 持续验证 | 及早发现问题 |
| 主动沟通 | 避免理解偏差 |

### 黄金法则

```
┌─────────────────────────────────────────────────────────┐
│                    三大支柱 (NON-NEGOTIABLE)             │
│                                                          │
│   渐进式开发    +    持续验证    +    主动沟通           │
│       ↓                 ↓                 ↓              │
│   分阶段推进       每阶段检查        不假设、多确认       │
└─────────────────────────────────────────────────────────┘
```

**Remember**: If 不确定 → 问；If 未验证 → STOP；If 未确认 → 不进入下一阶段。
