# 设计澄清文档

**项目名称**: 用户名密码登录  
**文档版本**: v1.0.0  
**创建日期**: 2025-01-23  
**最后更新**: 2025-01-23  
**文档状态**: 进行中

---

## 1. 文档目的

本文档记录在设计阶段与用户的所有澄清和决策，确保设计方案符合用户预期，避免后续返工。

---

## 2. 需求理解阶段澄清

### 2.1 管理员权限分配方式

**问题**：需求中定义了普通用户（ROLE-001）和管理员（ROLE-002），但没有说明如何分配管理员权限。

**澄清结果**：
- ✅ **管理员通过数据库手动分配**
- 不在本系统功能范围内
- 管理员可以直接修改数据库 `account` 表的 `role` 字段

**影响**：
- 注册功能仅分配普通用户权限（ROLE_USER）
- 不需要实现"首个用户自动成为管理员"逻辑
- 不需要实现"管理员分配权限"的管理界面

---

### 2.2 审计日志查询功能

**问题**：需求提到管理员可以"查看审计日志"，但没有具体说明查询功能的需求。

**澄清结果**：
- ✅ **当前版本不需要审计日志查询功能**
- 仅记录审计日志，不提供查询界面
- 查询功能留给后续版本

**影响**：
- 不需要实现审计日志查询 API
- 不需要实现审计日志管理界面
- 审计日志仅用于安全审计和问题追踪（通过日志文件或日志系统）

---

### 2.3 会话互斥的用户体验

**问题**：当用户在新设备登录导致旧设备会话失效时，旧设备显示"您的账号已在其他设备登录"。是否需要提供"强制登出其他设备"的选项？

**澄清结果**：
- ✅ **提供"强制登出其他设备"选项**
- 用户在旧设备看到提示后，可以选择强制登出其他设备并重新登录
- 或者用户可以选择仅提示，不自动登录

**影响**：
- 需要在前端提供"强制登出其他设备"按钮
- 需要在后端实现"强制登出其他设备"API
- 会话互斥逻辑需要支持用户主动触发

---

### 2.4 弱密码验证方式

**问题**：需求提到验证"不是常见弱密码"，是否有预定义的弱密码列表？

**澄清结果**：
- ✅ **通过规则判断是否是弱密码**
- 不使用弱密码字典
- 规则包括：
  - 连续字符（如 "123456", "abcdef"）
  - 重复字符（如 "aaaaaa", "111111"）
  - 键盘序列（如 "qwerty", "asdfgh"）
  - 常见模式（如 "password", "admin"）

**影响**：
- 需要实现密码强度规则验证器
- 不需要维护弱密码字典
- 规则可以通过正则表达式或算法实现

---

## 3. 概要设计阶段澄清

### 3.1 模块划分简化

**问题**：初始设计中，Interface Layer 有 `AuthController` 和 `SessionController` 两个控制器，Application Layer 有多个应用服务。是否可以简化？

**澄清结果**：
- ✅ **每层合并成一个核心组件**
- Interface Layer：`AuthController`（统一的认证控制器）
- Application Layer：`AuthApplicationService`（统一的认证应用服务）
- Domain Layer：`AuthDomainService`（统一的认证领域服务）

**理由**：
- MVP 阶段，保持简洁更重要
- 避免过度设计
- 后续如果业务复杂度增加，再拆分

**影响**：
- 简化模块结构
- 减少类的数量
- 提高开发效率

---

### 3.2 审计日志存储方式

**问题**：审计日志是写入数据库还是仅记录到日志文件？

**澄清结果**：
- ✅ **审计日志暂时不用写入数据库**
- 仅记录到应用日志文件（使用 Logback）
- 使用结构化日志（JSON 格式）

**理由**：
- 简化 MVP 实现
- 减少数据库操作，提升性能
- 日志文件可以通过日志收集系统（如 ELK）集中管理
- 后续如果需要查询功能，再考虑写入数据库

**影响**：
- 移除 `AuditLog` 实体
- 移除 `AuditLogRepository`
- 移除 `audit_log` 数据库表
- 使用 Logback + Logstash Encoder 记录审计日志
- 审计日志格式：
  ```json
  {
    "timestamp": "2025-01-23T10:30:00.000Z",
    "event": "USER_LOGIN_SUCCESS",
    "userId": "123",
    "username": "john_doe",
    "ip": "192.168.1.100",
    "userAgent": "Mozilla/5.0...",
    "result": "success"
  }
  ```

---

### 3.3 异步日志记录方案

**问题**：初始设计提到"使用 Spring @Async 异步记录审计日志"，这是什么方案？

**澄清结果**：
- ✅ **使用 Logback AsyncAppender**
- 不使用 Spring @Async
- Logback 原生支持异步日志，配置简单，成熟稳定

**理由**：
- Logback AsyncAppender 是行业标准方案
- 无需额外代码，仅需配置 `logback-spring.xml`
- 不会丢失日志（有缓冲队列）
- 不阻塞主流程

**影响**：
- 不需要配置 Spring @Async 线程池
- 不需要在代码中使用 @Async 注解
- 仅需配置 Logback AsyncAppender

---

## 4. 设计决策总结

### 4.1 架构决策

| 决策点 | 决策结果 | 理由 |
|-------|---------|------|
| 架构模式 | DDD 分层架构（单体应用） | 符合现有架构，业务复杂度适中，开发效率高 |
| 模块划分 | 每层一个核心组件 | MVP 阶段保持简洁，避免过度设计 |
| 技术栈 | Spring Boot 3.4.1 + Spring Security 6.x | 项目已采用，成熟稳定 |

### 4.2 功能决策

| 决策点 | 决策结果 | 理由 |
|-------|---------|------|
| 管理员权限分配 | 数据库手动分配 | 不在本系统功能范围内 |
| 审计日志查询 | 当前版本不实现 | 简化 MVP，后续版本再实现 |
| 会话互斥体验 | 提供"强制登出其他设备"选项 | 提升用户体验 |
| 弱密码验证 | 通过规则判断 | 不使用弱密码字典，规则更灵活 |

### 4.3 技术决策

| 决策点 | 决策结果 | 理由 |
|-------|---------|------|
| 审计日志存储 | 仅记录到日志文件 | 简化 MVP，减少数据库操作 |
| 异步日志方案 | Logback AsyncAppender | 行业标准，配置简单，成熟稳定 |
| 密码加密 | BCrypt (Work Factor = 10) | 需求约束，行业标准 |
| 会话管理 | JWT Token + Redis | 无状态，高性能 |

---

## 5. 后续版本规划

基于当前澄清，以下功能留给后续版本：

1. **审计日志查询功能**
   - 按时间范围查询
   - 按用户名/IP查询
   - 按操作类型查询
   - 审计日志管理界面

2. **审计日志数据库存储**
   - 创建 `audit_log` 表
   - 实现 `AuditLogRepository`
   - 支持审计日志归档

3. **管理员权限管理**
   - 管理员分配权限界面
   - 角色管理功能

4. **密码管理增强**
   - 密码找回功能
   - 密码有效期
   - 历史密码检查

---

## 6. 风险和注意事项

### 6.1 审计日志仅存储在文件的风险

**风险**：
- 日志文件可能被删除或损坏
- 日志文件查询不便
- 日志文件占用磁盘空间

**缓解措施**：
- 使用日志收集系统（如 ELK）集中管理
- 定期备份日志文件
- 配置日志轮转策略（按大小或时间）
- 后续版本考虑写入数据库

### 6.2 弱密码规则验证的局限性

**风险**：
- 规则可能无法覆盖所有弱密码
- 规则可能误判强密码

**缓解措施**：
- 持续优化规则
- 收集用户反馈
- 后续版本考虑引入弱密码字典

---

## 7. 版本历史

| 版本 | 日期 | 修改内容 | 作者 |
|-----|------|---------|------|
| v1.0.0 | 2025-01-23 | 初始版本，记录需求理解和概要设计阶段的澄清 | AI Assistant |

---

**文档审核**：
- 架构师：AI Assistant
- 产品负责人：[待审核]
- 技术负责人：[待审核]
