<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.catface996.aiops.repository.mysql.mapper.topology.TopologyMapper">

    <sql id="Base_Column_List">
        id, name, description, status, attributes,
        created_by, created_at, updated_by, updated_at, version, deleted
    </sql>

    <!-- 分页查询拓扑图（带成员数量统计） -->
    <select id="selectPageWithMemberCount" resultType="com.catface996.aiops.repository.mysql.po.topology.TopologyPO">
        SELECT t.id, t.name, t.description, t.status, t.attributes,
               t.created_by, t.created_at, t.updated_by, t.updated_at, t.version, t.deleted,
               (SELECT COUNT(*) FROM topology_2_node t2n WHERE t2n.topology_id = t.id AND t2n.deleted = 0) AS member_count
        FROM topology t
        <where>
            t.deleted = 0
            <if test="name != null and name != ''">AND t.name LIKE CONCAT('%', #{name}, '%')</if>
            <if test="status != null and status != ''">AND t.status = #{status}</if>
        </where>
        ORDER BY t.created_at DESC
    </select>

    <!-- 根据ID查询拓扑图（带成员数量统计） -->
    <select id="selectByIdWithMemberCount" resultType="com.catface996.aiops.repository.mysql.po.topology.TopologyPO">
        SELECT t.id, t.name, t.description, t.status, t.attributes,
               t.created_by, t.created_at, t.updated_by, t.updated_at, t.version, t.deleted,
               (SELECT COUNT(*) FROM topology_2_node t2n WHERE t2n.topology_id = t.id AND t2n.deleted = 0) AS member_count
        FROM topology t
        WHERE t.id = #{id} AND t.deleted = 0
    </select>

    <!-- 根据名称查询拓扑图 -->
    <select id="selectByName" resultType="com.catface996.aiops.repository.mysql.po.topology.TopologyPO">
        SELECT <include refid="Base_Column_List"/>
        FROM topology
        WHERE name = #{name} AND deleted = 0
    </select>

    <!-- 根据条件统计拓扑图数量 -->
    <select id="countByCondition" resultType="long">
        SELECT COUNT(*)
        FROM topology
        <where>
            deleted = 0
            <if test="name != null and name != ''">AND name LIKE CONCAT('%', #{name}, '%')</if>
            <if test="status != null and status != ''">AND status = #{status}</if>
        </where>
    </select>

</mapper>
