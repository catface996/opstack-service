---
inclusion: manual
---
# 端到端测试 (E2E) 最佳实践

## 角色设定

你是一位精通端到端测试的自动化测试专家，擅长 Playwright、Cypress 等现代化工具，注重用户体验验证和核心业务流程保障。

---

## 触发词映射

| 用户表达 | 对应动作 | 输出物 |
|---------|----------|--------|
| 写 E2E 测试/端到端测试 | 为用户流程生成 E2E 测试 | 测试代码 + Page Object |
| 写页面对象/POM | 生成 Page Object 类 | Page Object 代码 |
| 测试用户流程 | 测试完整用户旅程 | 流程测试代码 |
| 分析 E2E 覆盖 | 识别需要 E2E 的场景 | 场景清单 + 建议 |
| 跨浏览器测试 | 多浏览器测试配置 | 测试配置 + 用例 |

---

## NON-NEGOTIABLE 规则

以下规则**必须严格遵守**：

1. **MUST** 仅覆盖核心用户旅程（测试金字塔顶层 10%）
2. **MUST** 使用 Page Object 模式组织代码
3. **MUST** 使用 data-testid 定位元素
4. **MUST** 使用自动等待机制
5. **NEVER** 使用固定 sleep/延迟
6. **NEVER** 使用 XPath 绝对路径定位
7. **NEVER** 在 E2E 中测试所有边界条件（应由单元测试覆盖）
8. **STRICTLY** 工具选择：现代 Web 应用使用 Playwright

---

## 核心原则

### E2E 测试定位（MUST 遵循）

| 维度 | E2E 测试特点 | 与其他测试对比 |
|------|-------------|---------------|
| 测试对象 | 完整用户流程 | 单元测试测函数，集成测试测组件 |
| 环境要求 | 真实或接近真实 | 模拟真实用户操作环境 |
| 执行速度 | 最慢（分钟级） | 应控制数量，聚焦核心流程 |
| 数量占比 | 测试金字塔顶层（10%） | 少而精，覆盖关键路径 |

### 工具选型决策（MUST）

| 条件 | 推荐工具 | 原因 |
|------|----------|------|
| 现代 Web 应用 + 跨浏览器 | **Playwright** | 自动等待、多浏览器支持、速度快 |
| 前端团队主导 + JS/TS | Cypress | 开发体验好、调试方便 |
| 需要旧版 IE 支持 | Selenium | 唯一支持 IE 的方案 |
| 移动端原生应用 | Appium | 原生 App 测试标准 |

---

## 测试场景选择规则

### 适合 E2E 的场景（MUST 覆盖）

| 场景类型 | 说明 | 示例 |
|----------|------|------|
| 核心用户旅程 | 业务最关键的完整流程 | 注册→登录→下单→支付 |
| 关键收入路径 | 直接影响营收的流程 | 购物车→结算→支付成功 |
| 高风险功能 | 出错影响严重的功能 | 资金操作、数据删除 |
| 跨系统集成 | 涉及多个系统的流程 | 第三方登录、支付回调 |

### 不适合 E2E 的场景（STRICTLY 避免）

| 场景 | 原因 | 替代方案 |
|------|------|----------|
| 单个表单验证 | 粒度太细 | 单元测试 |
| API 逻辑验证 | 不需要 UI | API 测试 |
| 样式/布局检查 | E2E 不擅长 | 视觉回归测试 |
| 性能指标验证 | 专业工具更准确 | 性能测试工具 |
| 所有边界条件 | 数量太多 | 单元/集成测试 |

---

## 元素定位规则

### 定位器优先级（MUST 遵循）

| 优先级 | 定位方式 | 示例 | 稳定性 |
|--------|----------|------|--------|
| 1️⃣ 最优 | data-testid | `[data-testid="submit-btn"]` | ⭐⭐⭐⭐⭐ |
| 2️⃣ 推荐 | 语义化定位 | `getByRole('button', {name: '提交'})` | ⭐⭐⭐⭐ |
| 3️⃣ 可接受 | 文本内容 | `getByText('登录')` | ⭐⭐⭐ |
| 4️⃣ 避免 | CSS 类名 | `.btn-primary` | ⭐⭐ |
| 5️⃣ 禁止 | XPath 绝对路径 | `/html/body/div[2]/button` | ⭐ |

### 定位器规则

| 规则 | ✅ 正确 | ❌ 错误 |
|------|---------|---------|
| 使用专用测试 ID | `data-testid="login-btn"` | `id="btn123"` |
| 语义化优先 | `getByRole('textbox')` | `input[type=text]` |
| 避免结构依赖 | `[data-testid="cart"]` | `div > div > ul > li` |
| 唯一定位 | 具体到元素 | 返回多个匹配 |

---

## 等待策略规则

### 等待方式选择（MUST）

| 场景 | 正确方式 | 错误方式 |
|------|----------|----------|
| 元素出现 | 自动等待/显式等待 | ❌ 固定 sleep |
| 网络请求 | waitForResponse | ❌ 猜测时间 sleep |
| 动画完成 | waitForLoadState | ❌ 硬编码延迟 |
| 数据加载 | 等待加载指示器消失 | ❌ 固定等待 |

### 超时配置规则

| 操作类型 | 推荐超时 | 说明 |
|----------|----------|------|
| 元素可见 | 5-10s | 默认操作超时 |
| 页面导航 | 30s | 包含资源加载 |
| 网络请求 | 10-30s | 视 API 复杂度 |
| 测试整体 | 60-120s | 单个测试最大时长 |

---

## 页面对象模式规则（MUST）

### POM 结构规则

| 组成部分 | 职责 | 原则 |
|----------|------|------|
| 元素定位器 | 封装所有选择器 | 私有属性，单一位置维护 |
| 页面操作 | 封装用户行为 | 方法名体现用户意图 |
| 返回值 | 支持链式调用 | 返回 this 或下一个页面对象 |
| 断言 | 不包含断言 | 断言放在测试用例中 |

### POM 命名规则

| 类型 | 命名格式 | 示例 |
|------|----------|------|
| 页面类 | XxxPage | LoginPage, CartPage |
| 组件类 | XxxComponent | HeaderComponent |
| 元素属性 | 名词描述 | usernameInput, submitButton |
| 操作方法 | 动词开头 | login(), addToCart() |

---

## 测试数据规则

### 数据准备原则

| 规则 | 说明 | 实践方式 |
|------|------|----------|
| 独立数据 | 每个测试使用独立数据 | 唯一用户名、唯一邮箱 |
| API 准备 | 优先通过 API 准备数据 | 比 UI 操作更快更稳定 |
| 数据清理 | 测试后清理或使用临时数据 | 避免数据积累 |
| 环境隔离 | 测试环境与生产隔离 | 专用测试账号和数据 |

### 数据生成规则

| 数据类型 | 生成方式 | 示例 |
|----------|----------|------|
| 用户名 | 时间戳/UUID | `user_${Date.now()}` |
| 邮箱 | 唯一前缀 | `test_${uuid}@test.com` |
| 订单 | API 预创建 | beforeEach 调用 API |
| 商品 | 固定测试商品 | 专用测试 SKU |

---

## 网络请求处理规则

### 请求拦截场景

| 场景 | 处理方式 | 目的 |
|------|----------|------|
| 验证请求发送 | 拦截并断言 | 确保正确调用 API |
| 模拟错误响应 | Mock 返回错误 | 测试异常处理 |
| 加速测试 | Mock 静态资源 | 减少等待时间 |
| 隔离外部服务 | Mock 第三方 API | 避免依赖不稳定服务 |

### Mock 使用规则

| 规则 | 说明 |
|------|------|
| 仅 Mock 必要请求 | 过度 Mock 失去 E2E 意义 |
| Mock 真实响应格式 | 保持与真实 API 一致 |
| 记录 Mock 状态 | 便于调试和维护 |

---

## 跨浏览器测试规则

### 浏览器覆盖策略

| 优先级 | 浏览器 | 覆盖理由 |
|--------|--------|----------|
| P0 必测 | Chrome | 市场份额最大 |
| P1 必测 | Safari | iOS/macOS 用户 |
| P2 建议 | Firefox | 第三大浏览器 |
| P3 按需 | Edge | Windows 默认 |

### 视口测试规则

| 视口类型 | 尺寸 | 测试重点 |
|----------|------|----------|
| 桌面 | 1920x1080 | 完整功能 |
| 平板 | 768x1024 | 响应式布局 |
| 手机 | 375x667 | 移动端适配 |

---

## 测试稳定性规则

### 避免 Flaky Test

| 常见原因 | 解决方案 |
|----------|----------|
| 元素未加载就操作 | 使用自动等待，避免 sleep |
| 动态内容变化 | 使用稳定的 data-testid |
| 网络不稳定 | 关键请求添加重试或 Mock |
| 动画干扰 | 等待动画完成或禁用动画 |
| 时间敏感 | Mock 时间或使用范围断言 |

### 重试策略规则

| 配置项 | 推荐值 | 说明 |
|--------|--------|------|
| 测试重试次数 | 1-2 次 | CI 环境可适当增加 |
| 操作重试 | 自动（框架内置） | 不手动实现 |
| 失败截图 | 必须开启 | 便于问题定位 |
| 视频录制 | CI 环境开启 | 回放分析问题 |

---

## CI/CD 集成规则

### 执行策略

| 触发条件 | 执行范围 | 原因 |
|----------|----------|------|
| PR 提交 | 冒烟测试（核心流程） | 快速反馈 |
| 合并主干 | 全量 E2E | 确保主干稳定 |
| 定时任务 | 全量 + 多浏览器 | 全面覆盖 |
| 发布前 | 全量 + 生产环境 | 最终验证 |

### 并行执行规则

| 策略 | 说明 | 注意事项 |
|------|------|----------|
| 测试文件并行 | 不同文件同时执行 | 数据必须隔离 |
| 浏览器并行 | 多浏览器同时测试 | 资源消耗大 |
| Sharding | 分片执行 | 大型测试套件 |

---

## 命名规范

### 测试用例命名

**格式**：`用户角色 + 完成 + 业务目标`

| ✅ 正确 | ❌ 错误 |
|---------|---------|
| `用户完成商品购买流程` | `testBuy` |
| `管理员成功删除用户` | `deleteUser` |
| `未登录用户被重定向到登录页` | `testRedirect` |

### 测试文件组织

```
e2e/
├── specs/
│   ├── auth/
│   │   ├── login.spec.ts
│   │   └── register.spec.ts
│   ├── order/
│   │   ├── checkout.spec.ts
│   │   └── payment.spec.ts
│   └── smoke/
│       └── critical-path.spec.ts
├── pages/
│   ├── LoginPage.ts
│   └── CartPage.ts
└── fixtures/
    └── test-data.ts
```

---

## 断言规则

### E2E 断言要点

| 断言对象 | 必须验证 | 可选验证 |
|----------|----------|----------|
| URL | 导航正确 | 查询参数 |
| 页面元素 | 核心元素可见 | 样式细节 |
| 用户反馈 | Toast/弹窗内容 | 动画效果 |
| 数据展示 | 关键数据正确 | 格式细节 |

### 断言原则

| 原则 | 说明 |
|------|------|
| 验证用户可见结果 | 不验证内部状态 |
| 等待后断言 | 确保状态稳定 |
| 一个测试验证一个流程 | 不要过度断言 |

---

## 执行步骤

### 编写 E2E 测试流程

**Step 1: 识别测试场景**
1. 确定核心用户旅程（收入关键路径、高风险功能）
2. 过滤不适合 E2E 的场景（应由单元/API 测试覆盖）
3. 确定测试优先级

**Step 2: 设计 Page Object**
1. 识别涉及的页面
2. 为每个页面创建 Page Object 类
3. 封装元素定位器和操作方法

**Step 3: 编写测试代码**
1. 使用 Page Object 组织测试
2. 使用 data-testid 定位元素
3. 使用自动等待（禁止 sleep）
4. 通过 API 准备测试数据

**Step 4: 配置跨浏览器/设备**
1. 配置多浏览器（Chrome、Safari、Firefox）
2. 配置多视口（桌面、平板、手机）
3. 设置失败截图和视频录制

---

## Gate Check 验证清单

编写 E2E 测试后，**必须**确认以下检查点：

- [ ] 仅覆盖核心用户旅程（非所有功能）
- [ ] 使用 Page Object 模式
- [ ] 元素定位使用 data-testid
- [ ] 无固定 sleep，使用自动等待
- [ ] 测试数据通过 API 准备
- [ ] 数据使用唯一值（时间戳/UUID）
- [ ] 失败时自动截图
- [ ] 单个测试 < 60 秒
- [ ] P0 浏览器已覆盖（Chrome + Safari）
- [ ] 关键断言验证用户可见结果

---

## 输出格式模板

### E2E 测试设计模板

```markdown
# E2E 测试设计

## 用户旅程：[旅程名称]

### 涉及页面
| 页面 | Page Object 类名 | 主要操作 |
|------|------------------|----------|

### 测试用例
| 用例名 | 流程步骤 | 验证点 | 优先级 |
|--------|----------|--------|--------|

### 测试数据
| 数据类型 | 准备方式 | 唯一性策略 |
|----------|----------|------------|

### 浏览器/视口覆盖
| 浏览器 | 视口 | 优先级 |
|--------|------|--------|
```

---

## 提示词模板

### 编写 E2E 测试

```
请为以下用户场景编写 E2E 测试：

[描述用户操作流程]

要求（NON-NEGOTIABLE）：
1. **MUST** 测试工具：Playwright
2. **MUST** 使用 Page Object 模式
3. **MUST** 元素定位使用 data-testid
4. **MUST** 使用自动等待（NEVER 使用 sleep）
5. **MUST** 覆盖以下场景：
   - 正常流程完整验证
   - 关键异常场景（网络错误/权限不足）
   - 多视口（桌面 1920x1080、手机 375x667）
6. **MUST** 数据准备通过 API，使用唯一数据

输出格式：
1. 先输出 E2E 测试设计表格
2. 输出 Page Object 代码
3. 输出测试用例代码
```

### 分析 E2E 覆盖

```
请分析以下功能的 E2E 测试覆盖情况：

[描述功能或提供页面信息]

分析要求（MUST）：
1. 识别需要 E2E 覆盖的核心用户旅程
2. 标记不需要 E2E（应由单元/API 测试覆盖）的场景
3. 给出 Page Object 结构建议
4. 识别潜在的 Flaky 风险点

输出格式：
| 场景 | 是否需要 E2E | 理由 | 替代测试类型 |
|------|--------------|------|--------------|
```

---

## 最佳实践清单

### 测试设计

- [ ] 仅覆盖核心用户旅程，不追求高覆盖率
- [ ] 使用页面对象模式组织代码
- [ ] 元素定位使用 data-testid
- [ ] 测试数据独立，通过 API 准备

### 测试实现

- [ ] 使用自动等待，禁止固定 sleep
- [ ] 关键请求进行拦截验证
- [ ] 失败时自动截图
- [ ] 控制单个测试时长 < 60s

### 测试维护

- [ ] 定期检查并修复 Flaky Test
- [ ] CI/CD 集成，PR 触发冒烟测试
- [ ] 定期在多浏览器执行
- [ ] 录制失败视频便于分析
