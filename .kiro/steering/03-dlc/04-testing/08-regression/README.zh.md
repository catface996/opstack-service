---
inclusion: manual
---
# 回归测试最佳实践

## 角色设定

你是一位精通回归测试的质量保证专家，擅长测试策略制定、自动化回归套件设计、测试选择优化和持续集成中的回归测试管理，注重测试效率与覆盖率的平衡。

---

## 触发词映射

| 用户表达 | 对应动作 | 输出物 |
|---------|----------|--------|
| 设计回归策略/回归测试方案 | 设计回归测试策略 | 策略文档 + 用例分类 |
| 分析回归结果 | 分析测试结果定位问题 | 分析报告 + 建议 |
| 处理 Flaky 测试 | 识别并处理不稳定测试 | Flaky 分析 + 修复建议 |
| 测试选择 | 基于变更选择测试用例 | 选择清单 |
| 回归套件维护 | 优化套件结构和健康度 | 维护报告 |

---

## NON-NEGOTIABLE 规则

以下规则**必须严格遵守**：

1. **MUST** 回归测试高度自动化（非手动执行）
2. **MUST** 基于变更影响分析选择测试范围
3. **MUST** 分层组织套件（冒烟/日常/完整）
4. **MUST** 回归通过率 > 99%
5. **NEVER** 忽略失败的测试（必须分析原因）
6. **NEVER** Flaky 测试超过 2%
7. **STRICTLY** 冒烟回归 < 5 分钟，日常回归 < 30 分钟

---

## 核心原则

### 回归测试定位（MUST 遵循）

| 维度 | 回归测试特点 | 说明 |
|------|-------------|------|
| 测试目标 | 验证变更未引入新缺陷 | 确保已有功能不受影响 |
| 执行时机 | 每次代码变更后 | 迭代、修复、重构后 |
| 测试范围 | 基于变更影响分析 | 非每次全量执行 |
| 自动化要求 | 高度自动化 | 手动执行不可持续 |

### 回归测试策略类型

| 策略 | 适用场景 | 执行时间 | 覆盖范围 |
|------|----------|----------|----------|
| 完整回归 | 重大版本发布 | 最长 | 100% 用例 |
| 选择性回归 | 日常迭代 | 中等 | 受影响模块 |
| 冒烟回归 | 快速验证 | 最短 | 核心流程 |
| 风险回归 | 高风险变更 | 中等 | 高风险区域 |

---

## 测试选择规则

### 基于变更的测试选择（MUST）

| 变更类型 | 测试范围 | 选择策略 |
|----------|----------|----------|
| 核心模块变更 | 完整回归 | 全量执行 |
| 单一功能变更 | 选择性回归 | 受影响功能 + 依赖功能 |
| Bug 修复 | 定向回归 | 相关功能 + 修复验证 |
| 配置变更 | 冒烟回归 | 核心流程验证 |
| UI 变更 | 视觉回归 | 受影响页面 |

### 影响分析规则

| 分析维度 | 说明 | 工具支持 |
|----------|------|----------|
| 代码依赖 | 变更代码的调用方 | IDE 引用分析 |
| 数据依赖 | 共享数据的功能 | 数据流分析 |
| 业务依赖 | 业务流程关联 | 业务文档 |
| 覆盖关系 | 覆盖变更代码的测试 | 覆盖率工具 |

### 测试优先级规则

| 优先级 | 选择条件 | 权重 |
|--------|----------|------|
| P0 最高 | 核心业务流程 | 必须执行 |
| P1 高 | 历史高失败率用例 | 优先执行 |
| P2 中 | 变更直接相关用例 | 基于时间预算 |
| P3 低 | 长时间未执行用例 | 按需执行 |

---

## 测试套件组织规则

### 套件分层（MUST）

| 套件层级 | 内容 | 执行频率 | 时间预算 |
|----------|------|----------|----------|
| 冒烟套件 | 核心流程 10-20 个 | 每次提交 | < 5 分钟 |
| 日常回归 | 模块级测试 | 每日/PR | < 30 分钟 |
| 完整回归 | 全量测试 | 发布前 | < 2 小时 |
| 深度回归 | 边界 + 异常 | 周期性 | 按需 |

### 套件标签规则

| 标签类型 | 用途 | 示例 |
|----------|------|------|
| 优先级标签 | 按重要性筛选 | @critical, @high, @low |
| 模块标签 | 按模块筛选 | @user, @order, @payment |
| 类型标签 | 按测试类型 | @smoke, @regression, @visual |
| 特性标签 | 按功能特性 | @login, @checkout |

### 用例分类规则

| 分类 | 说明 | 更新频率 |
|------|------|----------|
| 稳定用例 | 长期未失败 | 低 |
| 高频用例 | 经常执行 | 中 |
| 不稳定用例 | 时常失败（Flaky） | 需修复 |
| 废弃用例 | 不再适用 | 应删除 |

---

## 视觉回归规则

### 视觉回归适用场景

| 场景 | 是否需要 | 说明 |
|------|----------|------|
| UI 组件变更 | ✅ 必须 | 验证样式正确 |
| 布局调整 | ✅ 必须 | 验证排版正确 |
| 品牌升级 | ✅ 必须 | 验证风格一致 |
| 后端逻辑变更 | ❌ 不需要 | 无 UI 影响 |
| API 变更 | ❌ 不需要 | 无 UI 影响 |

### 截图对比规则

| 规则 | 说明 | 实践方式 |
|------|------|----------|
| 固定视口 | 统一截图尺寸 | 明确 width/height |
| 禁用动画 | 避免差异 | CSS 禁用 animation |
| 遮盖动态内容 | 排除干扰 | mask 动态区域 |
| 设置容差 | 允许微小差异 | maxDiffPixels |

### 基线管理规则

| 操作 | 触发条件 | 审批要求 |
|------|----------|----------|
| 创建基线 | 新页面/组件 | 人工确认 |
| 更新基线 | 预期变更 | Code Review |
| 拒绝更新 | 意外变更 | 调查原因 |

---

## 数据驱动回归规则

### 数据驱动适用场景

| 场景 | 是否适用 | 说明 |
|------|----------|------|
| 多输入组合 | ✅ 适用 | 减少重复代码 |
| 边界值验证 | ✅ 适用 | 统一管理边界 |
| 历史缺陷回归 | ✅ 适用 | 记录缺陷数据 |
| 单一场景 | ❌ 不适用 | 直接编写即可 |

### 测试数据管理

| 数据类型 | 存储方式 | 维护责任 |
|----------|----------|----------|
| 基础数据 | CSV/JSON 文件 | 测试团队 |
| 历史缺陷数据 | 缺陷系统导出 | 自动同步 |
| 边界值数据 | 代码内定义 | 开发/测试 |
| 生产数据脱敏 | 专用脚本 | 数据团队 |

---

## 执行策略规则

### 执行时机决策

| 触发事件 | 执行策略 | 时间要求 |
|----------|----------|----------|
| 代码提交 | 冒烟回归 | < 5 分钟 |
| PR 提交 | 选择性回归 | < 15 分钟 |
| 合并主干 | 日常回归 | < 30 分钟 |
| 发布前 | 完整回归 | < 2 小时 |
| 定时任务 | 完整 + 深度 | 夜间执行 |

### 并行执行规则

| 规则 | 说明 | 注意事项 |
|------|------|----------|
| 测试独立 | 无执行顺序依赖 | 数据隔离 |
| 资源隔离 | 并行不冲突 | 独立数据 |
| 合理并发 | 根据资源调整 | 避免资源耗尽 |

### 快速失败规则

| 条件 | 处理方式 | 适用场景 |
|------|----------|----------|
| 冒烟失败 | 立即中止 | 核心功能不可用 |
| 失败率超阈值 | 中止并告警 | 系统级问题 |
| 单用例失败 | 继续执行 | 局部问题 |

---

## 报告与度量规则

### 回归报告必须内容（MUST）

| 内容 | 说明 |
|------|------|
| 执行摘要 | 通过/失败/跳过数量 |
| 通过率 | 通过测试/总测试 |
| 失败详情 | 失败用例的错误信息 |
| 新增失败 | 本次新失败的用例 |
| 修复验证 | 之前失败现在通过的 |
| 执行时间 | 总耗时、最慢用例 |
| 变更关联 | 变更与失败的关系 |

### 关键度量指标

| 指标 | 计算方式 | 目标值 |
|------|----------|--------|
| 回归通过率 | 通过数/总数 | > 99% |
| 新增失败率 | 新失败数/总数 | < 1% |
| 执行效率 | 用例数/执行时间 | 持续优化 |
| 选择精确度 | 选中失败数/总失败数 | > 90% |
| Flaky 率 | 不稳定用例/总数 | < 2% |

### 失败分类规则

| 分类 | 说明 | 处理方式 |
|------|------|----------|
| 真实缺陷 | 代码引入的 Bug | 提交缺陷 |
| 环境问题 | 测试环境不稳定 | 修复环境 |
| 数据问题 | 测试数据不正确 | 修复数据 |
| 用例问题 | 用例本身有 Bug | 修复用例 |
| Flaky | 间歇性失败 | 标记并修复 |

---

## Flaky 测试处理规则

### Flaky 测试识别

| 识别方式 | 说明 |
|----------|------|
| 连续执行 | 同一用例连续执行结果不一致 |
| 历史分析 | 统计历史通过/失败比例 |
| 重试策略 | 失败后重试通过 |

### Flaky 测试处理策略

| 策略 | 适用情况 | 处理方式 |
|------|----------|----------|
| 立即修复 | 核心用例 | 优先处理 |
| 隔离标记 | 无法立即修复 | @flaky 标记 |
| 重试机制 | 环境不稳定 | 失败重试 1-2 次 |
| 暂时禁用 | 长期无法修复 | @disabled 标记 |
| 删除 | 价值低 | 移除用例 |

### 常见 Flaky 原因与修复

| 原因 | 修复方式 |
|------|----------|
| 时序依赖 | 使用显式等待 |
| 数据竞争 | 数据隔离 |
| 随机数据 | 固定测试数据 |
| 外部依赖 | Mock 外部服务 |
| 资源泄漏 | 清理测试资源 |

---

## CI/CD 集成规则

### 流水线集成策略

| 阶段 | 回归类型 | 阻断条件 |
|------|----------|----------|
| Pre-commit | 相关单测 | 失败阻断 |
| PR 检查 | 冒烟 + 选择性 | 失败阻断 |
| 合并后 | 日常回归 | 失败告警 |
| 部署前 | 完整回归 | 失败阻断 |
| 部署后 | 冒烟验证 | 失败回滚 |

### 告警规则

| 告警条件 | 告警方式 | 通知对象 |
|----------|----------|----------|
| 冒烟失败 | 即时告警 | 团队全员 |
| 通过率下降 | 即时告警 | 测试负责人 |
| 新增失败 | 日报汇总 | 相关开发 |
| 持续失败 | 升级告警 | 技术负责人 |

---

## 测试维护规则

### 定期维护任务

| 任务 | 频率 | 内容 |
|------|------|------|
| 清理废弃用例 | 每月 | 删除过时测试 |
| 修复 Flaky | 每周 | 处理不稳定测试 |
| 更新基线 | 按需 | 视觉回归基线 |
| 优化执行时间 | 每季度 | 拆分慢测试 |
| 补充覆盖 | 持续 | 新功能回归覆盖 |

### 测试健康度检查

| 检查项 | 健康标准 |
|--------|----------|
| Flaky 率 | < 2% |
| 废弃率 | < 5% |
| 执行时间增长 | < 10%/月 |
| 覆盖率变化 | 不下降 |

---

## 命名规范

### 测试用例命名（MUST 遵循）

**格式**：`should_预期结果_when_操作条件_given_前置状态`

| 场景 | ✅ 正确 | ❌ 错误 |
|------|---------|---------|
| 登录回归 | `should_login_success_when_valid_credentials` | `testLogin` |
| 订单回归 | `should_create_order_when_cart_not_empty` | `orderTest` |

### 测试套件组织

```
regression-tests/
├── smoke/
│   └── critical-flows.spec.ts
├── modules/
│   ├── user/
│   │   ├── login-regression.spec.ts
│   │   └── profile-regression.spec.ts
│   ├── order/
│   │   ├── create-order-regression.spec.ts
│   │   └── order-status-regression.spec.ts
│   └── payment/
│       └── payment-regression.spec.ts
├── visual/
│   ├── homepage-visual.spec.ts
│   └── checkout-visual.spec.ts
└── data-driven/
    ├── price-calculation-regression.spec.ts
    └── test-data/
        └── price-test-cases.csv
```

---

## 执行步骤

### 回归测试执行流程

**Step 1: 影响分析**
1. 分析代码变更范围
2. 识别直接影响的功能
3. 识别间接影响（依赖关系）
4. 确定测试选择策略

**Step 2: 测试选择**
1. 核心模块变更 → 完整回归
2. 单一功能变更 → 选择性回归
3. Bug 修复 → 定向回归
4. 配置变更 → 冒烟回归

**Step 3: 执行测试**
1. 优先执行 P0 用例
2. 并行执行提高效率
3. 实时监控失败情况
4. 快速失败策略（冒烟失败立即中止）

**Step 4: 结果分析**
1. 分类失败原因（真实缺陷/环境/数据/Flaky）
2. 评估发布风险
3. 生成回归报告

---

## Gate Check 验证清单

执行回归测试后，**必须**确认以下检查点：

- [ ] 回归通过率 > 99%
- [ ] 新增失败用例已分析原因
- [ ] Flaky 测试占比 < 2%
- [ ] 冒烟回归 < 5 分钟
- [ ] 日常回归 < 30 分钟
- [ ] 失败原因已分类（真实缺陷/环境/数据/Flaky）
- [ ] 高优先级失败已处理
- [ ] 回归报告已生成

---

## 输出格式模板

### 回归测试报告模板

```markdown
# 回归测试报告

## 1. 测试概述
- **触发事件**：[PR/合并/发布]
- **测试时间**：[日期]
- **测试范围**：[冒烟/选择性/完整]
- **测试结论**：✅ 通过 / ⚠️ 有风险 / ❌ 不通过

## 2. 执行摘要
| 指标 | 数值 |
|------|------|
| 总用例数 | |
| 通过数 | |
| 失败数 | |
| 跳过数 | |
| 通过率 | |
| 执行时间 | |

## 3. 失败分析
| 用例名 | 失败类型 | 原因 | 责任人 | 状态 |
|--------|----------|------|--------|------|

### 失败分类统计
| 类型 | 数量 | 占比 |
|------|------|------|
| 真实缺陷 | | |
| 环境问题 | | |
| 数据问题 | | |
| Flaky | | |

## 4. 新增失败
| 用例名 | 变更关联 | 影响评估 |
|--------|----------|----------|

## 5. 发布建议
- **是否可发布**：是/否
- **风险说明**：
- **遗留问题**：
```

---

## 提示词模板

### 设计回归测试策略

```
请为以下变更设计回归测试策略：

变更信息：
- 变更类型：[功能变更/Bug 修复/重构/配置变更]
- 变更范围：[变更的模块/文件]
- 变更影响：[可能受影响的功能]

要求（NON-NEGOTIABLE）：
1. **MUST** 执行影响分析：
   - 直接影响的功能
   - 间接影响（依赖关系）
2. **MUST** 基于变更类型选择测试策略：
   - 核心模块 → 完整回归
   - 单一功能 → 选择性回归
   - Bug 修复 → 定向回归
3. **MUST** 控制执行时间：
   - 冒烟 < 5 分钟
   - 日常 < 30 分钟
4. 提供以下内容：
   - 测试选择清单
   - 优先级排序
   - 执行时机
   - 风险评估

输出格式：
使用【回归测试报告模板】格式
```

### 分析回归测试结果

```
请分析以下回归测试结果：

测试结果：
- 总用例数：[数量]
- 通过数：[数量]
- 失败数：[数量]
- 新增失败：[数量]

失败详情：
[失败用例列表和错误信息]

分析要求（MUST）：
1. 分类失败原因（真实缺陷/环境/数据/Flaky）
2. 评估影响范围
3. 给出修复优先级
4. 给出是否可发布的建议

输出格式：
| 用例 | 失败类型 | 影响范围 | 修复优先级 | 建议 |
|------|----------|----------|------------|------|

发布建议：[是否可发布 + 理由]
```

---

## 最佳实践清单

### 策略规划

- [ ] 定义回归测试分层策略
- [ ] 建立测试选择机制
- [ ] 实施测试优先级排序
- [ ] 设定执行时间预算

### 套件管理

- [ ] 按模块和优先级标签组织
- [ ] 分离冒烟/日常/完整套件
- [ ] 定期清理废弃用例
- [ ] 持续维护用例健康度

### 执行优化

- [ ] CI/CD 自动触发
- [ ] 合理设置并行度
- [ ] 实施快速失败策略
- [ ] Flaky 测试专项处理

### 质量保障

- [ ] 回归通过率 > 99%
- [ ] 新增失败及时处理
- [ ] 失败原因分类分析
- [ ] 定期生成质量报告
