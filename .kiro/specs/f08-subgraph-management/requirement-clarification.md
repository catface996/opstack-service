# 需求澄清文档 - 子图管理

**功能名称**: F08-子图管理  
**创建日期**: 2024-12-04  
**需求分析师**: AI Assistant  
**状态**: 已澄清 ✅

---

## 1. 需求概述

### 1.1 核心需求（3-5 句话）

子图管理功能允许运维工程师创建和管理资源节点的逻辑分组（子图），以便按业务域或系统模块组织相关资源。每个子图具有全局唯一的名称，支持多个 Owner 管理，资源节点可以同时属于多个子图。子图提供独立的拓扑可视化视图，只显示子图内节点之间的关系。删除子图前必须先移除所有资源节点，确保数据安全。

### 1.2 业务目标

**Why - 为什么需要这个功能？**
- **业务价值**: 提供灵活的资源组织方式，支持按不同维度（业务域、系统模块、团队）管理资源
- **解决的痛点**: 
  - 大规模资源管理混乱，难以快速定位特定业务域的资源
  - 全局拓扑图过于复杂，无法聚焦于特定系统模块
  - 缺乏团队级别的资源视图和权限管理
- **预期成果**: 
  - 提升资源管理效率 50%
  - 减少故障定位时间 40%
  - 支持团队协作和权限隔离

### 1.3 用户角色

**Who - 谁使用这个功能？**

| 角色 | 职责 | 使用场景 | 权限要求 |
|------|------|----------|----------|
| 运维工程师 | 创建和管理子图，组织资源节点 | 日常运维、故障排查、系统梳理 | 已认证用户 |
| 子图 Owner | 完全控制子图，管理权限和资源 | 子图维护、权限分配、资源管理 | 子图所有者 |
| 子图 Viewer | 查看子图详情和拓扑 | 了解系统结构、查看资源关系 | 查看权限 |
| 系统管理员 | 管理所有子图，处理用户删除 | 系统维护、权限转移、数据清理 | 管理员权限 |

---

## 2. 澄清结果

### 2.1 功能范围澄清

**What - 具体需要做什么？**

| 功能点 | 原始描述 | 澄清后的精确描述 | 优先级 |
|--------|----------|------------------|--------|
| 子图创建 | 创建子图 | 创建具有全局唯一名称的子图，自动将创建者设为第一个 Owner | MUST |
| 子图列表 | 查看子图列表 | 查看用户有权限的子图列表，支持搜索、标签过滤、所有者过滤、排序和分页（每页 20 项） | MUST |
| 子图编辑 | 编辑子图信息 | Owner 可以编辑名称（需验证唯一性）、描述、标签、元数据和权限列表 | MUST |
| 子图删除 | 删除子图 | Owner 可以物理删除空子图（必须先移除所有资源节点），级联删除权限记录 | MUST |
| 添加节点 | 向子图添加资源节点 | Owner 可以添加任何资源节点到子图，不验证节点所有权，节点可以属于多个子图 | MUST |
| 移除节点 | 从子图移除资源节点 | Owner 可以移除节点，只删除关联关系，不影响节点本身和其在其他子图中的存在 | MUST |
| 子图详情 | 查看子图详情 | 显示基本信息、资源节点列表（表格）、拓扑图（只显示子图内关系）、权限列表 | MUST |
| 权限管理 | 管理子图权限 | Owner 可以添加/移除其他 Owner 和 Viewer，不能移除自己作为最后一个 Owner | MUST |

### 2.2 触发条件和时机

**When - 什么时候触发？**

| 功能 | 触发条件 | 触发时机 | 频率 |
|------|----------|----------|------|
| 创建子图 | 用户点击"创建子图"按钮 | 需要组织新的资源分组时 | 低频（每周 1-5 次） |
| 查看列表 | 用户访问子图管理页面 | 需要查找或浏览子图时 | 高频（每天 10-50 次） |
| 编辑子图 | Owner 点击"编辑"按钮 | 需要更新子图信息或权限时 | 中频（每天 2-10 次） |
| 删除子图 | Owner 点击"删除"按钮 | 子图不再需要时 | 低频（每月 1-5 次） |
| 添加节点 | Owner 点击"添加节点"按钮 | 需要将资源加入子图时 | 高频（每天 20-100 次） |
| 移除节点 | Owner 点击节点的"移除"按钮 | 资源不再属于该业务域时 | 中频（每天 5-20 次） |
| 查看详情 | 用户点击子图名称或详情链接 | 需要了解子图具体内容时 | 高频（每天 30-100 次） |
| 查看拓扑 | 用户切换到拓扑图标签页 | 需要可视化查看子图结构时 | 高频（每天 20-80 次） |

### 2.3 使用环境和场景

**Where - 在哪里使用？**

- **使用环境**: Web 浏览器（Chrome、Firefox、Safari 最新两个版本）
- **设备要求**: 桌面电脑或笔记本电脑，屏幕分辨率 ≥ 1366x768
- **网络要求**: 稳定的互联网连接，带宽 ≥ 1 Mbps
- **浏览器/客户端要求**: 支持 HTML5、CSS3、JavaScript ES6+

**典型使用场景**:
1. **场景 1: 业务域资源组织**
   - 运维工程师创建"支付系统"子图
   - 添加支付相关的服务器、应用、数据库、消息队列
   - 设置团队成员为 Viewer，方便查看

2. **场景 2: 故障排查**
   - 运维工程师打开"订单系统"子图
   - 查看拓扑图，快速定位故障节点
   - 检查节点之间的依赖关系

3. **场景 3: 系统梳理**
   - 架构师创建"核心服务"子图
   - 逐步添加核心服务相关的所有资源
   - 生成拓扑图用于文档和汇报

### 2.4 实现方法和验收标准

**How - 如何实现？如何验证？**

#### 功能 1: 子图创建

**实现要点**:
- 前端表单验证（名称必填、长度限制）
- 后端验证名称全局唯一性
- 自动将创建者添加为第一个 Owner
- 记录审计日志

**验收标准**:
- [ ] 表单包含名称、描述、标签、元数据字段
- [ ] 名称重复时显示错误消息
- [ ] 创建成功后自动跳转到详情页
- [ ] 审计日志包含创建者 ID、时间戳、子图详情

#### 功能 2: 子图列表

**实现要点**:
- 查询用户有权限的子图（Owner 或 Viewer）
- 支持关键词搜索（名称和描述）
- 支持标签过滤（JSON_CONTAINS）
- 支持所有者过滤（JOIN 查询）
- 支持排序（创建时间、更新时间、名称）
- 分页（每页 20 项）

**验收标准**:
- [ ] 只显示用户有权限的子图
- [ ] 搜索实时过滤结果
- [ ] 标签过滤准确
- [ ] 排序功能正常
- [ ] 分页正确显示

#### 功能 3: 子图编辑

**实现要点**:
- 权限验证（只有 Owner 可以编辑）
- 名称唯一性验证（排除自身）
- 乐观锁防止并发冲突
- 记录审计日志

**验收标准**:
- [ ] 非 Owner 无法访问编辑功能
- [ ] 名称重复时显示错误
- [ ] 并发修改时显示冲突提示
- [ ] 审计日志记录修改内容

#### 功能 4: 子图删除

**实现要点**:
- 权限验证（只有 Owner 可以删除）
- 检查子图是否为空（包含资源节点）
- 物理删除子图记录
- 级联删除权限记录（ON DELETE CASCADE）
- 记录审计日志

**验收标准**:
- [ ] 非 Owner 无法删除
- [ ] 非空子图无法删除，显示错误提示
- [ ] 删除成功后权限记录也被删除
- [ ] 审计日志记录删除操作

#### 功能 5: 添加节点

**实现要点**:
- 权限验证（只有 Owner 可以添加）
- 不验证节点所有权
- 检查节点是否已在子图中
- 支持多对多关系
- 记录审计日志

**验收标准**:
- [ ] 非 Owner 无法添加节点
- [ ] 可以添加任何资源节点
- [ ] 重复添加时显示提示
- [ ] 节点可以同时属于多个子图
- [ ] 审计日志记录添加操作

#### 功能 6: 移除节点

**实现要点**:
- 权限验证（只有 Owner 可以移除）
- 只删除关联关系
- 不影响节点本身
- 不影响节点在其他子图中的存在
- 记录审计日志

**验收标准**:
- [ ] 非 Owner 无法移除节点
- [ ] 移除后节点本身仍存在
- [ ] 节点在其他子图中的关联不受影响
- [ ] 审计日志记录移除操作

#### 功能 7: 子图详情

**实现要点**:
- 查询子图基本信息
- 查询资源节点列表
- 查询节点之间的关系（只查询子图内）
- 查询权限列表
- 多标签页展示

**验收标准**:
- [ ] 显示完整的基本信息
- [ ] 资源列表包含所有必需列
- [ ] 拓扑图只显示子图内关系
- [ ] 权限列表显示所有 Owner 和 Viewer

### 2.5 性能和质量指标

**How Much - 具体指标是什么？**

| 指标类型 | 指标名称 | 目标值 | 测量方法 |
|----------|----------|--------|----------|
| 性能 | 列表查询响应时间 | < 1 秒（最多 1000 个子图） | 后端日志记录查询时间 |
| 性能 | 详情页加载时间 | < 2 秒（最多 500 个节点） | 前端性能监控 |
| 性能 | 拓扑图渲染时间 | < 3 秒（最多 500 个节点和 1000 个关系） | 前端性能监控 |
| 性能 | 操作响应时间 | < 500 毫秒（创建、更新、删除） | 后端日志记录 |
| 性能 | 并发支持 | 100 个并发用户 | 压力测试 |
| 质量 | 可用性 | 99.9% | 监控系统统计 |
| 质量 | 数据一致性 | 100%（事务保证） | 数据库约束 + 单元测试 |
| 质量 | 审计日志完整性 | 100%（所有 CUD 操作） | 审计日志查询 |

---

## 3. 歧义澄清记录

### 3.1 已澄清的歧义

| ID | 歧义陈述 | 提出的问题 | 澄清结果 | 影响范围 |
|----|----------|------------|----------|----------|
| CL-001 | "创建子图" | 子图名称是否需要全局唯一？ | 必须全局唯一 | 数据库设计、验证逻辑 |
| CL-002 | "添加资源节点" | 资源节点可以属于多个子图吗？ | 可以（多对多关系） | 数据模型、关联表设计 |
| CL-003 | "管理子图" | 是否需要 Manager 角色？ | 不需要，只有 Owner 和 Viewer | 权限模型、数据表设计 |
| CL-004 | "删除子图" | 删除策略是什么？ | 物理删除，但必须先移除所有节点 | 删除逻辑、用户体验 |
| CL-005 | "查看拓扑图" | 拓扑图显示哪些关系？ | 只显示子图内节点之间的关系 | 查询逻辑、性能优化 |

### 3.2 识别并消除的歧义

| ID | 歧义陈述 | 可能的理解 A | 可能的理解 B | 最终确认 |
|----|----------|-------------|-------------|----------|
| AM-001 | "编辑子图信息" | 所有用户都可以编辑 | 只有 Owner 可以编辑 | 只有 Owner 可以编辑 |
| AM-002 | "删除子图" | 直接删除，级联删除节点 | 必须先移除节点才能删除 | 必须先移除节点才能删除 |
| AM-003 | "添加节点" | 只能添加自己拥有的节点 | 可以添加任何节点 | 可以添加任何节点 |
| AM-004 | "移除节点" | 删除节点本身 | 只移除关联关系 | 只移除关联关系 |
| AM-005 | "拓扑图" | 显示所有相关节点 | 只显示子图内节点 | 只显示子图内节点 |

---

## 4. 关键假设

| ID | 假设内容 | 依据 | 验证方法 | 验证时间 | 状态 |
|----|----------|------|----------|----------|--------|
| AS-001 | 用户已完成身份认证 | 依赖 F01 功能 | 集成测试 | 开发阶段 | 待验证 |
| AS-002 | 资源节点数据已存在 | 依赖 F03 功能 | 集成测试 | 开发阶段 | 待验证 |
| AS-003 | 拓扑关系数据已存在 | 依赖 F04 功能 | 集成测试 | 开发阶段 | 待验证 |
| AS-004 | 拓扑可视化组件可用 | 依赖 F05 功能 | 集成测试 | 开发阶段 | 待验证 |
| AS-005 | 数据库支持 JSON 字段 | MySQL 8.0+ | 环境检查 | 部署前 | 待验证 |
| AS-006 | 用户浏览器支持现代 Web 标准 | Chrome/Firefox/Safari 最新两个版本 | 兼容性测试 | 测试阶段 | 待验证 |

**关键假设详细描述**:

1. **AS-001: 用户已完成身份认证**
   - 内容: 所有子图操作都假设用户已通过 JWT 认证
   - 假设不成立的影响: 无法获取用户 ID，无法进行权限验证
   - 缓解策略: 在所有 API 端点添加认证拦截器

2. **AS-002: 资源节点数据已存在**
   - 内容: 添加节点到子图时，假设节点已在系统中创建
   - 假设不成立的影响: 无法添加节点，用户体验受影响
   - 缓解策略: 添加节点前验证节点是否存在

3. **AS-005: 数据库支持 JSON 字段**
   - 内容: 使用 JSON 字段存储标签和元数据
   - 假设不成立的影响: 需要重新设计数据模型
   - 缓解策略: 部署前检查 MySQL 版本，确保 ≥ 8.0

---

## 5. 技术风险识别

| ID | 风险描述 | 概率 | 影响 | 风险等级 | 初步应对方法 |
|----|----------|------|------|----------|--------------|
| RISK-001 | 子图名称唯一性验证在高并发下可能失败 | 中 | 高 | 高 | 使用数据库唯一约束 + 乐观锁 |
| RISK-002 | 大量节点的拓扑图渲染性能问题 | 高 | 中 | 高 | 限制节点数量 + 前端分页渲染 |
| RISK-003 | 并发修改同一子图导致数据冲突 | 中 | 中 | 中 | 使用乐观锁（version 字段） |
| RISK-004 | 删除用户时子图所有权转移复杂 | 低 | 高 | 中 | 设计明确的转移流程 + 管理员工具 |
| RISK-005 | 多对多关系导致数据清理复杂 | 中 | 中 | 中 | 使用外键约束 ON DELETE CASCADE |

**高风险详细描述**:

1. **RISK-001: 子图名称唯一性验证**
   - 详细描述: 在高并发场景下，两个用户可能同时创建同名子图，应用层验证可能失败
   - 触发条件: 多个用户在短时间内创建同名子图
   - 影响范围: 数据完整性、用户体验
   - 初步建议: 
     - 在数据库层面添加 UNIQUE 约束
     - 使用乐观锁机制
     - 捕获唯一约束违反异常，返回友好错误消息

2. **RISK-002: 拓扑图渲染性能**
   - 详细描述: 当子图包含大量节点（>500）和关系（>1000）时，前端渲染可能卡顿
   - 触发条件: 用户查看包含大量节点的子图拓扑图
   - 影响范围: 用户体验、系统性能
   - 初步建议:
     - 限制每个子图最多 500 个节点
     - 使用虚拟滚动或分页渲染
     - 提供简化视图选项
     - 使用 Web Worker 进行布局计算

---

## 6. 边界和约束

### 6.1 功能边界（不包含的内容）

- ❌ 子图模板功能（预定义的子图结构）
- ❌ 子图版本控制（跟踪子图结构变更历史）
- ❌ 子图导出/导入功能
- ❌ 子图共享给其他用户或团队
- ❌ 子图之间的关系管理
- ❌ 子图的批量操作（批量创建、批量删除）
- ❌ 子图的高级搜索（正则表达式、复杂查询）

### 6.2 技术约束

- 数据库: MySQL 8.0+，InnoDB 存储引擎
- 字符集: UTF-8MB4
- 事务隔离级别: READ_COMMITTED
- 并发控制: 乐观锁（version 字段）
- 缓存: Redis 7.0+（可选）
- 前端框架: 与现有系统保持一致

### 6.3 业务约束

- 子图名称长度: 1-255 字符
- 每个子图最多 500 个资源节点
- 每个子图最多 10 个 Owner
- 每个子图最多 100 个 Viewer
- 系统最多支持 10,000 个子图

### 6.4 时间约束

- 开发周期: 4-6 周
- 第一阶段（MVP）: 2-3 周（核心功能）
- 第二阶段（完善）: 1-2 周（性能优化、测试）
- 第三阶段（上线）: 1 周（部署、监控）

---

## 7. 依赖关系

### 7.1 外部依赖

| 依赖 | 类型 | 提供方 | 可用性 | 风险 |
|------|------|--------|--------|------|
| F01: 用户认证 | 内部服务 | 认证模块 | 已实现 | 低 |
| F03: 资源管理 | 内部服务 | 资源模块 | 已实现 | 低 |
| F04: 拓扑关系 | 内部服务 | 拓扑模块 | 已实现 | 低 |
| F05: 拓扑可视化 | 内部服务 | 可视化模块 | 已实现 | 低 |
| MySQL 8.0+ | 数据库 | 基础设施 | 已部署 | 低 |
| Redis 7.0+ | 缓存 | 基础设施 | 已部署 | 低 |

### 7.2 内部依赖

| 依赖 | 类型 | 负责团队 | 状态 | 依赖时间 |
|------|------|----------|------|----------|
| 审计日志服务 | 内部模块 | 基础设施团队 | 已实现 | 开发阶段 |
| 权限验证服务 | 内部模块 | 安全团队 | 已实现 | 开发阶段 |
| 通知服务 | 内部模块 | 通知团队 | 已实现 | 开发阶段 |

---

## 8. 下一步

- [ ] 用户已确认本澄清文档
- [ ] 进入阶段 2: 需求文档编写
- [ ] 验证阶段 1 中标记为"待验证"的所有假设
- [ ] 评估所有已识别的技术风险

---

**审核签名**:
- 需求分析师: AI Assistant
- 用户确认: [用户名] - [日期]

**文档版本**: v1.0  
**最后更新**: 2024-12-04
