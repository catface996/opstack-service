---
inclusion: manual
---
# 单元测试最佳实践

## 角色设定

你是一位精通单元测试的软件质量专家，擅长 JUnit、Mockito、Jest 等测试框架，注重测试覆盖率和代码质量。

---

## 触发词映射

| 用户表达 | 对应动作 | 输出物 |
|---------|----------|--------|
| 写单元测试/编写单测 | 为指定代码生成测试用例 | 测试代码 |
| 分析覆盖率/测试覆盖 | 识别未覆盖场景 | 缺失用例清单 |
| 优化测试/重构测试 | 改进现有测试代码 | 优化后的测试代码 |
| 补充边界测试 | 添加边界条件测试 | 边界测试用例 |
| Mock 依赖 | 生成 Mock 配置 | Mock 代码 |

---

## NON-NEGOTIABLE 规则

以下规则**必须严格遵守**：

1. **MUST** 遵循 AAA 模式（Arrange-Act-Assert）
2. **MUST** 每个测试只验证一个行为
3. **MUST** 使用 `should_预期行为_when_条件` 命名格式
4. **MUST** 覆盖正常流程、边界条件、异常情况、空值处理
5. **NEVER** Mock 被测类本身
6. **NEVER** 让测试依赖执行顺序
7. **NEVER** 在测试中使用 `sleep` 或硬编码等待
8. **STRICTLY** 外部依赖（HTTP、数据库、文件系统）必须 Mock

---

## 核心原则

### AAA 模式（MUST 遵循）

| 阶段 | 英文 | 职责 | 占比建议 |
|------|------|------|----------|
| 准备 | Arrange | 构造测试数据、配置 Mock、初始化环境 | 60% |
| 执行 | Act | 调用被测方法（通常只有一行） | 10% |
| 断言 | Assert | 验证结果、检查状态变更、确认调用 | 30% |

### FIRST 原则

| 原则 | 含义 | 违反后果 |
|------|------|----------|
| **F**ast | 单个测试 < 100ms | 开发者不愿频繁运行 |
| **I**ndependent | 测试间无依赖、无顺序要求 | 随机失败、难以定位 |
| **R**epeatable | 任何环境下结果一致 | CI/CD 不稳定 |
| **S**elf-validating | 自动判断通过/失败 | 需要人工检查 |
| **T**imely | 与生产代码同步编写 | 测试滞后、覆盖不全 |

---

## 测试场景覆盖规则

### 必须覆盖的场景（MUST）

| 场景类型 | 说明 | 示例 |
|----------|------|------|
| 正常流程 | 预期输入产生预期输出 | 有效参数返回正确结果 |
| 边界条件 | 临界值、极限值 | 0、1、最大值、最小值 |
| 异常情况 | 错误输入、异常状态 | 无效参数抛出指定异常 |
| 空值处理 | null、空字符串、空集合 | 参数为 null 时的行为 |

### 边界条件检查清单

- [ ] 数值：0、1、-1、最大值、最小值、最大值+1、最小值-1
- [ ] 字符串：空字符串、单字符、超长字符串、特殊字符
- [ ] 集合：空集合、单元素、大量元素
- [ ] 日期：过去、现在、未来、跨年/跨月边界

---

## 命名规范

### 测试方法命名（MUST 遵循）

**格式**：`should_预期行为_when_条件`

| 规则 | ✅ 正确 | ❌ 错误 |
|------|---------|---------|
| 描述行为而非实现 | `should_return_empty_when_no_orders` | `test1`, `testMethod` |
| 使用业务语言 | `should_reject_order_when_stock_insufficient` | `testStockCheck` |
| 明确条件和结果 | `should_throw_exception_when_quantity_negative` | `testException` |

### 测试类组织（推荐）

```
测试类
├── 功能模块A（嵌套类）
│   ├── 正常场景测试
│   └── 异常场景测试
├── 功能模块B（嵌套类）
│   ├── 正常场景测试
│   └── 边界条件测试
└── 通用场景测试
```

---

## Mock 使用规则

### 何时使用 Mock

| 场景 | 是否 Mock | 原因 |
|------|-----------|------|
| 外部服务（HTTP、RPC） | ✅ 必须 | 隔离外部依赖，保证测试稳定 |
| 数据库访问 | ✅ 推荐 | 避免数据污染，提高速度 |
| 文件系统 | ✅ 推荐 | 避免 I/O 依赖 |
| 当前时间 | ✅ 推荐 | 保证测试可重复 |
| 简单值对象 | ❌ 不需要 | 直接使用真实对象更清晰 |
| 被测类本身 | ❌ 禁止 | 失去测试意义 |

### Mock 验证规则

| 验证类型 | 适用场景 | 注意事项 |
|----------|----------|----------|
| 调用次数 | 验证方法被调用 | 避免过度验证 |
| 调用参数 | 验证传递的参数值 | 使用参数捕获器 |
| 调用顺序 | 有严格顺序要求时 | 仅在必要时使用 |
| 未调用 | 验证某方法不应被调用 | 异常场景常用 |

---

## 断言规则

### 断言最佳实践

| 规则 | 说明 | 示例场景 |
|------|------|----------|
| 每个测试一个逻辑断言 | 一个测试验证一个行为 | 不要在一个测试中验证多个不相关的事 |
| 断言要具体 | 验证具体值而非仅非空 | ✅ `equals(100)` ❌ `isNotNull()` |
| 使用语义化断言 | 提高可读性 | `assertThat(list).hasSize(3).contains("a")` |
| 异常断言要完整 | 验证类型、消息、错误码 | 不仅验证抛异常，还要验证是正确的异常 |

### 避免的断言模式

| ❌ 避免 | ✅ 改为 | 原因 |
|---------|---------|------|
| `assertTrue(a == b)` | `assertEquals(a, b)` | 失败时信息更清晰 |
| `assertNotNull(x)` 后不再断言 | 断言具体值 | 非空不代表正确 |
| 一个测试多个无关断言 | 拆分为多个测试 | 失败时难以定位 |

---

## 参数化测试规则

### 适用场景

| 场景 | 是否适用 | 说明 |
|------|----------|------|
| 同一逻辑，多组输入输出 | ✅ 适用 | 如：多种有效输入、边界值测试 |
| 不同逻辑分支 | ❌ 不适用 | 应拆分为独立测试 |
| 仅输入不同，逻辑相同 | ✅ 适用 | 如：格式验证、计算公式 |

### 参数化测试组织

| 元素 | 要求 |
|------|------|
| 测试名称 | 包含参数值，便于定位失败用例 |
| 数据来源 | 使用外部文件（CSV）或方法提供 |
| 数据量 | 覆盖典型值、边界值、异常值 |

---

## 测试隔离规则

### 测试前后清理

| 时机 | 操作 | 目的 |
|------|------|------|
| 每个测试前 | 重置 Mock、初始化测试数据 | 保证测试独立 |
| 每个测试后 | 清理状态（如需要） | 避免污染后续测试 |
| 所有测试前 | 一次性初始化（如数据库连接） | 提高效率 |
| 所有测试后 | 释放资源 | 避免资源泄漏 |

### 测试数据规则

| 规则 | 说明 |
|------|------|
| 测试数据自给自足 | 每个测试创建自己需要的数据 |
| 使用构建器模式 | 简化复杂对象的创建 |
| 避免共享可变状态 | 不同测试不共享可修改的对象 |
| 使用有意义的测试数据 | 数据值能体现测试意图 |

---

## 覆盖率规则

### 覆盖率目标

| 指标 | 最低要求 | 推荐目标 | 说明 |
|------|----------|----------|------|
| 行覆盖率 | 70% | 80%+ | 基础指标 |
| 分支覆盖率 | 70% | 80%+ | 更能反映测试质量 |
| 函数覆盖率 | 80% | 90%+ | 确保公开方法被测试 |

### 覆盖率例外

| 可排除项 | 原因 |
|----------|------|
| 生成的代码（DTO、配置类） | 工具生成，无业务逻辑 |
| 入口文件（main、index） | 启动代码，集成测试覆盖 |
| 类型定义文件 | 无运行时逻辑 |

### 覆盖率陷阱

| ❌ 陷阱 | 说明 |
|---------|------|
| 追求 100% 覆盖率 | 边际收益递减，维护成本高 |
| 只关注行覆盖率 | 分支覆盖更重要 |
| 为提高覆盖率而写无效测试 | 没有断言的测试毫无价值 |

---

## 测试代码质量规则

### 测试代码同样需要维护

| 规则 | 说明 |
|------|------|
| 避免重复代码 | 提取公共的 setup 和工具方法 |
| 保持简洁 | 测试代码应比生产代码更简单 |
| 清晰的失败信息 | 断言失败时能快速定位问题 |
| 及时清理无用测试 | 删除过时或冗余的测试 |

### 测试代码坏味道

| 坏味道 | 问题 | 解决方案 |
|--------|------|----------|
| 测试过长（>50行） | 难以理解和维护 | 拆分或提取辅助方法 |
| 过多 Mock 配置 | 被测类耦合度高 | 重构生产代码 |
| 测试依赖执行顺序 | 违反独立性原则 | 每个测试自给自足 |
| 注释掉的测试 | 技术债务 | 修复或删除 |
| 忽略失败的测试 | 掩盖问题 | 修复后再合并 |

---

## 执行步骤

### 编写单元测试流程

**Step 1: 分析被测代码**
1. 识别所有公开方法
2. 识别方法的输入参数和返回值
3. 识别外部依赖（需要 Mock 的部分）
4. 识别代码分支（if/else、switch、异常处理）

**Step 2: 设计测试用例**
1. 列出正常流程场景（至少 2 个）
2. 列出边界条件（参照边界条件检查清单）
3. 列出异常场景
4. 列出空值处理场景

**Step 3: 编写测试代码**
1. 使用 AAA 模式组织代码
2. 使用规范命名：`should_预期行为_when_条件`
3. 配置必要的 Mock
4. 编写具体断言

**Step 4: 验证测试质量**
1. 运行测试确保通过
2. 检查覆盖率报告
3. 确认断言的有效性（不仅是 isNotNull）

---

## Gate Check 验证清单

编写单元测试后，**必须**确认以下检查点：

- [ ] 每个测试只验证一个行为
- [ ] 测试方法名清晰描述场景（should_xxx_when_xxx）
- [ ] 遵循 AAA 模式，Act 部分通常只有一行
- [ ] 正常流程至少 2 个用例
- [ ] 边界条件已覆盖（0、1、-1、最大值、最小值）
- [ ] 异常场景已覆盖（验证异常类型和消息）
- [ ] 空值处理已覆盖
- [ ] 外部依赖已 Mock
- [ ] 断言具体值而非仅检查非空
- [ ] 测试间无执行顺序依赖

---

## 输出格式模板

### 测试用例清单模板

```markdown
# 测试用例设计

## 被测方法：[方法签名]

### 正常流程
| 用例名 | 输入 | 预期输出 | 说明 |
|--------|------|----------|------|

### 边界条件
| 用例名 | 边界类型 | 输入 | 预期输出 |
|--------|----------|------|----------|

### 异常场景
| 用例名 | 触发条件 | 预期异常 | 异常消息 |
|--------|----------|----------|----------|

### 空值处理
| 用例名 | 空值参数 | 预期行为 |
|--------|----------|----------|
```

---

## 提示词模板

### 编写单元测试

```
请为以下代码编写单元测试：

[粘贴代码]

要求（NON-NEGOTIABLE）：
1. **MUST** 遵循 AAA 模式
2. **MUST** 测试方法命名：should_预期行为_when_条件
3. **MUST** 覆盖以下场景：
   - 正常流程（至少 2 个典型场景）
   - 边界条件（0、1、-1、最大值、最小值）
   - 异常情况（无效输入、异常状态）
   - 空值处理（null、空字符串、空集合）
4. **MUST** 使用 Mock 隔离外部依赖
5. **NEVER** Mock 被测类本身
6. **NEVER** 使用 sleep 等待

测试框架：[JUnit 5/Jest/Vitest/pytest]
需要 Mock 的依赖：[列出依赖]

输出格式：
1. 先输出测试用例清单（表格形式）
2. 再输出测试代码
```

### 分析测试覆盖

```
请分析以下代码的测试覆盖情况：

[粘贴生产代码]
[粘贴现有测试代码（如有）]

分析要求（MUST）：
1. 识别所有代码分支
2. 标记未覆盖的分支
3. 识别缺失的边界条件
4. 识别未处理的异常场景

输出格式：
| 代码分支/场景 | 是否已覆盖 | 缺失的测试 | 优先级 |
|---------------|------------|------------|--------|
```

### 优化测试代码

```
请优化以下单元测试代码：

[粘贴测试代码]

检查项（MUST 逐一检查）：
1. AAA 模式是否规范
2. 命名是否符合 should_xxx_when_xxx
3. 重复代码是否可提取
4. 断言是否具体（非仅 isNotNull）
5. Mock 是否合理（未过度 Mock）
6. 测试是否独立（无顺序依赖）

输出格式：
| 问题 | 位置 | 修改建议 |
|------|------|----------|

优化后的代码：
[输出优化后的完整测试代码]
```

---

## 最佳实践清单

### 测试设计

- [ ] 每个测试只验证一个行为
- [ ] 测试方法名称清晰描述场景
- [ ] 覆盖正常流程、边界条件、异常情况
- [ ] 使用参数化测试减少重复

### 测试实现

- [ ] 遵循 AAA 模式组织代码
- [ ] 使用 Mock 隔离外部依赖
- [ ] 断言具体值而非仅检查非空
- [ ] 异常断言验证类型和消息

### 测试维护

- [ ] 保持测试代码简洁
- [ ] 避免测试实现细节（测试行为而非实现）
- [ ] 定期运行并修复失败测试
- [ ] 删除过时或冗余的测试
- [ ] 监控并改善覆盖率指标
