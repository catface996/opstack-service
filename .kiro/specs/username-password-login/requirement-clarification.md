# 需求澄清文档

**功能名称**: 用户名密码登录
**创建日期**: 2025-01-23
**需求分析师**: AI Assistant
**状态**: 已澄清 ✅

---

## 1. 需求概述

### 1.1 核心需求（3-5句话）
实现基于用户名或邮箱的本地账号登录功能，为AIOps平台提供基础的身份认证能力。系统需要支持用户使用用户名或邮箱配合密码进行登录，密码采用BCrypt加密存储，并提供防暴力破解、会话管理、审计日志等安全机制。用户可以选择"记住我"选项延长会话有效期，系统需要防御常见的Web攻击（SQL注入、XSS、CSRF）。

### 1.2 业务目标
**Why - 为什么需要这个功能？**
- 业务价值：为AIOps平台提供基础的用户身份认证能力，是所有需要权限控制功能的前置依赖
- 解决的痛点：当前系统缺少身份认证机制，无法区分不同用户，无法进行权限控制和操作审计
- 期望的效果：用户可以安全地登录系统，系统可以识别用户身份并进行权限控制，所有操作可追溯

### 1.3 用户角色
**Who - 谁使用这个功能？**
| 角色 | 职责 | 使用场景 | 权限要求 |
|------|------|---------|---------|
| 普通用户 | 使用系统功能 | 登录系统访问个人资源 | 基础访问权限 |
| 系统管理员 | 管理系统和用户 | 登录系统进行管理操作、查看审计日志 | 管理员权限 |
| 未注册用户 | 注册新账号 | 使用用户名或邮箱注册账号 | 无（注册后获得基础权限） |

---

## 2. 需求澄清结果

### 2.1 功能范围澄清
**What - 具体要做什么？**

| 功能点 | 原始描述 | 澄清后的精确描述 | 优先级 |
|-------|---------|----------------|--------|
| 用户名密码登录 | 用户可以使用用户名和密码登录 | 用户在登录表单输入用户名和密码，系统验证后创建会话并生成JWT Token，重定向到首页 | Must |
| 邮箱密码登录 | 用户可以使用邮箱登录 | 用户在登录表单输入邮箱和密码，系统自动识别邮箱格式并验证，创建会话并生成JWT Token | Must |
| 账号注册 | 用户可以注册账号 | 用户可以选择使用用户名或邮箱作为账号标识符，设置符合强度要求的密码，系统验证后创建账号 | Must |
| 密码加密存储 | 密码需要加密存储 | 使用BCrypt算法加密密码，使用盐值增强安全性，使用恒定时间比较防止时序攻击 | Must |
| 登录失败提示 | 登录失败时给予提示 | 显示通用错误消息（不透露用户名或密码哪个错误），记录失败尝试，计入锁定计数 | Must |
| 防暴力破解 | 防止暴力破解攻击 | 连续5次登录失败锁定账号30分钟，锁定期间拒绝所有登录尝试并显示剩余时间，成功登录后重置计数器 | Must |
| 会话管理 | 管理用户登录会话 | 登录成功创建2小时有效期的会话，会话过期要求重新登录，访问受保护资源时验证会话有效性 | Must |
| 记住我功能 | 延长登录状态 | 用户选择"记住我"后会话有效期延长至30天，关闭浏览器后会话仍然保持 | Should |
| 安全退出 | 用户可以退出登录 | 点击退出按钮使会话失效，清除客户端JWT Token，重定向到登录页面 | Must |
| 审计日志 | 记录登录相关操作 | 记录所有登录尝试（成功/失败）、账号锁定、退出登录，包含时间戳、用户名、IP地址、结果 | Must |
| Web安全防护 | 防御常见Web攻击 | 验证和清理输入防止SQL注入，使用CSRF Token防止CSRF攻击，转义输出防止XSS，强制HTTPS，Cookie使用secure和httpOnly标志 | Must |
| 密码强度要求 | 密码需要符合安全要求 | 密码至少8个字符，必须包含大写字母、小写字母、数字、特殊字符中的至少3类，不能包含用户名或邮箱的一部分，不能是常见弱密码，不符合要求显示具体验证错误 | Must |
| 用户名邮箱双支持 | 用户可以用用户名或邮箱登录 | 同一个用户既有用户名也有邮箱，可以使用任意一个登录，但只能同时在线一个会话 | Must |
| 管理员手动解锁 | 管理员可以解锁被锁定的账号 | 管理员在管理界面选择被锁定的账号，点击解锁按钮，立即解除锁定状态 | Must |
| 会话互斥 | 同一用户只能有一个活跃会话 | 用户在新设备登录时，旧设备的会话自动失效，旧设备访问时提示"您的账号已在其他设备登录" | Must |

### 2.2 触发条件和时机
**When - 什么时候触发？**

| 功能 | 触发条件 | 触发时机 | 频率 |
|------|---------|---------|------|
| 用户登录 | 用户提交登录表单 | 用户访问系统需要身份验证时 | 每次会话开始时 |
| 账号注册 | 用户提交注册表单 | 新用户首次使用系统时 | 一次性 |
| 账号锁定 | 连续5次登录失败 | 检测到暴力破解尝试时 | 按需触发 |
| 账号解锁 | 锁定期限到期（30分钟） | 锁定时间结束时 | 自动触发 |
| 会话过期 | 会话超过有效期（2小时或30天） | 用户长时间未活动时 | 自动触发 |
| 用户退出 | 用户点击退出按钮 | 用户主动结束会话时 | 按需触发 |
| 审计日志记录 | 任何登录相关操作发生 | 实时记录 | 每次操作时 |

### 2.3 使用环境和场景
**Where - 在哪里使用？**
- 使用环境：Web浏览器
- 设备要求：支持JavaScript的现代浏览器（Chrome、Firefox、Safari最新两个版本）
- 网络要求：需要HTTPS连接，支持Cookie和LocalStorage
- 浏览器/客户端要求：支持ES6+、Fetch API、LocalStorage

### 2.4 实现方式和验收标准
**How - 如何实现？如何验证？**

每个功能的实现要点：

1. **用户名密码登录**
   - 实现要点：前端表单验证 → 后端BCrypt密码验证 → 创建Session → 生成JWT Token → 返回Token给客户端
   - 验收标准：
     - [ ] 输入正确的用户名和密码后成功登录并跳转到首页
     - [ ] 登录后可以访问受保护的资源
     - [ ] JWT Token包含用户ID和角色信息
     - [ ] 空用户名或密码被拒绝并显示错误消息

2. **邮箱密码登录**
   - 实现要点：前端识别邮箱格式 → 后端验证邮箱和密码 → 创建Session → 生成JWT Token
   - 验收标准：
     - [ ] 输入正确的邮箱和密码后成功登录
     - [ ] 系统自动识别输入为邮箱格式
     - [ ] 邮箱登录失败也计入账号锁定计数
     - [ ] 不存在的邮箱显示与错误密码相同的通用错误消息

3. **账号注册**
   - 实现要点：前端表单验证 → 后端验证邮箱格式和唯一性 → BCrypt加密密码 → 创建账号记录
   - 验收标准：
     - [ ] 可以使用邮箱注册账号
     - [ ] 邮箱格式无效时显示错误
     - [ ] 邮箱已存在时提示已被使用
     - [ ] 密码不符合强度要求时显示具体验证错误
     - [ ] 注册成功后可以使用邮箱登录

4. **防暴力破解**
   - 实现要点：Redis存储失败计数 → 检查计数是否达到5次 → 设置锁定标志和过期时间 → 锁定期间拒绝登录
   - 验收标准：
     - [ ] 连续5次失败后账号被锁定30分钟
     - [ ] 锁定期间所有登录尝试被拒绝
     - [ ] 显示账号锁定消息和剩余时间
     - [ ] 30分钟后自动解锁
     - [ ] 成功登录后失败计数重置为0

5. **会话管理**
   - 实现要点：Spring Security Session管理 → JWT Token生成 → Token验证拦截器 → Session过期检查
   - 验收标准：
     - [ ] 登录成功创建2小时有效期的Session
     - [ ] Session过期后要求重新登录
     - [ ] 访问受保护资源时验证Session有效性
     - [ ] Session无效或过期时重定向到登录页面

6. **审计日志**
   - 实现要点：AOP拦截登录相关方法 → 记录操作信息到数据库 → 包含时间戳、用户名、IP、结果
   - 验收标准：
     - [ ] 所有登录尝试都被记录
     - [ ] 日志包含时间戳、用户名、IP地址、操作结果
     - [ ] 成功登录、失败登录、账号锁定、退出登录都有独立日志
     - [ ] 管理员可以查询审计日志

### 2.5 性能和质量指标
**How Much - 具体指标是多少？**

| 指标类型 | 指标名称 | 目标值 | 测量方法 |
|---------|---------|--------|---------|
| 性能 | 登录响应时间 | 95%的请求在2秒内完成 | 性能测试工具监控 |
| 性能 | 并发登录用户数 | 支持1000并发用户 | 压力测试 |
| 性能 | 密码验证时间 | 单次BCrypt验证<500ms | 单元测试计时 |
| 质量 | 会话可用性 | 99.9%的会话验证成功 | 监控系统统计 |
| 质量 | 密码加密强度 | BCrypt work factor >= 10 | 代码审查 |
| 安全 | 账号锁定准确率 | 100%的5次失败触发锁定 | 自动化测试 |
| 安全 | HTTPS覆盖率 | 100%的认证请求使用HTTPS | 网络监控 |

---

## 3. 模糊点澄清记录

### 3.1 已澄清的模糊点

| ID | 模糊表述 | 提出的问题 | 澄清结果 | 影响范围 |
|----|---------|-----------|---------|---------|
| CL-001 | "快速加载" | 具体的响应时间要求是多少？ | 95%的登录请求在2秒内完成 | 性能需求 |
| CL-002 | "防止垃圾评论" | 具体采用什么防护机制？ | 连续5次失败锁定30分钟 | 安全需求 |
| CL-003 | "安全存储密码" | 使用什么加密算法？ | BCrypt算法，work factor >= 10 | 密码存储 |
| CL-004 | "会话管理" | 会话有效期是多久？ | 默认2小时，"记住我"30天 | 会话管理 |
| CL-005 | "支持邮箱登录" | 邮箱是否可以作为注册账号？ | 是，用户可以选择用户名或邮箱注册 | 注册功能 |

### 3.2 识别并消除的歧义

| ID | 歧义表述 | 可能的理解A | 可能的理解B | 最终确认 |
|----|---------|-----------|-----------|---------|
| AM-001 | "用户登录" | 只支持用户名登录 | 支持用户名或邮箱登录 | 支持用户名或邮箱登录 |
| AM-002 | "账号锁定" | 永久锁定需要管理员解锁 | 临时锁定自动解锁 | 临时锁定30分钟后自动解锁 |
| AM-003 | "记住我" | 永久保持登录状态 | 延长会话有效期 | 延长会话有效期至30天 |

---

## 4. 关键假设

| ID | 假设内容 | 依据 | 验证方法 | 验证时间 | 状态 |
|----|---------|------|---------|---------|------|
| AS-001 | 用户具备基本的互联网使用能力 | 目标用户为IT运维人员 | 用户调研 | 设计阶段 | 待验证 |
| AS-002 | 用户设备支持JavaScript和Cookie | 现代浏览器标准功能 | 浏览器兼容性测试 | 开发阶段 | 待验证 |
| AS-003 | Redis可用性达到99.9% | 用于存储登录失败计数 | 查阅Redis SLA | 设计阶段 | 待验证 |
| AS-004 | 数据库支持事务 | 用于保证账号创建的原子性 | 技术选型确认 | 设计阶段 | 待验证 |
| AS-005 | 系统部署在HTTPS环境 | 安全传输的前提条件 | 部署环境确认 | 部署阶段 | 已确认：网关层卸载HTTPS |

**关键假设详细说明**：
1. **AS-003: Redis可用性**
   - 内容：Redis用于存储登录失败计数和账号锁定状态，需要高可用性
   - 如果假设不成立的影响：账号锁定功能可能失效，无法防止暴力破解
   - 缓解策略：使用Redis集群或哨兵模式提高可用性，或使用数据库作为备选方案

---

## 5. 技术风险识别

| ID | 风险描述 | 概率 | 影响 | 风险等级 | 初步应对思路 |
|----|---------|------|------|---------|-------------|
| RISK-001 | BCrypt验证性能不足，高并发时响应慢 | 中 | 高 | 中 | 使用异步验证、增加服务器资源、考虑缓存策略 |
| RISK-002 | Redis故障导致账号锁定功能失效 | 低 | 中 | 低 | 已确认：Redis失败后使用MySQL兜底 |
| RISK-003 | JWT Token泄露导致会话劫持 | 中 | 高 | 中 | 使用短期Token、实现Token刷新机制、监控异常登录 |
| RISK-004 | 邮箱格式验证不完善导致无效邮箱注册 | 低 | 中 | 低 | 使用成熟的邮箱验证库、考虑邮箱验证码确认 |
| RISK-005 | 时序攻击绕过密码比较 | 低 | 高 | 中 | 使用BCrypt内置的恒定时间比较 |

**高风险详细说明**：
1. **RISK-001: BCrypt验证性能**
   - 具体描述：BCrypt是计算密集型算法，work factor越高越安全但越慢，高并发时可能导致响应时间超过2秒
   - 触发条件：并发登录用户数超过500
   - 影响范围：用户登录体验，可能导致超时
   - 初步建议：
     - 性能测试确定合适的work factor（建议10-12）
     - 使用异步验证避免阻塞
     - 考虑使用缓存（但需要权衡安全性）
     - 增加服务器资源或使用负载均衡

---

## 6. 边界和约束

### 6.1 功能边界（不包含什么）
- ❌ 不支持第三方OAuth登录（如Google、GitHub）
- ❌ 不支持LDAP/AD认证
- ❌ 不支持多因素认证（MFA）
- ❌ 不支持密码找回功能（后续版本）
- ❌ 不支持手机号注册和登录
- ❌ 不支持邮箱验证码确认（后续版本）
- ❌ 不支持审计日志归档功能（后续版本）

### 6.2 技术约束
- 必须使用Spring Security框架
- 必须使用BCrypt加密算法
- 必须使用JWT Token进行会话管理
- 必须使用Redis存储登录失败计数
- 必须使用MySQL存储用户账号和审计日志

### 6.3 业务约束
- 用户名长度：3-20个字符，只能包含字母、数字、下划线
- 邮箱长度：最大100个字符
- 密码长度：8-64个字符
- 登录失败锁定：5次失败锁定30分钟（不可配置）
- 会话有效期：默认2小时，"记住我"30天（不可配置）

### 6.4 时间约束
- 本功能为MVP必须功能，需要在第一个Sprint完成
- 预计开发时间：2周
- 预计测试时间：3天

---

## 7. 依赖关系

### 7.1 外部依赖
| 依赖项 | 类型 | 提供方 | 可用性 | 风险 |
|-------|------|--------|--------|------|
| Redis | 缓存服务 | 基础设施团队 | 待确认 | 中 - 需要确认可用性SLA |
| MySQL | 数据库 | 基础设施团队 | 已就绪 | 低 |
| HTTPS证书 | 安全传输 | 运维团队 | 待确认 | 中 - 需要确认部署环境 |

### 7.2 内部依赖
| 依赖项 | 类型 | 负责团队 | 状态 | 依赖时间 |
|-------|------|---------|------|---------|
| 用户数据模型 | 数据模型 | 后端团队 | 待设计 | Sprint 1 Week 1 |
| 审计日志模块 | 基础模块 | 后端团队 | 待开发 | Sprint 1 Week 1 |
| 前端登录页面 | UI组件 | 前端团队 | 待开发 | Sprint 1 Week 2 |

---

## 8. 待澄清问题

### 8.1 高优先级问题（已澄清）
- [x] Redis的可用性SLA是多少？是否有集群或哨兵模式？
  - **答案**：Redis失败后有MySQL兜底，使用降级方案
- [x] HTTPS证书是否已经配置？部署环境是否支持HTTPS？
  - **答案**：网关层卸载HTTPS，转发到应用层使用HTTP
- [x] 是否需要支持邮箱验证码确认（防止使用他人邮箱注册）？
  - **答案**：暂时不需要，后续版本补充
- [x] 审计日志的保留期限是多久？是否需要归档？
  - **答案**：暂时不用设计日志归档，使用默认保留策略

### 8.2 中优先级问题（已澄清）
- [x] 是否需要支持用户名和邮箱同时存在（一个用户既有用户名又有邮箱）？
  - **答案**：是，同一个用户既支持用户名也支持邮箱登录，但只能同时在线一个会话
- [x] 管理员是否需要手动解锁被锁定的账号的功能？
  - **答案**：是，需要提供管理员手动解锁功能

### 8.3 低优先级问题（待后续确认）
- [ ] 是否需要在登录页面显示密码强度指示器？
- [ ] 是否需要记录用户的登录历史（最近登录时间、登录IP）？

### 8.3 低优先级问题
- [ ] 是否需要支持国际化（多语言）？
- [ ] 是否需要支持深色模式？
- [ ] 是否需要支持记住用户名（不是记住登录状态）？

---

## 9. 下一步行动

- [ ] 用户确认本澄清文档
- [ ] 澄清高优先级待确认问题
- [ ] 验证关键假设（Redis可用性、HTTPS环境）
- [ ] 进入阶段2：需求文档编写

---

**审核签名**：
- 需求分析师：AI Assistant
- 用户确认：[待确认] - [日期]

**文档版本**: v1.0
**最后更新**: 2025-01-23
