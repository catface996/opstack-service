# 需求文档 - 子图管理

## 简介

本文档规定了子图管理功能（F08）的需求，该功能使运维工程师能够创建和管理子图，将相关的资源节点组织在一起。此功能提供子图级别的拓扑可视化，并促进特定业务域或系统模块的团队协作和权限管理。

### 设计原则

**子图作为资源类型的一种进行管理**。子图不是独立的实体，而是 `resource_type` 中的一种类型（code=SUBGRAPH），存储在统一的 `resource` 表中，复用资源的权限模型和管理机制。这一设计带来以下优势：

- **统一管理**：子图与其他资源使用相同的 CRUD API 和权限模型
- **支持嵌套**：子图可以包含其他子图，形成层级结构
- **减少重复**：复用资源管理的基础设施，降低维护成本
- **一致体验**：用户使用统一的界面管理所有资源类型

## 术语表

- **子图（Subgraph）**: 资源节点的逻辑分组，是资源类型（resource_type）的一种，代表特定的业务域、系统模块或运维范围。子图名称在系统中必须全局唯一
- **资源节点（Resource Node）**: IT 资源（服务器、应用、数据库等），可以同时包含在多个子图中（多对多关系）
- **成员资源（Member Resource）**: 子图中包含的资源，可以是任意类型的资源，包括其他子图
- **嵌套子图（Nested Subgraph）**: 作为成员包含在另一个子图中的子图，支持多层嵌套
- **所有者（Owner）**: 对子图拥有完全控制权限的用户，包括编辑、删除、权限管理和成员管理
- **查看者（Viewer）**: 具有只读访问权限的用户，可以查看子图详情和拓扑
- **循环引用（Circular Reference）**: 当子图 A 包含子图 B，而子图 B 直接或间接包含子图 A 时形成的非法引用关系
- **系统（System）**: AIOps Service 平台
- **用户（User）**: 系统的已认证用户
- **拓扑图（Topology Graph）**: 显示子图内资源节点及其相互关系的可视化表示，支持嵌套子图的展开/折叠

## 需求

### 需求 1: 子图创建（复用资源创建流程）

**用户故事：** 作为运维工程师，我希望创建一个子图来组织相关资源，以便更好地管理特定业务域或系统模块。

#### 验收标准

1. WHEN 用户在创建资源时选择类型为"子图" THEN THE System SHALL 显示子图创建表单，包含名称、描述、标签和元数据字段
2. WHEN 用户提交填写了所有必填字段的创建表单 THEN THE System SHALL 创建子图资源并自动将创建者指定为第一个 Owner
3. WHEN 用户提交缺少必填字段的创建表单 THEN THE System SHALL 显示验证错误并阻止提交
4. WHEN 用户提交的子图名称与系统中已存在的资源名称重复 THEN THE System SHALL 显示错误消息并阻止创建
5. WHEN 子图成功创建 THEN THE System SHALL 将用户重定向到子图详情页面
6. WHEN 子图被创建 THEN THE System SHALL 在审计日志中记录创建事件，包括时间戳、创建者 ID 和子图详情

### 需求 2: 子图列表视图（复用资源列表流程）

**用户故事：** 作为运维工程师，我希望查看我有权访问的所有子图列表，并具有搜索和过滤功能，以便快速找到我需要使用的子图。

#### 验收标准

1. WHEN 用户访问资源列表并过滤类型为"子图" THEN THE System SHALL 显示用户作为 Owner 或 Viewer 的所有子图
2. WHEN 用户在搜索框中输入关键词 THEN THE System SHALL 实时过滤并显示名称或描述包含关键词的子图
3. WHEN 用户选择标签过滤器 THEN THE System SHALL 仅显示包含所选标签的子图
4. WHEN 用户选择所有者过滤器 THEN THE System SHALL 仅显示由所选用户拥有的子图
5. WHEN 用户选择排序选项 THEN THE System SHALL 按所选标准（创建时间、更新时间或名称）重新排序子图列表
6. WHEN 子图列表包含超过 20 项 THEN THE System SHALL 实现分页，每页 20 项
7. WHEN 子图列表显示子图卡片 THEN THE System SHALL 显示特殊的子图图标以区别于其他资源类型

### 需求 3: 子图信息编辑（复用资源编辑流程）

**用户故事：** 作为子图所有者，我希望编辑子图的基本信息和权限，以便保持子图元数据的最新状态并管理访问控制。

#### 验收标准

1. WHEN 作为子图 Owner 的用户点击"编辑"按钮 THEN THE System SHALL 显示预填充当前值的子图编辑表单
2. WHEN 非 Owner 的用户尝试访问编辑功能 THEN THE System SHALL 拒绝访问并显示错误消息
3. WHEN Owner 更新子图名称为已存在的名称 THEN THE System SHALL 显示错误消息并阻止更新
4. WHEN Owner 更新子图信息并保存 THEN THE System SHALL 验证更改、更新子图并在审计日志中记录修改
5. WHEN Owner 添加或移除其他 Owner 或 Viewer THEN THE System SHALL 更新权限列表并通知受影响的用户
6. WHEN Owner 尝试移除自己作为最后一个 Owner THEN THE System SHALL 阻止操作并显示警告消息

### 需求 4: 子图删除（复用资源删除流程 + 额外校验）

**用户故事：** 作为子图所有者，我希望删除不再需要的子图，以便维护一个干净有序的子图列表。

#### 验收标准

1. WHEN 非 Owner 的用户尝试删除子图 THEN THE System SHALL 拒绝操作并显示错误消息
2. WHEN Owner 尝试删除包含成员资源的子图 THEN THE System SHALL 拒绝操作并显示错误消息"请先移除所有成员资源"
3. WHEN Owner 点击"删除"按钮且子图为空 THEN THE System SHALL 显示包含后果警告的确认对话框
4. WHEN Owner 确认删除空子图 THEN THE System SHALL 物理删除子图资源、删除所有权限记录并在审计日志中记录删除
5. WHEN 子图被删除 THEN THE System SHALL 保留原成员资源本身不做修改
6. WHEN 子图删除失败 THEN THE System SHALL 回滚所有更改并向用户显示错误消息

### 需求 5: 向子图添加成员资源（子图特有功能）

**用户故事：** 作为子图所有者，我希望向子图添加资源（包括其他子图）而不考虑资源所有权，以便构建跨不同所有者的相关资源的完整视图。

#### 验收标准

1. WHEN 作为 Owner 的用户点击"添加成员" THEN THE System SHALL 显示资源选择界面，支持选择任意类型的资源（包括子图）
2. WHEN 非 Owner 的用户尝试添加成员 THEN THE System SHALL 拒绝访问并显示错误消息
3. WHEN Owner 选择资源并确认 THEN THE System SHALL 将资源添加到子图而不验证资源所有权
4. WHEN Owner 尝试添加子图中已存在的成员 THEN THE System SHALL 显示消息指示该成员已包含在子图中
5. WHEN Owner 尝试添加另一个子图作为成员 THEN THE System SHALL 允许添加，实现子图嵌套
6. WHEN Owner 尝试添加的子图会导致循环引用 THEN THE System SHALL 拒绝操作并显示错误消息"检测到循环引用，无法添加"
7. WHEN 成员资源成功添加 THEN THE System SHALL 在审计日志中记录添加操作，包括时间戳、用户 ID 和成员 ID
8. WHEN 成员资源被添加到子图 THEN THE System SHALL 允许该资源同时存在于多个子图中

### 需求 6: 从子图移除成员资源（子图特有功能）

**用户故事：** 作为子图所有者，我希望从子图中移除成员资源，以便维护当前系统范围的准确表示。

#### 验收标准

1. WHEN 作为 Owner 的用户点击成员资源上的"移除" THEN THE System SHALL 显示确认对话框
2. WHEN 非 Owner 的用户尝试移除成员 THEN THE System SHALL 拒绝访问并显示错误消息
3. WHEN Owner 确认成员移除 THEN THE System SHALL 移除子图与成员之间的关联
4. WHEN 成员从子图中移除 THEN THE System SHALL 保留成员资源本身不删除或修改
5. WHEN 成员从一个子图中移除 THEN THE System SHALL 保留该成员在其他子图中的关联
6. WHEN 成员成功移除 THEN THE System SHALL 在审计日志中记录移除操作，包括时间戳、用户 ID 和成员 ID

### 需求 7: 子图详情视图（复用资源详情 + 扩展）

**用户故事：** 作为运维工程师，我希望查看子图的全面详情，包括基本信息、成员资源、拓扑图和权限，以便了解子图的完整情况。

#### 验收标准

1. WHEN 用户访问子图详情页面 THEN THE System SHALL 显示子图名称、类型图标、描述、标签、创建时间、更新时间和 Owner 列表
2. WHEN 用户查看成员资源列表标签页 THEN THE System SHALL 显示包含资源名称、类型（子图显示特殊图标）、状态、添加时间和操作按钮列的表格
3. WHEN 成员列表中包含嵌套子图 THEN THE System SHALL 显示子图图标并支持点击展开查看嵌套内容
4. WHEN 用户查看拓扑图标签页 THEN THE System SHALL 渲染子图中所有成员资源及其相互关系的可视化表示
5. WHEN 用户查看拓扑图 THEN THE System SHALL 仅显示子图内成员之间的关系，不显示与子图外资源的关系
6. WHEN 拓扑图中存在嵌套子图 THEN THE System SHALL 显示为可展开/折叠的节点
7. WHEN 用户点击展开嵌套子图 THEN THE System SHALL 显示该子图内部的所有成员资源及其关系
8. WHEN 用户点击折叠嵌套子图 THEN THE System SHALL 将该子图显示为单个节点
9. WHEN 用户点击成员列表中的资源 THEN THE System SHALL 导航到该资源详情页面
10. WHEN 用户点击拓扑图中的节点 THEN THE System SHALL 高亮显示节点并显示包含节点信息的工具提示
11. WHEN 用户查看权限标签页 THEN THE System SHALL 显示包含用户信息的 Owner 和 Viewer 完整列表

### 需求 8: 子图成员列表查询（子图特有功能）

**用户故事：** 作为运维工程师，我希望分页查询子图的成员列表，以便在成员数量较多时高效浏览。

#### 验收标准

1. WHEN 用户请求查询子图成员列表 THEN THE System SHALL 返回分页的成员列表，包含资源名称、类型、状态、添加时间等信息
2. WHEN 用户指定分页参数 THEN THE System SHALL 按指定的页码和每页大小返回数据
3. WHEN 成员中包含子图类型 THEN THE System SHALL 在返回数据中标识 isSubgraph=true 并包含嵌套成员数量

### 需求 9: 子图拓扑数据查询（子图特有功能）

**用户故事：** 作为运维工程师，我希望获取子图的完整拓扑数据（不分页），以便前端渲染拓扑图。

#### 验收标准

1. WHEN 用户请求获取子图所有成员及关系 THEN THE System SHALL 返回子图内所有成员资源的完整信息以及成员之间的关系数据
2. WHEN 子图内存在嵌套子图 THEN THE System SHALL 根据 expandNested 参数决定是否递归返回嵌套子图的成员信息
3. WHEN expandNested=true THEN THE System SHALL 递归展开嵌套子图直到 maxDepth 限制
4. WHEN expandNested=false THEN THE System SHALL 将嵌套子图作为单个节点返回，包含其成员数量信息

### 需求 10: 子图性能

**用户故事：** 作为系统管理员，我希望子图管理系统能够高效处理大规模数据，以便用户可以在不降低性能的情况下使用子图。

#### 验收标准

1. WHEN 用户查询子图列表 THEN THE System SHALL 在 1 秒内返回最多 1000 个子图的结果
2. WHEN 用户加载子图详情页面 THEN THE System SHALL 在 2 秒内渲染包含最多 500 个成员的子图页面
3. WHEN 用户渲染子图拓扑图 THEN THE System SHALL 在 3 秒内显示最多 500 个节点和 1000 个关系的图形
4. WHEN 系统执行子图操作（创建、更新、删除） THEN THE System SHALL 在 500 毫秒内完成操作
5. WHEN 多个用户并发访问子图功能 THEN THE System SHALL 为最多 100 个并发用户维持可接受限度内的响应时间
6. WHEN 用户展开深层嵌套子图 THEN THE System SHALL 在 3 秒内完成最多 3 层嵌套的展开

### 需求 11: 子图安全和审计

**用户故事：** 作为安全管理员，我希望所有子图操作都经过适当授权和审计，以便维护安全合规性并跟踪变更。

#### 验收标准

1. WHEN 任何用户尝试任何子图操作 THEN THE System SHALL 在允许操作之前验证用户的权限
2. WHEN 用户创建、更新或删除子图 THEN THE System SHALL 在审计日志中记录操作，包括用户 ID、时间戳、操作类型和受影响的数据
3. WHEN 用户添加或移除成员资源 THEN THE System SHALL 在审计日志中记录操作，包括用户 ID、时间戳、成员 ID 和操作类型
4. WHEN 用户修改子图权限 THEN THE System SHALL 在审计日志中记录权限变更，包括变更前后的状态
5. WHEN 尝试未授权操作 THEN THE System SHALL 记录尝试，包括用户 ID、时间戳和尝试的操作详情

### 需求 12: 子图数据完整性

**用户故事：** 作为系统管理员，我希望系统维护子图及其关联的数据完整性，以便数据保持一致和可靠。

#### 验收标准

1. WHEN 子图资源被删除 THEN THE System SHALL 在同一事务中删除子图资源记录和所有权限记录
2. WHEN 成员资源从系统中删除 THEN THE System SHALL 自动移除该成员在所有子图中的关联（通过级联删除）
3. WHEN 用户从系统中删除 THEN THE System SHALL 将其拥有的子图的所有权转移给指定管理员
4. WHEN 并发操作修改同一子图 THEN THE System SHALL 使用乐观锁防止数据冲突
5. WHEN 任何数据库操作失败 THEN THE System SHALL 在事务内回滚所有更改以维护一致性
6. WHEN 添加嵌套子图 THEN THE System SHALL 执行循环检测以防止循环引用

## 需求澄清

本节记录了在需求分析过程中澄清的关键决策，这些决策对系统设计和实现有重要影响。

### 澄清 1: 子图作为资源类型（v2.0 新增）

**决策**: 子图作为资源类型（resource_type）的一种进行管理，而不是独立的实体

**理由**:
- 统一资源管理：子图与其他资源使用相同的 CRUD API
- 支持子图嵌套：子图可以包含其他子图
- 复用基础设施：复用资源的权限模型、审计日志等
- 一致用户体验：用户使用统一的界面管理所有资源

**影响**:
- 子图存储在 `resource` 表中，type=SUBGRAPH
- 子图权限存储在 `resource_permission` 表中
- 新增 `subgraph_member` 表存储子图与成员的关联
- 子图 CRUD 操作复用资源管理 API

### 澄清 2: 子图嵌套支持（v2.0 新增）

**决策**: 子图可以包含其他子图，支持多层嵌套

**理由**:
- 支持复杂的组织结构（如：部门 > 团队 > 项目）
- 提供更灵活的资源分组方式
- 满足大型企业的层级管理需求

**影响**:
- 添加成员时需要执行循环检测
- 拓扑图需要支持展开/折叠嵌套子图
- 查询时需要支持递归展开选项
- 限制最大嵌套深度（默认 3 层，最大 10 层）

### 澄清 3: 循环引用检测（v2.0 新增）

**决策**: 系统必须检测并阻止循环引用

**理由**:
- 防止无限递归导致系统崩溃
- 保证数据结构的有效性
- 避免用户创建无效的层级关系

**影响**:
- 添加子图成员时需要执行祖先检查
- 使用深度优先搜索或递归 CTE 检测循环
- 检测到循环时返回明确的错误消息

### 澄清 4: 资源与子图的关系

**决策**: 一个资源可以同时属于多个子图（多对多关系）

**理由**:
- 符合实际运维场景（如一个数据库可能同时属于"支付系统"和"核心服务"子图）
- 提供更大的灵活性，支持不同维度的资源组织
- 不限制用户的使用方式

**影响**:
- 使用关联表（subgraph_member）实现多对多关系
- 删除成员资源时需要清理所有子图关联
- 从一个子图移除成员不影响其在其他子图中的存在

### 澄清 5: 权限角色简化

**决策**: 只保留 Owner 和 Viewer 两种角色，复用资源权限模型

**理由**:
- 简化权限模型，降低系统复杂度
- Owner 拥有完全控制权，包括成员管理
- Viewer 只有查看权限
- 与资源权限模型保持一致

**影响**:
- 复用 `resource_permission` 表存储子图权限
- 所有成员的添加/移除操作都需要 Owner 权限
- 权限管理逻辑与资源管理一致

### 澄清 6: 子图删除策略

**决策**: 子图采用物理删除，但删除前必须先移除所有成员资源

**理由**:
- 防止误删除包含重要资源的子图
- 强制用户明确处理成员资源，避免数据丢失
- 物理删除可以释放存储空间
- 审计日志已经记录了删除操作，无需保留记录

**影响**:
- 删除操作需要先检查子图是否为空
- 非空子图的删除请求会被拒绝
- 需要提供清晰的错误提示，指导用户先移除成员

### 澄清 7: 拓扑图显示范围

**决策**: 子图拓扑图只显示子图内成员之间的关系，嵌套子图支持展开/折叠

**理由**:
- 子图是一个逻辑边界，应该聚焦于内部结构
- 避免拓扑图过于复杂，影响可读性
- 展开/折叠功能让用户可以按需查看详情
- 提高渲染性能

**影响**:
- 拓扑图查询只需要查询子图内成员的关系
- 嵌套子图默认折叠显示为单个节点
- 支持用户交互式展开/折叠

## 约束条件

### 功能约束

1. **子图名称**: 必须全局唯一，长度限制 1-255 字符
2. **成员资源数量**: 每个子图最多支持 500 个直接成员
3. **Owner 数量**: 每个子图至少需要 1 个 Owner，最多支持 10 个 Owner
4. **删除限制**: 只能删除空子图（不包含任何成员资源）
5. **嵌套深度**: 最大嵌套深度为 10 层，默认展开深度为 3 层
6. **循环引用**: 系统必须阻止任何形式的循环引用

### 技术约束

1. **数据库**: 使用 MySQL 8.0+，InnoDB 存储引擎
2. **事务隔离级别**: READ_COMMITTED
3. **并发控制**: 使用乐观锁（version 字段）
4. **字符集**: UTF-8MB4
5. **资源类型**: 子图使用 resource_type 表中的 SUBGRAPH 类型

### 性能约束

1. **列表查询**: < 1 秒（最多 1000 个子图）
2. **详情加载**: < 2 秒（最多 500 个成员）
3. **拓扑渲染**: < 3 秒（最多 500 个节点和 1000 个关系）
4. **操作响应**: < 500 毫秒（创建、更新、删除、添加/移除成员）
5. **并发支持**: 最多 100 个并发用户
6. **嵌套展开**: < 3 秒（最多 3 层嵌套）

## 依赖关系

### 前置依赖

- **F01: 用户登录和身份认证** - 提供用户身份验证和 JWT token
- **F03: 创建和管理 IT 资源** - 提供资源管理基础设施（resource 表、resource_type 表、resource_permission 表）
- **F04: 建立资源间的拓扑关系** - 提供成员关系数据
- **F05: 可视化查看拓扑图** - 提供拓扑图渲染能力

### 后置依赖

无

## 非功能需求

### 可用性

- 系统可用性目标: 99.9%
- 计划内维护窗口: 每月不超过 4 小时

### 可维护性

- 代码遵循 DDD 分层架构
- 完整的单元测试和集成测试
- 清晰的 API 文档

### 可扩展性

- 支持水平扩展（无状态设计）
- 数据库支持读写分离
- 支持缓存层（Redis）

### 安全性

- 所有 API 需要 JWT 认证
- 所有操作需要权限验证
- 敏感操作记录审计日志
- 防止 SQL 注入和 XSS 攻击

---

**文档版本**: v2.0
**最后更新**: 2025-12-22
**更新内容**:
- v2.0 (2025-12-22): 重构为"子图作为资源类型"设计，新增子图嵌套支持、循环检测、拓扑展开/折叠功能
- v1.0 (2024-12-04): 初始版本，根据需求澄清更新了验收标准
