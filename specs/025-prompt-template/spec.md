# Feature Specification: 提示词模板管理

**Feature Branch**: `025-prompt-template`
**Created**: 2025-12-26
**Status**: Draft
**Input**: User description: "设计提示词模板管理相关的功能，包括基础的CRUD，并记录提示词模板不同的用途，而且要做模板的版本控制。"

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 创建提示词模板 (Priority: P1)

作为运维人员，我需要创建新的提示词模板，以便在不同的 AI 交互场景中复用标准化的提示词内容。

**Why this priority**: 创建模板是整个功能的基础，没有模板就无法进行其他操作。

**Independent Test**: 可以通过调用创建 API 并验证返回的模板数据来独立测试，验证模板成功持久化。

**Acceptance Scenarios**:

1. **Given** 用户已登录系统, **When** 用户提交包含名称、内容、用途的模板信息, **Then** 系统创建模板并返回模板 ID 和版本号 1
2. **Given** 用户已登录系统, **When** 用户提交的模板名称已存在, **Then** 系统拒绝创建并返回"模板名称已存在"错误
3. **Given** 用户已登录系统, **When** 用户提交的模板内容为空, **Then** 系统拒绝创建并返回"模板内容不能为空"错误

---

### User Story 2 - 查询提示词模板列表 (Priority: P1)

作为运维人员，我需要查看所有已创建的提示词模板列表，以便快速找到需要使用或编辑的模板。

**Why this priority**: 列表查询是用户管理模板的核心入口，与创建同等重要。

**Independent Test**: 可以通过调用列表查询 API 并验证返回的分页数据来独立测试。

**Acceptance Scenarios**:

1. **Given** 系统中存在多个模板, **When** 用户查询模板列表, **Then** 系统返回分页的模板列表，包含名称、用途、当前版本号、创建时间
2. **Given** 系统中存在多个不同用途的模板, **When** 用户按用途筛选模板, **Then** 系统只返回指定用途的模板
3. **Given** 系统中存在模板, **When** 用户按名称关键字搜索, **Then** 系统返回名称包含关键字的模板

---

### User Story 3 - 查看模板详情及版本历史 (Priority: P2)

作为运维人员，我需要查看某个模板的详细信息和所有历史版本，以便了解模板的演变过程和回溯到特定版本。

**Why this priority**: 版本历史是版本控制功能的核心体现，但依赖于模板的创建和更新。

**Independent Test**: 可以通过查询单个模板详情 API 并验证返回的版本历史列表来独立测试。

**Acceptance Scenarios**:

1. **Given** 模板已存在且有多个版本, **When** 用户查看模板详情, **Then** 系统返回当前版本内容及所有历史版本列表
2. **Given** 模板存在版本 1、2、3, **When** 用户查看版本 2 的内容, **Then** 系统返回版本 2 的完整内容
3. **Given** 模板 ID 不存在, **When** 用户查询详情, **Then** 系统返回"模板不存在"错误

---

### User Story 4 - 更新提示词模板（生成新版本）(Priority: P2)

作为运维人员，我需要更新已有模板的内容，系统自动生成新版本，以便保留历史记录的同时使用最新内容。

**Why this priority**: 更新功能与版本控制紧密结合，是核心业务功能。

**Independent Test**: 可以通过更新 API 调用并验证版本号自动递增来独立测试。

**Acceptance Scenarios**:

1. **Given** 模板当前版本为 3, **When** 用户更新模板内容, **Then** 系统创建版本 4 并将其设为当前版本
2. **Given** 模板存在, **When** 用户仅更新描述不更新内容, **Then** 系统仍生成新版本记录变更
3. **Given** 更新后的内容与当前版本完全相同, **When** 用户提交更新, **Then** 系统拒绝并提示"内容无变化，无需更新"

---

### User Story 5 - 回滚到历史版本 (Priority: P3)

作为运维人员，我需要将模板回滚到某个历史版本，以便在新版本出现问题时快速恢复。

**Why this priority**: 回滚是版本控制的高级功能，优先级较低但对运维很重要。

**Independent Test**: 可以通过回滚 API 调用并验证当前版本切换来独立测试。

**Acceptance Scenarios**:

1. **Given** 模板有版本 1、2、3（当前为 3）, **When** 用户回滚到版本 1, **Then** 系统创建版本 4，内容与版本 1 相同
2. **Given** 模板仅有版本 1, **When** 用户尝试回滚, **Then** 系统提示"已是最早版本，无法回滚"

---

### User Story 6 - 删除提示词模板 (Priority: P3)

作为运维人员，我需要删除不再使用的模板，以便保持模板库的整洁。

**Why this priority**: 删除是低频操作。

**Independent Test**: 可以通过删除 API 调用并验证模板被标记为删除来独立测试。

**Acceptance Scenarios**:

1. **Given** 模板存在, **When** 用户删除模板, **Then** 系统软删除模板及其所有版本历史
2. **Given** 模板不存在, **When** 用户尝试删除, **Then** 系统返回"模板不存在"错误

---

### Edge Cases

- 并发更新同一模板时如何处理？采用乐观锁机制，后提交者收到"版本冲突，请刷新后重试"错误
- 版本号达到上限（如 Integer 最大值）时如何处理？实际场景中不会达到上限，使用 Long 类型存储版本号
- 模板内容非常大时如何处理？限制模板内容最大长度为 64KB

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: 系统必须支持创建提示词模板，包含名称、内容、用途、描述字段
- **FR-002**: 系统必须为每个模板的名称保持唯一性约束
- **FR-003**: 系统必须支持按用途、名称关键字筛选和分页查询模板列表
- **FR-004**: 系统必须在每次更新模板时自动生成新版本，版本号递增
- **FR-005**: 系统必须保留模板的所有历史版本内容，支持查看任意历史版本
- **FR-006**: 系统必须支持将模板回滚到任意历史版本（通过创建新版本实现）
- **FR-007**: 系统必须支持软删除模板，删除后模板及其版本历史不再可查询
- **FR-008**: 系统必须限制模板内容最大长度为 64KB
- **FR-009**: 系统必须记录每个版本的创建时间和操作人
- **FR-010**: 系统必须拒绝内容完全相同的连续版本更新

### Key Entities

- **PromptTemplate（提示词模板）**: 模板的基本信息，包含 ID、名称、用途、描述、当前版本号、创建时间、更新时间、删除标记
- **PromptTemplateVersion（模板版本）**: 模板的版本记录，包含 ID、模板 ID、版本号、内容、变更说明、创建时间、创建人
- **TemplateUsage（模板用途）**: 独立实体，支持用户自定义。系统预置：故障诊断、知识问答、代码生成、运维建议；用户可添加新类型

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 用户可以在 30 秒内完成一个新模板的创建
- **SC-002**: 模板列表查询响应时间不超过 1 秒（1000 条记录以内）
- **SC-003**: 系统支持为单个模板保存至少 1000 个历史版本
- **SC-004**: 版本回滚操作可在 5 秒内完成
- **SC-005**: 所有 CRUD 操作均有完整的操作日志可追溯

## Clarifications

### Session 2025-12-26

- Q: 模板用途枚举范围？ → A: 自定义，用户可自行添加新的用途类型
- Q: 模板引用检查范围？ → A: 不检查引用，直接允许删除，调用方自行处理

## Assumptions

- 系统假设模板名称在整个系统中唯一，不区分用途
- 版本号使用递增整数，从 1 开始
- 删除采用软删除方式，物理删除需要单独的清理任务
- 模板用途支持用户自定义，系统预置常用类型（故障诊断、知识问答、代码生成、运维建议），用户可添加新类型
- 当前版本指向最新创建的版本，回滚实际上是创建一个内容相同的新版本
